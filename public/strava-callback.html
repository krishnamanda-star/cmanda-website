<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Strava Callback</title></head>
<body><div id="msg">Loading...</div>
<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  var code = params.get('code');
  var clientId = localStorage.getItem('chainwax_client_id') || '';
  var clientSecret = localStorage.getItem('chainwax_client_secret') || '';
  document.getElementById('msg').textContent = 'code=' + (code ? code.substr(0,10) : 'NONE') + ' clientId=' + (clientId || 'MISSING');

  if (!code || !clientId) { document.getElementById('msg').textContent += ' â€” MISSING DATA'; return; }

  fetch('/api/strava', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'token', code: code, client_id: clientId, client_secret: clientSecret, grant_type: 'authorization_code' })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    document.getElementById('msg').textContent = JSON.stringify(data).substr(0, 300);
    if (data.access_token) {
      localStorage.setItem('chainwax_strava', JSON.stringify({ accessToken: data.access_token, refreshToken: data.refresh_token, expiresAt: data.expires_at, athlete: data.athlete }));
      var returnTo = localStorage.getItem('strava_return_to') || '/chain-wax.html';
      localStorage.removeItem('strava_return_to');
      setTimeout(function() { window.location.href = returnTo; }, 1500);
    }
  })
  .catch(function(e) { document.getElementById('msg').textContent = 'ERROR: ' + e.message; });
})();
</script></body></html>
