<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chain Wax Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0b; --bg2: #111113; --card: #16161a;
      --border: #252530; --border-light: #32323e;
      --accent: #f0a030; --accent-dim: #c88020; --accent-glow: rgba(240,160,48,0.12);
      --danger: #f04848; --danger-glow: rgba(240,72,72,0.12);
      --success: #30d870; --success-glow: rgba(48,216,112,0.12);
      --text: #eaeaef; --text-dim: #7a7a8a; --text-muted: #4a4a58;
      --strava: #fc4c02;
      --font-display: 'Sora', sans-serif; --font-mono: 'DM Mono', monospace;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { min-height: 100vh; background: var(--bg); color: var(--text); font-family: var(--font-display); -webkit-font-smoothing: antialiased; }
    body::before {
      content: ''; position: fixed; inset: 0; opacity: 0.025; pointer-events: none; z-index: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    }
    .app { position: relative; z-index: 1; max-width: 640px; margin: 0 auto; padding: 0 20px 60px; }
    .header { padding: 28px 0 24px; display: flex; align-items: flex-end; justify-content: space-between; border-bottom: 1px solid var(--border); margin-bottom: 32px; }
    .header-left { display: flex; align-items: center; gap: 14px; }
    .logo { width: 44px; height: 44px; background: linear-gradient(135deg, var(--accent), var(--accent-dim)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 4px 20px var(--accent-glow); }
    .header h1 { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; background: linear-gradient(135deg, var(--text), var(--text-dim)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header .subtitle { font-family: var(--font-mono); font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .badge { font-family: var(--font-mono); font-size: 11px; padding: 4px 10px; border-radius: 20px; letter-spacing: 0.3px; white-space: nowrap; }
    .badge-on { background: var(--success-glow); color: var(--success); border: 1px solid rgba(48,216,112,0.2); }
    .badge-off { background: rgba(122,122,138,0.1); color: var(--text-muted); border: 1px solid var(--border); }
    .nav { display: flex; gap: 4px; margin-bottom: 28px; background: var(--bg2); border-radius: 10px; padding: 4px; border: 1px solid var(--border); }
    .nav button { flex: 1; padding: 9px 10px; border: none; border-radius: 8px; font-family: var(--font-mono); font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.25s; background: transparent; color: var(--text-muted); }
    .nav button.active { background: var(--card); color: var(--accent); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .nav button:hover:not(.active) { color: var(--text-dim); }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 28px; margin-bottom: 20px; }
    .card-title { font-family: var(--font-mono); font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); margin-bottom: 20px; }
    .gauge-wrap { display: flex; flex-direction: column; align-items: center; padding: 12px 0 20px; position: relative; }
    .gauge-svg { transform: rotate(-90deg); }
    .gauge-bg { fill: none; stroke: var(--border); }
    .gauge-fg { fill: none; stroke-linecap: round; transition: stroke-dashoffset 1.2s cubic-bezier(0.4,0,0.2,1), stroke 0.5s ease; }
    .gauge-center { position: absolute; text-align: center; top: 50%; left: 50%; transform: translate(-50%,-50%); font-family: var(--font-mono); }
    .gauge-val { font-size: 36px; font-weight: 500; line-height: 1; }
    .gauge-lbl { font-size: 11px; color: var(--text-muted); margin-top: 6px; letter-spacing: 1px; text-transform: uppercase; }
    .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: var(--border); border-radius: 10px; overflow: hidden; margin-top: 24px; }
    .stat { background: var(--card); padding: 16px; text-align: center; }
    .stat-l { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .stat-v { font-family: var(--font-mono); font-size: 15px; font-weight: 500; }
    .alert { margin-top: 20px; padding: 14px 20px; border-radius: 10px; font-family: var(--font-mono); font-size: 13px; font-weight: 500; text-align: center; }
    .alert-danger { background: var(--danger-glow); border: 1px solid rgba(240,72,72,0.25); color: var(--danger); animation: pulse 2s infinite; }
    .alert-success { background: var(--success-glow); border: 1px solid rgba(48,216,112,0.2); color: var(--success); }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.8} }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-family: var(--font-mono); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-strava { background: var(--strava); color: #fff; }
    .btn-strava:hover:not(:disabled) { background: #e04400; }
    .btn-accent { background: var(--accent); color: var(--bg); }
    .btn-accent:hover:not(:disabled) { background: var(--accent-dim); }
    .btn-secondary { background: var(--bg2); color: var(--text-dim); border: 1px solid var(--border); }
    .btn-secondary:hover:not(:disabled) { border-color: var(--border-light); color: var(--text); }
    .btn-danger { background: transparent; color: var(--danger); border: 1px solid rgba(240,72,72,0.3); }
    .btn-danger:hover:not(:disabled) { background: var(--danger-glow); }
    .rlog { border-radius: 12px; overflow: hidden; border: 1px solid var(--border); background: var(--card); }
    .rlog-hdr { padding: 14px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .rlog-hdr span { font-family: var(--font-mono); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
    .rlog-hdr .cnt { color: var(--text-muted); }
    .rrow { display: grid; grid-template-columns: 1fr 80px 70px 32px; align-items: center; padding: 11px 16px; gap: 8px; font-family: var(--font-mono); font-size: 12px; border-bottom: 1px solid rgba(37,37,48,0.5); transition: background 0.15s; }
    .rrow:hover { background: var(--bg2); }
    .rrow:last-child { border-bottom: none; }
    .rname { color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .rdate { color: var(--text-muted); font-size: 10px; margin-top: 2px; }
    .rdist { color: var(--accent); text-align: right; font-weight: 500; }
    .rsrc { color: var(--text-muted); text-align: right; font-size: 10px; }
    .rdel { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; padding: 2px 4px; border-radius: 4px; transition: all 0.15s; text-align: center; }
    .rdel:hover { color: var(--danger); background: var(--danger-glow); }
    .rempty { padding: 40px 20px; text-align: center; color: var(--text-muted); font-family: var(--font-mono); font-size: 12px; }
    .rlist { max-height: 400px; overflow-y: auto; }
    .fg { margin-bottom: 18px; }
    .fl { display: block; font-family: var(--font-mono); font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px; }
    .fi { width: 100%; padding: 10px 14px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: var(--font-mono); font-size: 13px; outline: none; transition: border-color 0.2s; }
    .fi:focus { border-color: var(--accent); }
    .frow { display: flex; gap: 12px; }
    .frow > .fg { flex: 1; }
    .fsuf { display: flex; align-items: center; gap: 8px; }
    .fsuf .fi { flex: 1; }
    .fsuf span { color: var(--text-muted); font-family: var(--font-mono); font-size: 12px; }
    .fhint { margin-top: 20px; padding: 14px 18px; border-radius: 10px; background: var(--accent-glow); border: 1px solid rgba(240,160,48,0.15); font-size: 12px; color: var(--text-dim); line-height: 1.6; }
    .fhint strong { color: var(--accent); }
    .hero { text-align: center; padding: 40px 20px; }
    .hero .icon { font-size: 48px; margin-bottom: 16px; }
    .hero h2 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .hero p { color: var(--text-dim); font-size: 13px; margin-bottom: 24px; line-height: 1.6; }
    .estimate { margin-top: 16px; font-family: var(--font-mono); font-size: 12px; color: var(--text-muted); text-align: center; }
    .toast { position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 12px 20px; border-radius: 8px; font-family: var(--font-mono); font-size: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); animation: slideIn 0.3s ease; }
    .toast-ok { background: var(--success); color: #fff; }
    .toast-err { background: var(--danger); color: #fff; }
    .toast-info { background: var(--accent); color: var(--bg); }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .hidden { display: none !important; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(8px) } to { opacity:1; transform:translateY(0) } }
    .view { animation: fadeIn 0.35s ease; }
    @media (max-width: 480px) {
      .header { flex-direction: column; align-items: flex-start; gap: 12px; }
      .stats { grid-template-columns: 1fr; }
      .btn-row { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
      .frow { flex-direction: column; gap: 0; }
    }
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>
<div class="app">

  <div class="header">
    <div class="header-left">
      <div class="logo">â›“</div>
      <div>
        <h1>Chain Wax Tracker</h1>
        <div class="subtitle">Track your chain wax life</div>
      </div>
    </div>
    <div class="badge badge-off" id="badge">â—‹ not connected</div>
  </div>

  <div class="nav">
    <button class="active" onclick="go('dashboard')">Dashboard</button>
    <button onclick="go('rides')">Rides</button>
    <button onclick="go('strava')">Strava</button>
    <button onclick="go('settings')">Settings</button>
  </div>

  <!-- DASHBOARD -->
  <div id="v-dashboard" class="view">
    <div id="emptyState" class="card hidden">
      <div class="hero">
        <div class="icon">ðŸ”§</div>
        <h2>Set Up Your Chain Wax Cycle</h2>
        <p>Go to Settings to set your wax date and target distance, then connect Strava.</p>
        <button class="btn btn-accent" onclick="go('settings')">Go to Settings</button>
      </div>
    </div>
    <div id="mainDash" class="hidden">
      <div class="card">
        <div class="gauge-wrap">
          <svg class="gauge-svg" width="200" height="200">
            <circle class="gauge-bg" cx="100" cy="100" r="88" stroke-width="9"/>
            <circle class="gauge-fg" id="gFg" cx="100" cy="100" r="88" stroke-width="9" stroke-dasharray="553" stroke-dashoffset="553"/>
          </svg>
          <div class="gauge-center">
            <div class="gauge-val" id="gVal">â€”</div>
            <div class="gauge-lbl">km remaining</div>
          </div>
        </div>
        <div id="alertWax" class="alert alert-danger hidden">âš  TIME TO RE-WAX YOUR CHAIN</div>
        <div class="stats">
          <div class="stat"><div class="stat-l">Waxed</div><div class="stat-v" id="sWax">â€”</div></div>
          <div class="stat"><div class="stat-l">Ridden</div><div class="stat-v" id="sRid">â€”</div></div>
          <div class="stat"><div class="stat-l">Target</div><div class="stat-v" id="sTgt">â€”</div></div>
        </div>
        <div class="estimate hidden" id="estPill"></div>
      </div>
      <div class="btn-row">
        <button class="btn btn-strava hidden" id="bSync" onclick="syncStrava()">â†» Sync Strava</button>
        <button class="btn btn-secondary" onclick="go('rides')">+ Add Ride</button>
        <button class="btn btn-danger" onclick="reWax()">ðŸ”— Re-Wax Chain</button>
      </div>
    </div>
  </div>

  <!-- RIDES -->
  <div id="v-rides" class="view hidden">
    <div class="card">
      <div class="card-title">Add Manual Ride</div>
      <div class="fg">
        <label class="fl">Ride Name</label>
        <input class="fi" type="text" id="rName" placeholder="Morning ride">
      </div>
      <div class="frow">
        <div class="fg">
          <label class="fl">Distance</label>
          <div class="fsuf"><input class="fi" type="number" id="rDist" placeholder="0" min="0" step="0.1"><span>km</span></div>
        </div>
        <div class="fg">
          <label class="fl">Date</label>
          <input class="fi" type="date" id="rDateIn">
        </div>
      </div>
      <button class="btn btn-accent" onclick="addRide()">Save Ride</button>
    </div>
    <div class="rlog">
      <div class="rlog-hdr"><span>Ride Log</span><span class="cnt" id="rCnt">0 rides</span></div>
      <div class="rlist" id="rList"><div class="rempty">No rides yet</div></div>
    </div>
  </div>

  <!-- STRAVA -->
  <div id="v-strava" class="view hidden">
    <div id="strOff" class="card">
      <div class="hero">
        <div class="icon">ðŸš´</div>
        <h2>Connect Strava</h2>
        <p>Link your Strava account to automatically pull cycling activities. Click below to authorize â€” your rides since the last wax will be synced.</p>
        <button class="btn btn-strava" onclick="connectStrava()">Connect with Strava</button>
      </div>
    </div>
    <div id="strOn" class="card hidden">
      <div class="card-title">Strava Connection</div>
      <div class="alert alert-success" style="margin-top:0;margin-bottom:20px;">
        âœ“ Connected as <strong id="strName">â€”</strong>
      </div>
      <div class="btn-row">
        <button class="btn btn-strava" onclick="syncStrava()">â†» Sync Rides Now</button>
        <button class="btn btn-danger" onclick="disconnectStrava()">Disconnect</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="v-settings" class="view hidden">
    <div class="card">
      <div class="card-title">Wax Settings</div>
      <div class="fg">
        <label class="fl">Last Wax Date</label>
        <input class="fi" type="date" id="cfgDate" onchange="saveCfg()">
      </div>
      <div class="fg">
        <label class="fl">Target Distance Per Wax</label>
        <div class="fsuf"><input class="fi" type="number" id="cfgKm" min="50" step="50" onchange="saveCfg()"><span>km</span></div>
      </div>
      <div class="fhint">
        <strong>Tip:</strong> Most chain wax treatments last 200â€“500 km depending on conditions. Dry = longer. Wet/muddy = re-wax sooner.
      </div>
    </div>
    <div class="card">
      <div class="card-title">Data</div>
      <button class="btn btn-danger" onclick="resetAll()">Reset All Data</button>
    </div>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  *** ENTER YOUR STRAVA CREDENTIALS HERE ***
//
//  Get these from: https://www.strava.com/settings/api
//  Set "Authorization Callback Domain" to: cmanda-website.vercel.app
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STRAVA_CLIENT_ID     = "202550";
const STRAVA_CLIENT_SECRET = "28a52c20e5aa595af90ed7477e8cd1443f00de5a";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const BASE = window.location.origin;
const CALLBACK = BASE + "/strava-callback.html";

let cfg = { waxDate: "", targetKm: 300 };
let rides = [];
let strava = null;

function load() {
  try {
    const c = localStorage.getItem("chainwax_config"); if (c) cfg = JSON.parse(c);
    const r = localStorage.getItem("chainwax_rides"); if (r) rides = JSON.parse(r);
    const s = localStorage.getItem("chainwax_strava"); if (s) strava = JSON.parse(s);
  } catch(e) { console.error(e); }
}

function saveCfg() {
  cfg.waxDate = document.getElementById("cfgDate").value;
  cfg.targetKm = parseInt(document.getElementById("cfgKm").value) || 300;
  localStorage.setItem("chainwax_config", JSON.stringify(cfg));
  render();
}
function saveRides() { localStorage.setItem("chainwax_rides", JSON.stringify(rides)); }
function saveStrava() {
  if (strava) localStorage.setItem("chainwax_strava", JSON.stringify(strava));
  else localStorage.removeItem("chainwax_strava");
}

const fmt = n => Math.round(n * 10) / 10;
const dateStr = d => new Date(d).toLocaleDateString("en-GB", { day:"numeric", month:"short", year:"numeric" });
const shortDate = d => new Date(d).toLocaleDateString("en-GB", { day:"2-digit", month:"2-digit" });
const esc = s => { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; };

function toast(msg, type) {
  const el = document.createElement("div");
  el.className = "toast toast-" + (type || "info");
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity = "0"; el.style.transition = "opacity 0.3s"; setTimeout(() => el.remove(), 300); }, 3000);
}

let currentView = "dashboard";
function go(name) {
  currentView = name;
  ["dashboard","rides","strava","settings"].forEach(v => {
    document.getElementById("v-" + v).classList.toggle("hidden", v !== name);
  });
  document.querySelectorAll(".nav button").forEach((btn, i) => {
    btn.classList.toggle("active", ["dashboard","rides","strava","settings"][i] === name);
  });
  if (name === "rides") document.getElementById("rDateIn").value = new Date().toISOString().split("T")[0];
}

// â”€â”€ STRAVA â”€â”€

function connectStrava() {
  // Store credentials so callback page can use them
  localStorage.setItem("chainwax_client_id", STRAVA_CLIENT_ID);
  localStorage.setItem("chainwax_client_secret", STRAVA_CLIENT_SECRET);

  const url = "https://www.strava.com/oauth/authorize?client_id=" + STRAVA_CLIENT_ID +
    "&response_type=code&redirect_uri=" + encodeURIComponent(CALLBACK) +
    "&approval_prompt=auto&scope=activity:read_all";
  window.location.href = url;
}

function disconnectStrava() {
  strava = null; saveStrava();
  toast("Strava disconnected", "info");
  render();
}

async function getToken() {
  if (!strava) return null;
  const now = Math.floor(Date.now() / 1000);
  if (now < strava.expiresAt - 60) return strava.accessToken;
  try {
    const resp = await fetch("https://www.strava.com/api/v3/oauth/token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        client_id: STRAVA_CLIENT_ID,
        client_secret: STRAVA_CLIENT_SECRET,
        refresh_token: strava.refreshToken,
        grant_type: "refresh_token",
      }),
    });
    const d = await resp.json();
    if (d.access_token) {
      strava.accessToken = d.access_token;
      strava.refreshToken = d.refresh_token;
      strava.expiresAt = d.expires_at;
      saveStrava();
      return d.access_token;
    }
  } catch(e) { console.error(e); }
  return null;
}

async function syncStrava() {
  if (!strava) { toast("Connect Strava first", "err"); return; }
  if (!cfg.waxDate) { toast("Set a wax date first", "err"); return; }
  const btn = document.getElementById("bSync");
  btn.disabled = true; btn.textContent = "â³ Syncing...";
  try {
    const token = await getToken();
    if (!token) throw new Error("Token expired. Reconnect Strava.");
    const after = Math.floor(new Date(cfg.waxDate).getTime() / 1000);
    let page = 1, all = [];
    while (true) {
      const r = await fetch("https://www.strava.com/api/v3/athlete/activities?after=" + after + "&per_page=100&page=" + page, {
        headers: { Authorization: "Bearer " + token }
      });
      if (!r.ok) throw new Error("HTTP " + r.status);
      const acts = await r.json();
      if (acts.length === 0) break;
      all = all.concat(acts); page++;
    }
    const bikeRides = all
      .filter(a => a.type === "Ride" || a.type === "VirtualRide" || a.type === "EBikeRide")
      .map(a => ({ id: "strava_" + a.id, name: a.name, distance: a.distance / 1000, date: a.start_date_local || a.start_date, source: "strava" }));
    const manual = rides.filter(r => r.source !== "strava");
    rides = [...manual, ...bikeRides].sort((a, b) => new Date(a.date) - new Date(b.date));
    saveRides();
    toast("Synced " + bikeRides.length + " ride" + (bikeRides.length !== 1 ? "s" : ""), "ok");
  } catch(e) { toast("Sync failed: " + e.message, "err"); }
  btn.disabled = false; btn.textContent = "â†» Sync Strava";
  render();
}

// â”€â”€ RIDES â”€â”€

function addRide() {
  const name = document.getElementById("rName").value.trim();
  const dist = parseFloat(document.getElementById("rDist").value);
  const date = document.getElementById("rDateIn").value;
  if (!name || !dist || !date) { toast("Fill all fields", "err"); return; }
  rides.push({ id: "m_" + Date.now(), name, distance: dist, date, source: "manual" });
  rides.sort((a, b) => new Date(a.date) - new Date(b.date));
  saveRides();
  document.getElementById("rName").value = "";
  document.getElementById("rDist").value = "";
  toast("Ride added", "ok");
  render();
}

function delRide(id) { rides = rides.filter(r => r.id !== id); saveRides(); render(); }

function reWax() {
  if (!confirm("Start a fresh wax cycle? This clears all tracked rides.")) return;
  cfg.waxDate = new Date().toISOString().split("T")[0];
  rides = [];
  localStorage.setItem("chainwax_config", JSON.stringify(cfg));
  saveRides();
  toast("Chain waxed! Fresh cycle started.", "ok");
  render();
}

function resetAll() {
  if (!confirm("Delete ALL data including Strava connection?")) return;
  ["chainwax_config","chainwax_rides","chainwax_strava","chainwax_client_id","chainwax_client_secret"].forEach(k => localStorage.removeItem(k));
  cfg = { waxDate: "", targetKm: 300 }; rides = []; strava = null;
  toast("All data cleared", "info");
  render();
}

// â”€â”€ RENDER â”€â”€

function render() {
  const conn = !!strava;
  const hasWax = !!cfg.waxDate;
  const badge = document.getElementById("badge");
  badge.className = "badge " + (conn ? "badge-on" : "badge-off");
  badge.textContent = conn ? "â— Strava" : "â—‹ not connected";
  document.getElementById("emptyState").classList.toggle("hidden", hasWax);
  document.getElementById("mainDash").classList.toggle("hidden", !hasWax);
  document.getElementById("bSync").classList.toggle("hidden", !conn);
  document.getElementById("strOff").classList.toggle("hidden", conn);
  document.getElementById("strOn").classList.toggle("hidden", !conn);
  if (conn && strava.athlete) {
    const a = strava.athlete;
    document.getElementById("strName").textContent = ((a.firstname || "") + " " + (a.lastname || "")).trim() || "Athlete";
  }
  document.getElementById("cfgDate").value = cfg.waxDate;
  document.getElementById("cfgKm").value = cfg.targetKm;

  const totalKm = rides.reduce((s, r) => s + r.distance, 0);
  const remaining = Math.max(0, cfg.targetKm - totalKm);
  const pct = cfg.targetKm > 0 ? Math.min((totalKm / cfg.targetKm) * 100, 100) : 0;
  const overdue = totalKm >= cfg.targetKm;
  const circ = 2 * Math.PI * 88;
  const off = circ - (pct / 100) * circ;
  const gFg = document.getElementById("gFg");
  const col = pct > 85 ? "var(--danger)" : pct > 60 ? "var(--accent)" : "var(--success)";
  gFg.style.strokeDashoffset = off;
  gFg.style.stroke = col;
  gFg.style.filter = "drop-shadow(0 0 8px " + col + ")";
  const gVal = document.getElementById("gVal");
  gVal.textContent = fmt(remaining);
  gVal.style.color = overdue ? "var(--danger)" : "var(--text)";
  document.getElementById("sWax").textContent = hasWax ? dateStr(cfg.waxDate) : "â€”";
  document.getElementById("sRid").textContent = fmt(totalKm) + " km";
  document.getElementById("sTgt").textContent = cfg.targetKm + " km";
  document.getElementById("alertWax").classList.toggle("hidden", !overdue);

  const est = document.getElementById("estPill");
  if (hasWax && rides.length > 0 && remaining > 0) {
    const days = Math.max(1, (Date.now() - new Date(cfg.waxDate).getTime()) / 86400000);
    const avg = totalKm / days;
    if (avg > 0) {
      const left = Math.ceil(remaining / avg);
      est.textContent = "â‰ˆ " + left + " day" + (left !== 1 ? "s" : "") + " until re-wax at current pace";
      est.classList.remove("hidden");
    } else est.classList.add("hidden");
  } else est.classList.add("hidden");

  document.getElementById("rCnt").textContent = rides.length + " ride" + (rides.length !== 1 ? "s" : "");
  const rl = document.getElementById("rList");
  if (rides.length === 0) {
    rl.innerHTML = '<div class="rempty">No rides yet. Sync Strava or add manually.</div>';
  } else {
    rl.innerHTML = [...rides].reverse().map(r =>
      '<div class="rrow"><div><div class="rname">' + esc(r.name) + '</div><div class="rdate">' + shortDate(r.date) + '</div></div>' +
      '<div class="rdist">' + fmt(r.distance) + ' km</div><div class="rsrc">' + (r.source === "strava" ? "Strava" : "Manual") + '</div>' +
      '<button class="rdel" onclick="delRide(\'' + r.id + '\')" title="Delete">Ã—</button></div>'
    ).join("");
  }
}

load();
render();
</script>
</body>
</html>
