<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chain Wax Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c26;
    --border: rgba(255,255,255,0.07);
    --border-bright: rgba(255,255,255,0.14);
    --text: #f0f0f5;
    --muted: #6b6b80;
    --accent: #e8ff57;
    --accent-dim: rgba(232,255,87,0.12);
    --red: #ff4d4d;
    --amber: #ffa733;
    --green: #3ddc84;
    --strava: #fc4c02;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  .screen { display: none; }
  .screen.active { display: block; }

  /* LOGIN */
  #login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
  #login-screen.active { display: flex; }

  .login-glow {
    position: fixed; inset: 0;
    background: radial-gradient(ellipse at 50% 50%, rgba(232,255,87,0.05) 0%, transparent 65%);
    pointer-events: none;
  }

  .login-card {
    position: relative; text-align: center;
    padding: 56px 48px; border: 1px solid var(--border-bright);
    border-radius: 24px; background: var(--surface);
    max-width: 400px; width: 90%;
    animation: fadeUp 0.5s ease;
  }

  .chain-icon { font-size: 44px; display: block; margin-bottom: 20px; }

  .login-title {
    font-family: 'Syne', sans-serif; font-size: 26px;
    font-weight: 800; letter-spacing: -0.03em; margin-bottom: 8px;
  }
  .login-sub { color: var(--muted); font-size: 14px; line-height: 1.6; margin-bottom: 36px; }

  .strava-btn {
    display: inline-flex; align-items: center; gap: 10px;
    background: var(--strava); color: #fff; border: none; border-radius: 12px;
    padding: 13px 26px; font-family: 'Syne', sans-serif; font-size: 15px;
    font-weight: 700; cursor: pointer; text-decoration: none;
    box-shadow: 0 0 32px rgba(252,76,2,0.25);
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .strava-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 40px rgba(252,76,2,0.45); }
  .strava-btn svg { width: 18px; height: 18px; fill: white; }

  /* HEADER */
  .header {
    position: sticky; top: 0; z-index: 100;
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 32px;
    background: rgba(10,10,15,0.88); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
  }
  .header-brand {
    font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 800;
    letter-spacing: -0.01em; display: flex; align-items: center; gap: 8px;
  }
  .brand-dot { width: 7px; height: 7px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 8px var(--accent); }
  .header-right { display: flex; align-items: center; gap: 10px; }
  .athlete-pill {
    display: flex; align-items: center; gap: 7px; padding: 5px 12px;
    border: 1px solid var(--border); border-radius: 99px; font-size: 13px; color: var(--muted);
  }
  .athlete-pill img { width: 22px; height: 22px; border-radius: 50%; object-fit: cover; }
  .hdr-btn {
    padding: 6px 13px; border-radius: 8px; border: 1px solid var(--border);
    background: transparent; color: var(--muted); font-size: 13px; cursor: pointer;
    font-family: 'DM Sans', sans-serif; transition: all 0.15s;
  }
  .hdr-btn:hover { border-color: var(--border-bright); color: var(--text); }
  .hdr-btn.sync:hover { border-color: var(--accent); color: var(--accent); }
  .hdr-btn.logout:hover { border-color: var(--red); color: var(--red); }

  /* MAIN */
  .main { max-width: 1060px; margin: 0 auto; padding: 40px 32px; }

  .page-title {
    font-family: 'Syne', sans-serif; font-size: 34px;
    font-weight: 800; letter-spacing: -0.03em; margin-bottom: 4px;
  }
  .page-sub { color: var(--muted); font-size: 13px; margin-bottom: 36px; }

  /* ERROR */
  .error-banner {
    background: rgba(255,77,77,0.1); border: 1px solid rgba(255,77,77,0.2);
    border-radius: 12px; padding: 14px 18px; color: var(--red);
    font-size: 13px; margin-bottom: 24px; display: none;
  }
  .error-banner.show { display: block; }

  /* SUMMARY */
  .summary-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; margin-bottom: 36px; }

  .summary-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; padding: 18px 22px;
    animation: fadeUp 0.5s ease both;
  }
  .summary-card:nth-child(2) { animation-delay: .06s; }
  .summary-card:nth-child(3) { animation-delay: .12s; }
  .summary-card.alert { border-color: rgba(255,167,51,0.3); background: rgba(255,167,51,0.04); }

  .s-label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
  .s-value { font-family: 'Syne', sans-serif; font-size: 30px; font-weight: 800; letter-spacing: -0.03em; }
  .summary-card.alert .s-value { color: var(--amber); }

  /* BIKES GRID */
  .bikes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(440px,1fr)); gap: 18px; }

  /* BIKE CARD */
  .bike-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 26px;
    animation: fadeUp 0.5s ease both;
    transition: border-color 0.2s, box-shadow 0.2s;
    position: relative; overflow: hidden;
  }
  .bike-card::after {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: var(--accent); transform: scaleX(0); transform-origin: left;
    transition: transform 0.3s ease;
  }
  .bike-card:hover { border-color: var(--border-bright); }
  .bike-card:hover::after { transform: scaleX(1); }
  .bike-card.needs-wax { border-color: rgba(255,167,51,0.25); }
  .bike-card.wax-now { border-color: rgba(255,77,77,0.3); }
  .bike-card.wax-now::after { background: var(--red); transform: scaleX(1); }

  .bike-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 18px; }
  .bike-name-wrap { display: flex; align-items: center; gap: 9px; }
  .bike-emoji { font-size: 20px; }
  .bike-name { font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 700; letter-spacing: -0.01em; }
  .bike-primary {
    font-size: 9px; font-family: 'DM Mono', monospace; letter-spacing: 0.08em;
    background: var(--accent-dim); color: var(--accent);
    padding: 2px 7px; border-radius: 99px;
  }
  .bike-brand { font-size: 12px; color: var(--muted); margin-top: 3px; font-family: 'DM Mono', monospace; }
  .bike-km-block { text-align: right; }
  .bike-km-val { font-family: 'DM Mono', monospace; font-size: 24px; font-weight: 500; letter-spacing: -0.02em; }
  .bike-km-unit { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }

  /* WAX INFO */
  .wax-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 16px; }
  .wax-cell { background: var(--surface2); border-radius: 10px; padding: 10px 12px; }
  .wax-cell-lbl { font-size: 10px; font-family: 'DM Mono', monospace; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); margin-bottom: 4px; }
  .wax-cell-val { font-size: 13px; font-weight: 600; }

  /* HEALTH BAR */
  .health-wrap { margin-bottom: 18px; }
  .health-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
  .health-lbl { font-family: 'DM Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
  .health-status { font-family: 'DM Mono', monospace; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; }
  .health-track { height: 5px; background: var(--surface2); border-radius: 99px; overflow: hidden; margin-bottom: 5px; }
  .health-fill { height: 100%; border-radius: 99px; transition: width 0.8s cubic-bezier(0.34,1.56,0.64,1); }
  .health-detail { font-size: 11px; color: var(--muted); font-family: 'DM Mono', monospace; }

  /* ACTIONS */
  .bike-actions { display: flex; gap: 8px; }
  .btn-waxed {
    flex: 1; padding: 10px; border-radius: 10px; border: none;
    background: var(--accent); color: #0a0a0f;
    font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700;
    cursor: pointer; letter-spacing: 0.02em;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .btn-waxed:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(232,255,87,0.28); }
  .btn-cfg {
    padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border);
    background: transparent; color: var(--muted); font-size: 13px; cursor: pointer;
    font-family: 'DM Sans', sans-serif; transition: all 0.15s;
  }
  .btn-cfg:hover { border-color: var(--border-bright); color: var(--text); }

  /* SETTINGS PANEL */
  .settings-panel {
    display: none; margin-top: 14px; padding: 18px;
    background: var(--surface2); border-radius: 14px; border: 1px solid var(--border);
    animation: fadeUp 0.2s ease;
  }
  .settings-panel.open { display: block; }
  .sp-title { font-family: 'DM Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 14px; }

  .form-row { margin-bottom: 12px; }
  .form-row label { display: block; font-size: 10px; font-family: 'DM Mono', monospace; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); margin-bottom: 5px; }
  .form-row input, .form-row select {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); padding: 8px 11px;
    font-size: 13px; font-family: 'DM Sans', sans-serif; outline: none;
    transition: border-color 0.15s;
  }
  .form-row input:focus, .form-row select:focus { border-color: rgba(232,255,87,0.4); }
  .form-row select option { background: #1c1c26; }
  .form-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  .sp-actions { display: flex; gap: 8px; margin-top: 14px; }
  .btn-save {
    flex: 1; padding: 9px; border-radius: 8px; border: none;
    background: var(--accent); color: #0a0a0f;
    font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer;
  }
  .btn-cancel {
    padding: 9px 14px; border-radius: 8px; border: 1px solid var(--border);
    background: transparent; color: var(--muted); font-size: 13px; cursor: pointer;
    font-family: 'DM Sans', sans-serif;
  }

  /* LOADING */
  .loading-state { display: flex; flex-direction: column; align-items: center; padding: 80px 0; gap: 14px; color: var(--muted); grid-column: 1/-1; }
  .spinner { width: 28px; height: 28px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }

  /* TOAST */
  .toast {
    position: fixed; bottom: 28px; right: 28px;
    background: var(--accent); color: #0a0a0f;
    padding: 11px 18px; border-radius: 10px;
    font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700;
    opacity: 0; transform: translateY(60px);
    transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
    pointer-events: none; z-index: 999;
  }
  .toast.show { opacity: 1; transform: translateY(0); }

  @keyframes fadeUp { from { opacity:0; transform:translateY(14px); } to { opacity:1; transform:none; } }
  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width: 680px) {
    .header { padding: 12px 16px; }
    .main { padding: 24px 16px; }
    .summary-row { grid-template-columns: 1fr 1fr; }
    .summary-row > :last-child { grid-column: span 2; }
    .bikes-grid { grid-template-columns: 1fr; }
    .form-2col { grid-template-columns: 1fr; }
    .wax-row { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<!-- â”€â”€ LOGIN â”€â”€ -->
<div id="login-screen" class="screen active">
  <div class="login-glow"></div>
  <div class="login-card">
    <span class="chain-icon">â›“</span>
    <h1 class="login-title">Chain Wax Tracker</h1>
    <p class="login-sub">Track wax life across all your bikes.<br>Km synced automatically from Strava.</p>
    <a id="strava-auth-link" href="#" class="strava-btn">
      <svg viewBox="0 0 24 24"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
      Connect with Strava
    </a>
  </div>
</div>

<!-- â”€â”€ APP â”€â”€ -->
<div id="app-screen" class="screen">
  <header class="header">
    <div class="header-brand">
      <div class="brand-dot"></div>
      Chain Wax Tracker
    </div>
    <div class="header-right">
      <div class="athlete-pill">
        <img id="athlete-avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="">
        <span id="athlete-name">Loadingâ€¦</span>
      </div>
      <button class="hdr-btn sync" onclick="syncNow()">â†» Sync</button>
      <button class="hdr-btn logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <main class="main">
    <div class="page-title">My Bikes</div>
    <div class="page-sub" id="sync-label">Connecting to Stravaâ€¦</div>
    <div class="error-banner" id="error-banner"></div>

    <div class="summary-row">
      <div class="summary-card"><div class="s-label">Total Bikes</div><div class="s-value" id="stat-bikes">â€”</div></div>
      <div class="summary-card"><div class="s-label">Total km (all bikes)</div><div class="s-value" id="stat-km">â€”</div></div>
      <div class="summary-card" id="stat-due-card"><div class="s-label">Chains Due / Soon</div><div class="s-value" id="stat-due">â€”</div></div>
    </div>

    <div class="bikes-grid" id="bikes-grid">
      <div class="loading-state"><div class="spinner"></div><div>Loading bikesâ€¦</div></div>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ CONFIG â€” fill these in â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// If you have a Next.js API route handling OAuth, set USE_API_ROUTE = true
// and the app will call /api/strava for auth and /api/strava/athlete for data.
// Otherwise fill in CLIENT_ID to do direct OAuth from the browser.
const USE_API_ROUTE = true;          // true = use your /api/strava/* routes
const CLIENT_ID     = '';            // only needed if USE_API_ROUTE = false
const REDIRECT_URI  = window.location.origin + window.location.pathname;

// â”€â”€â”€ WAX OPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WAX = [
  { id: 'squirt',   name: 'Squirt Lube',      km: 300 },
  { id: 'silca',    name: 'Silca Hot Melt',   km: 500 },
  { id: 'msw',      name: 'MSW Hot Melt',     km: 500 },
  { id: 'paraffin', name: 'Paraffin Wax',     km: 400 },
  { id: 'absolute', name: 'Absolute Black',   km: 350 },
  { id: 'custom',   name: 'Custom / Other',   km: 400 },
];

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tokenData = null;
let bikes     = [];
let settings  = {};
const S_KEY   = 'chainwax_v3';
const T_KEY   = 'strava_token_v3';

// â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  settings = JSON.parse(localStorage.getItem(S_KEY) || '{}');

  // OAuth callback
  const params = new URLSearchParams(window.location.search);
  const code   = params.get('code');
  if (code) {
    history.replaceState({}, '', location.pathname);
    await handleCode(code);
    return;
  }

  // Restore session
  const saved = JSON.parse(localStorage.getItem(T_KEY) || 'null');
  if (saved?.access_token) {
    tokenData = saved;
    showApp();
    await fetchAthlete();
  } else {
    showLogin();
  }
}

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLogin() {
  document.getElementById('login-screen').classList.add('active');
  document.getElementById('app-screen').classList.remove('active');

  const link = USE_API_ROUTE
    ? `/api/strava/auth`  // Your Next.js route redirects to Strava
    : `https://www.strava.com/oauth/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=read,activity:read`;

  document.getElementById('strava-auth-link').href = link;
}

function showApp() {
  document.getElementById('login-screen').classList.remove('active');
  document.getElementById('app-screen').classList.add('active');
}

async function handleCode(code) {
  try {
    // Exchange via your API route (keeps client_secret server-side)
    const res = await fetch(`/api/strava?code=${encodeURIComponent(code)}`);
    if (!res.ok) throw new Error('Token exchange failed â€” check /api/strava route');
    tokenData = await res.json();
    localStorage.setItem(T_KEY, JSON.stringify(tokenData));
    showApp();
    await fetchAthlete();
  } catch (e) {
    showError(e.message);
    showLogin();
  }
}

function logout() {
  localStorage.removeItem(T_KEY);
  tokenData = null; bikes = [];
  showLogin();
}

// â”€â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchAthlete() {
  setBikesLoading();
  try {
    let data;

    if (USE_API_ROUTE) {
      // Use your Next.js API route â€” it handles auth server-side
      const res = await fetch('/api/strava/athlete');
      if (!res.ok) {
        if (res.status === 401) { logout(); return; }
        throw new Error(`API error ${res.status}`);
      }
      data = await res.json();
    } else {
      // Direct Strava API call with browser token
      const res = await fetch('https://www.strava.com/api/v3/athlete', {
        headers: { Authorization: `Bearer ${tokenData.access_token}` }
      });
      if (res.status === 401) { logout(); return; }
      if (!res.ok) throw new Error(`Strava error ${res.status}`);
      data = await res.json();
    }

    // Athlete header
    const name = [data.firstname, data.lastname].filter(Boolean).join(' ');
    document.getElementById('athlete-name').textContent = name || 'Athlete';
    if (data.profile_medium) document.getElementById('athlete-avatar').src = data.profile_medium;

    // Map bikes â€” Strava athlete.bikes[]
    // Fields: id, name, nickname, distance (meters), primary, brand_name, model_name, frame_type
    bikes = (data.bikes || []).map(b => ({
      id:        b.id,
      name:      b.nickname || b.name || 'Unnamed Bike',
      brand:     b.brand_name || '',
      model:     b.model_name || '',
      totalKm:   Math.round((b.distance || 0) / 1000),
      frameType: b.frame_type, // 1=road 2=mtb 3=road 4=gravel 5=ebike
      primary:   !!b.primary,
    }));

    const now = new Date().toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit' });
    document.getElementById('sync-label').textContent =
      `Synced from Strava Â· ${now} Â· ${bikes.length} bike${bikes.length !== 1 ? 's' : ''}`;

    renderAll();
    clearError();
  } catch (e) {
    showError(e.message);
    setBikesEmpty();
  }
}

async function syncNow() {
  const btn = document.querySelector('.sync');
  btn.textContent = 'â†» Syncingâ€¦'; btn.disabled = true;
  await fetchAthlete();
  btn.textContent = 'â†» Sync'; btn.disabled = false;
  toast('Synced âœ“');
}

// â”€â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getS(id) {
  const wax = WAX[0];
  return settings[id] || { waxId: wax.id, intervalKm: wax.km, kmAtLastWax: null, lastWaxDate: null, notes: '' };
}
function saveS(id, s) {
  settings[id] = s;
  localStorage.setItem(S_KEY, JSON.stringify(settings));
}

// â”€â”€â”€ HEALTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function health(bike) {
  const s        = getS(bike.id);
  const interval = s.intervalKm || 300;
  const kmSince  = s.kmAtLastWax != null ? Math.max(0, bike.totalKm - s.kmAtLastWax) : 0;
  const pct      = Math.min((kmSince / interval) * 100, 100);
  const rem      = Math.max(0, interval - kmSince);
  return {
    pct, kmSince, rem, interval,
    status: pct >= 100 ? 'WAX NOW' : pct >= 85 ? 'DUE SOON' : 'GOOD',
    color:  pct >= 100 ? 'var(--red)' : pct >= 85 ? 'var(--amber)' : 'var(--green)',
  };
}

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function emoji(frameType) {
  if (frameType === 2) return 'ðŸšµ';
  if (frameType === 4 || frameType === 5) return 'ðŸª¨';
  return 'ðŸš´';
}

function renderAll() {
  renderSummary();
  renderBikes();
}

function renderSummary() {
  document.getElementById('stat-bikes').textContent = bikes.length;
  const totalKm = bikes.reduce((s, b) => s + b.totalKm, 0);
  document.getElementById('stat-km').textContent = totalKm.toLocaleString() + ' km';
  const due = bikes.filter(b => health(b).pct >= 85).length;
  document.getElementById('stat-due').textContent = due === 0 ? 'All good âœ“' : `${due} bike${due !== 1 ? 's' : ''}`;
  document.getElementById('stat-due-card').classList.toggle('alert', due > 0);
}

function renderBikes() {
  const grid = document.getElementById('bikes-grid');
  if (!bikes.length) { setBikesEmpty(); return; }

  grid.innerHTML = bikes.map((bike, i) => {
    const s   = getS(bike.id);
    const h   = health(bike);
    const wax = WAX.find(w => w.id === s.waxId) || WAX[0];
    const cls = h.pct >= 100 ? 'bike-card wax-now' : h.pct >= 85 ? 'bike-card needs-wax' : 'bike-card';
    const meta = [bike.brand, bike.model].filter(Boolean).join(' Â· ') || 'â€”';

    return `
    <div class="${cls}" style="animation-delay:${i * 0.07}s">
      <div class="bike-top">
        <div>
          <div class="bike-name-wrap">
            <span class="bike-emoji">${emoji(bike.frameType)}</span>
            <span class="bike-name">${esc(bike.name)}</span>
            ${bike.primary ? '<span class="bike-primary">PRIMARY</span>' : ''}
          </div>
          <div class="bike-brand">${esc(meta)}</div>
        </div>
        <div class="bike-km-block">
          <div class="bike-km-val">${bike.totalKm.toLocaleString()}</div>
          <div class="bike-km-unit">total km</div>
        </div>
      </div>

      <div class="wax-row">
        <div class="wax-cell">
          <div class="wax-cell-lbl">Wax</div>
          <div class="wax-cell-val">${esc(wax.name)}</div>
        </div>
        <div class="wax-cell">
          <div class="wax-cell-lbl">Interval</div>
          <div class="wax-cell-val">${s.intervalKm || wax.km} km</div>
        </div>
        <div class="wax-cell">
          <div class="wax-cell-lbl">Last Waxed</div>
          <div class="wax-cell-val">${s.lastWaxDate || 'â€”'}</div>
        </div>
      </div>

      <div class="health-wrap">
        <div class="health-top">
          <span class="health-lbl">Chain Health</span>
          <span class="health-status" style="color:${h.color}">${h.status} Â· ${Math.round(h.pct)}%</span>
        </div>
        <div class="health-track">
          <div class="health-fill" style="width:${h.pct}%;background:${h.color}"></div>
        </div>
        <div class="health-detail">${h.kmSince} km since wax Â· ${h.rem} km remaining</div>
      </div>

      <div class="bike-actions">
        <button class="btn-waxed" onclick="waxNow('${bike.id}')">âœ“ Waxed Today</button>
        <button class="btn-cfg" onclick="togglePanel('${bike.id}')">âš™ Settings</button>
      </div>

      <div class="settings-panel" id="sp-${bike.id}">
        <div class="sp-title">Chain Settings â€” ${esc(bike.name)}</div>
        <div class="form-row">
          <label>Wax Product</label>
          <select id="f-wax-${bike.id}" onchange="waxChanged('${bike.id}')">
            ${WAX.map(w => `<option value="${w.id}"${s.waxId === w.id ? ' selected' : ''}>${w.name} (default ${w.km} km)</option>`).join('')}
          </select>
        </div>
        <div class="form-2col">
          <div class="form-row">
            <label>Re-wax interval (km)</label>
            <input type="number" id="f-int-${bike.id}" value="${s.intervalKm || wax.km}" min="50" max="2000">
          </div>
          <div class="form-row">
            <label>Last wax date</label>
            <input type="date" id="f-date-${bike.id}" value="${s.lastWaxDate || ''}">
          </div>
        </div>
        <div class="form-row">
          <label>Km at last wax (Strava odometer when you waxed)</label>
          <input type="number" id="f-km-${bike.id}" value="${s.kmAtLastWax ?? ''}" placeholder="e.g. ${bike.totalKm}">
        </div>
        <div class="form-row">
          <label>Notes (chain model, prep methodâ€¦)</label>
          <input type="text" id="f-notes-${bike.id}" value="${esc(s.notes || '')}" placeholder="KMC X12, hot wax stripâ€¦">
        </div>
        <div class="sp-actions">
          <button class="btn-save" onclick="saveSettings('${bike.id}')">Save</button>
          <button class="btn-cancel" onclick="togglePanel('${bike.id}')">Cancel</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function setBikesLoading() {
  document.getElementById('bikes-grid').innerHTML =
    '<div class="loading-state"><div class="spinner"></div><div>Loading from Stravaâ€¦</div></div>';
}
function setBikesEmpty() {
  document.getElementById('bikes-grid').innerHTML =
    '<div class="loading-state"><div>No bikes found on your Strava account.</div></div>';
}

// â”€â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function waxNow(id) {
  const bike = bikes.find(b => b.id === id);
  if (!bike) return;
  const s = getS(id);
  saveS(id, { ...s, kmAtLastWax: bike.totalKm, lastWaxDate: today() });
  renderAll();
  toast(`âœ“ Waxed today â€” ${bike.name}`);
}

function togglePanel(id) {
  document.getElementById(`sp-${id}`)?.classList.toggle('open');
}

function waxChanged(id) {
  const waxId = document.getElementById(`f-wax-${id}`).value;
  const wax   = WAX.find(w => w.id === waxId);
  if (wax) document.getElementById(`f-int-${id}`).value = wax.km;
}

function saveSettings(id) {
  const waxId      = document.getElementById(`f-wax-${id}`).value;
  const intervalKm = parseInt(document.getElementById(`f-int-${id}`).value) || 300;
  const lastWaxDate= document.getElementById(`f-date-${id}`).value || null;
  const kmAtLastWax= parseFloat(document.getElementById(`f-km-${id}`).value) || null;
  const notes      = document.getElementById(`f-notes-${id}`).value || '';
  saveS(id, { waxId, intervalKm, lastWaxDate, kmAtLastWax, notes });
  renderAll();
  toast('Settings saved âœ“');
}

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { return String(s).replace(/[<>"'&]/g, c => ({'<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','&':'&amp;'}[c])); }
function today() { return new Date().toISOString().slice(0, 10); }

function showError(msg) {
  const el = document.getElementById('error-banner');
  el.textContent = 'âš  ' + msg;
  el.classList.add('show');
}
function clearError() { document.getElementById('error-banner').classList.remove('show'); }

let toastT;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(toastT);
  toastT = setTimeout(() => el.classList.remove('show'), 2600);
}

init();
</script>
</body>
</html>
