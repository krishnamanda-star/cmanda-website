<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Bike Maintenance</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0a0b; --bg2:#111113; --card:#16161a; --border:#252530; --border-l:#32323e;
  --accent:#f0a030; --accent-dim:#c88020; --accent-glow:rgba(240,160,48,0.12);
  --danger:#f04848; --danger-glow:rgba(240,72,72,0.12);
  --warn:#f5a623; --warn-glow:rgba(245,166,35,0.12);
  --success:#30d870; --success-glow:rgba(48,216,112,0.12);
  --text:#eaeaef; --text-dim:#7a7a8a; --text-muted:#4a4a58;
  --strava:#fc4c02;
  --good:#30d870; --warn-c:#f5a623; --danger-c:#f04848;
  --ff-display:'Sora',sans-serif; --ff-mono:'DM Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:16px}
body{min-height:100vh;background:var(--bg);color:var(--text);font-family:var(--ff-display);-webkit-font-smoothing:antialiased;overscroll-behavior:none}
.app{max-width:640px;margin:0 auto;padding:0 0 80px}
.header{padding:20px 20px 16px;background:var(--bg2);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;backdrop-filter:blur(10px)}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.header-left{display:flex;align-items:center;gap:12px}
.logo{width:38px;height:38px;background:linear-gradient(135deg,var(--accent),var(--accent-dim));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.app-title{font-size:17px;font-weight:700;letter-spacing:-0.3px}
.app-sub{font-family:var(--ff-mono);font-size:10px;color:var(--text-dim);margin-top:1px}
.header-actions{display:flex;align-items:center;gap:8px}
.badge-strava{font-family:var(--ff-mono);font-size:10px;padding:3px 8px;border-radius:20px;background:rgba(252,76,2,0.15);color:var(--strava);border:1px solid rgba(252,76,2,0.25)}
.btn-logout{background:none;border:1px solid var(--border-l);color:var(--text-dim);font-family:var(--ff-mono);font-size:10px;padding:4px 8px;border-radius:6px;cursor:pointer}
.btn-logout:hover{color:var(--danger);border-color:rgba(240,72,72,0.4)}
.bike-tabs{display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px}
.bike-tabs::-webkit-scrollbar{display:none}
.bike-tab{flex-shrink:0;padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-family:var(--ff-mono);font-size:11px;cursor:pointer;transition:all 0.2s;white-space:nowrap}
.bike-tab.active{background:var(--accent-glow);border-color:rgba(240,160,48,0.35);color:var(--accent);font-weight:500}
.bike-tab .bkm{font-size:10px;opacity:0.7;margin-left:4px}
.bike-total-bar{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
.bike-total-val{font-family:var(--ff-mono);font-size:13px;color:var(--accent);font-weight:500}
.last-sync{font-family:var(--ff-mono);font-size:10px;color:var(--text-muted)}
.sync-bar{padding:12px 20px;display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--border)}
.btn-sync{flex:1;padding:11px 16px;background:var(--strava);color:#fff;border:none;border-radius:10px;font-family:var(--ff-mono);font-size:12px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:background 0.2s}
.btn-sync:hover:not(:disabled){background:#e04400}
.btn-sync:disabled{opacity:0.5;cursor:not-allowed}
.category{padding:20px 20px 0}
.cat-label{font-family:var(--ff-mono);font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.cat-label::after{content:'';flex:1;height:1px;background:var(--border)}
.item-card{background:var(--card);border:1px solid var(--border);border-radius:14px;margin-bottom:10px;overflow:hidden;transition:border-color 0.2s}
.item-card:hover{border-color:var(--border-l)}
.item-card.status-warn{border-left:3px solid var(--warn-c)}
.item-card.status-danger{border-left:3px solid var(--danger-c);animation:pulseCard 3s infinite}
@keyframes pulseCard{0%,100%{box-shadow:none}50%{box-shadow:0 0 0 1px rgba(240,72,72,0.15)}}
.item-top{display:flex;align-items:flex-start;padding:14px 16px 10px;gap:12px}
.item-emoji{font-size:22px;line-height:1;flex-shrink:0;margin-top:1px}
.item-info{flex:1;min-width:0}
.item-name{font-size:14px;font-weight:600;letter-spacing:-0.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item-meta{font-family:var(--ff-mono);font-size:10px;color:var(--text-dim);margin-top:3px}
.item-status{flex-shrink:0;font-family:var(--ff-mono);font-size:9px;font-weight:600;padding:3px 8px;border-radius:10px;text-transform:uppercase;letter-spacing:0.5px;align-self:flex-start}
.status-good-badge{background:var(--success-glow);color:var(--good);border:1px solid rgba(48,216,112,0.2)}
.status-warn-badge{background:var(--warn-glow);color:var(--warn-c);border:1px solid rgba(245,166,35,0.2)}
.status-danger-badge{background:var(--danger-glow);color:var(--danger-c);border:1px solid rgba(240,72,72,0.2)}
.status-none-badge{background:rgba(255,255,255,0.04);color:var(--text-muted);border:1px solid var(--border)}
.item-bar-wrap{padding:0 16px 10px}
.item-bar-bg{height:5px;background:var(--border);border-radius:99px;overflow:hidden}
.item-bar-fill{height:100%;border-radius:99px;transition:width 0.8s cubic-bezier(0.4,0,0.2,1)}
.bar-good{background:var(--good)}
.bar-warn{background:var(--warn-c)}
.bar-danger{background:var(--danger-c)}
.item-bar-labels{display:flex;justify-content:space-between;margin-top:5px;font-family:var(--ff-mono);font-size:9px;color:var(--text-muted)}
.item-insight{padding:0 16px 10px;font-family:var(--ff-mono);font-size:10px;color:var(--text-dim);line-height:1.5}
.insight-good{color:var(--good)}
.insight-warn{color:var(--warn-c)}
.insight-danger{color:var(--danger-c)}
.item-actions{display:flex;padding:0 16px 14px;gap:8px;border-top:1px solid var(--border);padding-top:12px}
.btn-log{flex:1;padding:9px;background:var(--accent);color:var(--bg);border:none;border-radius:8px;font-family:var(--ff-mono);font-size:11px;font-weight:600;cursor:pointer;transition:background 0.2s}
.btn-log:hover{background:var(--accent-dim)}
.btn-history{padding:9px 16px;background:var(--bg);border:1px solid var(--border);color:var(--text-dim);border-radius:8px;font-family:var(--ff-mono);font-size:11px;cursor:pointer;transition:all 0.2s}
.btn-history:hover{border-color:var(--border-l);color:var(--text)}
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.login-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:40px 32px;max-width:380px;width:100%;text-align:center}
.login-icon{font-size:52px;margin-bottom:20px}
.login-title{font-size:22px;font-weight:700;margin-bottom:10px}
.login-desc{color:var(--text-dim);font-size:14px;line-height:1.6;margin-bottom:28px}
.btn-strava-big{width:100%;padding:14px;background:var(--strava);color:#fff;border:none;border-radius:12px;font-family:var(--ff-mono);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:background 0.2s}
.btn-strava-big:hover{background:#e04400}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;display:flex;align-items:flex-end;justify-content:center;animation:fadeOverlay 0.2s ease}
@keyframes fadeOverlay{from{opacity:0}to{opacity:1}}
.modal-sheet{background:var(--bg2);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:640px;padding:0 0 env(safe-area-inset-bottom,20px);animation:slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--border-l);border-radius:99px;margin:12px auto 0}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px}
.modal-title{font-size:16px;font-weight:700}
.modal-close{background:none;border:none;color:var(--text-muted);font-size:22px;cursor:pointer;line-height:1;padding:0 4px}
.modal-close:hover{color:var(--text)}
.modal-body{padding:0 20px 20px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-family:var(--ff-mono);font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:8px}
.form-input{width:100%;padding:11px 14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:var(--ff-mono);font-size:13px;outline:none;transition:border-color 0.2s}
.form-input:focus{border-color:var(--accent)}
.modal-summary{background:var(--card);border-radius:10px;padding:14px 16px;margin-bottom:16px}
.modal-summary .row{display:flex;justify-content:space-between;font-family:var(--ff-mono);font-size:12px;padding:3px 0}
.modal-summary .row .label{color:var(--text-dim)}
.modal-summary .row .val{color:var(--text);font-weight:500}
.modal-summary .row .val.accent{color:var(--accent)}
.btn-confirm{width:100%;padding:13px;background:var(--accent);color:var(--bg);border:none;border-radius:10px;font-family:var(--ff-mono);font-size:13px;font-weight:600;cursor:pointer;transition:background 0.2s;margin-top:4px}
.btn-confirm:hover:not(:disabled){background:var(--accent-dim)}
.btn-confirm:disabled{opacity:0.6;cursor:not-allowed}
.history-list{max-height:60vh;overflow-y:auto;padding-right:2px}
.history-item{padding:14px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start}
.history-item:last-child{border-bottom:none}
.history-date{font-family:var(--ff-mono);font-size:12px;font-weight:500;color:var(--text)}
.history-km{font-family:var(--ff-mono);font-size:11px;color:var(--accent);margin-top:3px}
.history-note{font-family:var(--ff-mono);font-size:10px;color:var(--text-dim);margin-top:2px;font-style:italic}
.history-tag{font-family:var(--ff-mono);font-size:9px;padding:2px 7px;border-radius:10px;background:var(--success-glow);color:var(--good);border:1px solid rgba(48,216,112,0.2)}
.history-ai-box{background:var(--accent-glow);border:1px solid rgba(240,160,48,0.15);border-radius:10px;padding:14px 16px;margin-bottom:16px;font-family:var(--ff-mono);font-size:11px;color:var(--text-dim);line-height:1.7}
.history-ai-box strong{color:var(--accent);display:block;margin-bottom:6px}
.history-empty{padding:28px 0;text-align:center;font-family:var(--ff-mono);font-size:11px;color:var(--text-muted)}
.toast{position:fixed;top:20px;right:20px;z-index:200;padding:11px 18px;border-radius:10px;font-family:var(--ff-mono);font-size:12px;box-shadow:0 8px 32px rgba(0,0,0,0.6);animation:slideIn 0.3s ease}
.toast-ok{background:var(--success);color:#fff}
.toast-err{background:var(--danger);color:#fff}
.toast-info{background:var(--accent);color:var(--bg)}
@keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
.loading-overlay{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:999;font-family:var(--ff-mono);color:var(--accent);font-size:13px}
.spinner{width:22px;height:22px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.hidden{display:none!important}
.spin-inline{display:inline-block;animation:spin 0.8s linear infinite;margin-right:6px}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingScreen"><div class="spinner"></div>Loading...</div>

<div id="loginScreen" class="hidden">
  <div class="login-wrap">
    <div class="login-card">
      <div class="login-icon">üö¥</div>
      <div class="login-title">Bike Maintenance</div>
      <div class="login-desc">Connect your Strava account to track maintenance for all your bikes. Service history, AI-powered intervals, and Strava-synced km tracking.</div>
      <button class="btn-strava-big" onclick="connectStrava()"><span style="font-size:18px">‚ö°</span> Connect with Strava</button>
    </div>
  </div>
</div>

<div id="mainApp" class="hidden">
  <div class="app">
    <div class="header">
      <div class="header-top">
        <div class="header-left">
          <div class="logo">üîß</div>
          <div>
            <div class="app-title">Bike Maintenance</div>
            <div class="app-sub" id="athleteName">Loading...</div>
          </div>
        </div>
        <div class="header-actions">
          <div class="badge-strava">‚óè Strava</div>
          <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
      </div>
      <div id="bikeTabsWrap">
        <div class="bike-tabs" id="bikeTabs"></div>
        <div class="bike-total-bar">
          <div class="bike-total-val" id="bikeTotalKm">‚Äî km total</div>
          <div class="last-sync" id="lastSyncLabel">Never synced</div>
        </div>
      </div>
    </div>
    <div class="sync-bar">
      <button class="btn-sync" id="btnSync" onclick="syncStrava()">‚Üª Sync Strava</button>
    </div>
    <div id="dashboard"></div>
  </div>
</div>

<!-- LOG SERVICE MODAL -->
<div class="modal-overlay hidden" id="logModal" onclick="closeModal(event,'logModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="logModalTitle">Log Service</div>
      <button class="modal-close" onclick="closeModalId('logModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="modal-summary" id="logSummary"></div>
      <div class="form-group">
        <label class="form-label">Service Date</label>
        <input class="form-input" type="date" id="logDate">
      </div>
      <div class="form-group">
        <label class="form-label">Notes (optional)</label>
        <input class="form-input" type="text" id="logNote" placeholder="e.g. Molten Speed Wax, CR2032 battery...">
      </div>
      <button class="btn-confirm" id="btnConfirmLog" onclick="confirmLogService()">‚úì Record Service</button>
    </div>
  </div>
</div>

<!-- HISTORY MODAL -->
<div class="modal-overlay hidden" id="historyModal" onclick="closeModal(event,'historyModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="historyModalTitle">Service History</div>
      <button class="modal-close" onclick="closeModalId('historyModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div id="historyAI" class="history-ai-box hidden"></div>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>
</div>

<script>
var STRAVA_CLIENT_ID     = "202550";
var STRAVA_CLIENT_SECRET = "28a52c20e5aa595af90ed7477e8cd1443f00de5a";
var CALLBACK             = window.location.origin + "/strava-callback.html";

var ITEMS = [
  { id:"chain_wax",       name:"Chain Wax",                  emoji:"‚õìÔ∏è", category:"Drivetrain",  intervalKm:400,   intervalDays:null },
  { id:"di2_charge",      name:"Di2 Battery Charge",         emoji:"‚ö°", category:"Drivetrain",  intervalKm:1200,  intervalDays:null },
  { id:"bearings_hubs",   name:"Wheel Hub Bearings",         emoji:"üî©", category:"Bearings",    intervalKm:15000, intervalDays:730  },
  { id:"bearings_bb",     name:"Bottom Bracket Bearings",    emoji:"üî©", category:"Bearings",    intervalKm:8000,  intervalDays:365  },
  { id:"bearings_headset",name:"Headset Bearings",           emoji:"üî©", category:"Bearings",    intervalKm:15000, intervalDays:730  },
  { id:"wahoo_cadence",   name:"Wahoo Cadence Battery",      emoji:"üîã", category:"Electronics", intervalKm:null,  intervalDays:365  },
  { id:"power_left",      name:"Left Crank Power Meter",     emoji:"üîã", category:"Electronics", intervalKm:null,  intervalDays:240  },
  { id:"power_right",     name:"Right Crank Power Meter",    emoji:"üîã", category:"Electronics", intervalKm:null,  intervalDays:240  },
  { id:"hrm",             name:"Heart Rate Monitor Battery", emoji:"‚ù§Ô∏è", category:"Electronics", intervalKm:null,  intervalDays:365  },
  { id:"brake_pads",      name:"Brake Pads",                 emoji:"üõë", category:"Wear Items",  intervalKm:3000,  intervalDays:null },
  { id:"tires",           name:"Tires",                      emoji:"üö≤", category:"Wear Items",  intervalKm:4000,  intervalDays:null },
  { id:"overhaul",        name:"Full Overhaul",              emoji:"üîß", category:"General",     intervalKm:12000, intervalDays:365  },
];

var CATEGORIES = ["Drivetrain","Bearings","Electronics","Wear Items","General"];

var athlete    = null;
var strava     = null;
var binId      = null;
var bikes      = [];
var activeBikeId = null;
var bikeData   = {};
var lastSyncTs = null;
var _logItemId = null;

function fmtDate(d){
  if(!d) return "‚Äî";
  return new Date(d+"T00:00:00").toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});
}
function fmtDateShort(d){
  if(!d) return "‚Äî";
  return new Date(d+"T00:00:00").toLocaleDateString("en-GB",{day:"numeric",month:"short"});
}
function todayStr(){ return new Date().toISOString().split("T")[0]; }
function daysSince(dateStr){
  if(!dateStr) return null;
  return Math.max(0, Math.round((Date.now() - new Date(dateStr+"T00:00:00").getTime())/86400000));
}
function esc(s){ var d=document.createElement("div"); d.textContent=s; return d.innerHTML; }
function toast(msg,type){
  var el=document.createElement("div"); el.className="toast toast-"+(type||"info");
  el.textContent=msg; document.body.appendChild(el);
  setTimeout(function(){ el.style.opacity="0"; el.style.transition="opacity 0.3s"; setTimeout(function(){ el.remove(); },300); },3000);
}

function getActiveBikeData(){
  if(!activeBikeId) return {};
  if(!bikeData[activeBikeId]) bikeData[activeBikeId]={items:{}};
  return bikeData[activeBikeId];
}
function getItemData(itemId){
  var d=getActiveBikeData();
  if(!d.items) d.items={};
  if(!d.items[itemId]) d.items[itemId]={lastDate:null,lastKmTotal:null,history:[]};
  return d.items[itemId];
}
function getActiveBikeTotalKm(){
  var b=bikes.find(function(x){ return x.id===activeBikeId; });
  return b ? (b.totalKm||0) : 0;
}
function getKmSinceService(itemId){
  var it=getItemData(itemId);
  if(!it.lastDate || it.lastKmTotal==null) return null;
  return Math.max(0, getActiveBikeTotalKm() - it.lastKmTotal);
}
function getDaysSinceService(itemId){
  var it=getItemData(itemId);
  if(!it.lastDate) return null;
  return daysSince(it.lastDate);
}
function getEffectiveIntervalKm(item){
  var it=getItemData(item.id);
  var history=it.history||[];
  if(history.length>=2){
    var kmVals=history.map(function(h){ return h.kmRidden||0; }).filter(function(v){ return v>50; });
    if(kmVals.length>=2){
      var avg=kmVals.reduce(function(s,v){ return s+v; },0)/kmVals.length;
      return Math.round(avg);
    }
  }
  return item.intervalKm;
}

function getStatus(item){
  var it=getItemData(item.id);
  if(!it.lastDate) return "none";
  var iKm=getEffectiveIntervalKm(item);
  var iDays=item.intervalDays;
  var kmPct=null, dayPct=null;
  if(iKm!=null){ var km=getKmSinceService(item.id); if(km!=null) kmPct=km/iKm; }
  if(iDays!=null){ var days=getDaysSinceService(item.id); if(days!=null) dayPct=days/iDays; }
  var pct=null;
  if(kmPct!=null && dayPct!=null) pct=Math.max(kmPct,dayPct);
  else if(kmPct!=null) pct=kmPct;
  else if(dayPct!=null) pct=dayPct;
  if(pct===null) return "good";
  if(pct>=1.0)   return "danger";
  if(pct>=0.8)   return "warn";
  return "good";
}

function buildInsight(item){
  var it=getItemData(item.id);
  if(!it.lastDate) return null;
  var iKm=getEffectiveIntervalKm(item);
  var lines=[];
  if(iKm!=null){
    var km=getKmSinceService(item.id);
    if(km!=null){
      var rem=iKm-km;
      if(rem>0){
        var days=getDaysSinceService(item.id)||1;
        var avgDailyKm=days>0 ? km/days : 0;
        var daysEst=avgDailyKm>0 ? Math.ceil(rem/avgDailyKm) : null;
        var estStr=daysEst ? " (~"+daysEst+" day"+(daysEst!==1?"s":"")+")" : "";
        lines.push(km+" / "+iKm+" km used"+estStr);
      } else {
        lines.push("Overdue by "+Math.abs(rem)+" km ‚Äî service needed");
      }
      if((it.history||[]).length>=2 && iKm!==item.intervalKm){
        lines.push("Personalized interval: "+iKm+" km (based on your history)");
      }
    }
  }
  if(item.intervalDays!=null){
    var days=getDaysSinceService(item.id);
    if(days!=null){
      var remDays=item.intervalDays-days;
      if(remDays>0) lines.push(days+" / "+item.intervalDays+" days used (~"+remDays+" days left)");
      else lines.push("Overdue by "+Math.abs(remDays)+" days ‚Äî replace battery/service");
    }
  }
  return lines.length ? lines.join(" ¬∑ ") : null;
}

function render(){
  renderBikeTabs();
  var totalKm=getActiveBikeTotalKm();
  document.getElementById("bikeTotalKm").textContent=totalKm>0?(totalKm.toLocaleString()+" km total"):"‚Äî";
  document.getElementById("lastSyncLabel").textContent=lastSyncTs ? "Synced "+timeSince(lastSyncTs) : "Never synced";
  renderDashboard();
}

function timeSince(isoStr){
  var mins=Math.round((Date.now()-new Date(isoStr).getTime())/60000);
  if(mins<2) return "just now";
  if(mins<60) return mins+"m ago";
  var hrs=Math.floor(mins/60);
  if(hrs<24) return hrs+"h ago";
  return Math.floor(hrs/24)+"d ago";
}

function renderBikeTabs(){
  var el=document.getElementById("bikeTabs");
  if(!bikes||bikes.length<=1){ el.innerHTML=""; return; }
  el.innerHTML=bikes.map(function(b){
    var act=b.id===activeBikeId?" active":"";
    var km=b.totalKm>0?'<span class="bkm">'+b.totalKm.toLocaleString()+' km</span>':'';
    return '<button class="bike-tab'+act+'" onclick="switchBike(\''+esc(b.id)+'\')">'+esc(b.name)+km+'</button>';
  }).join("");
}

function renderDashboard(){
  var el=document.getElementById("dashboard");
  var html="";
  CATEGORIES.forEach(function(cat){
    var items=ITEMS.filter(function(it){ return it.category===cat; });
    html+='<div class="category"><div class="cat-label">'+esc(cat)+'</div>';
    items.forEach(function(item){ html+=renderItemCard(item); });
    html+='</div>';
  });
  el.innerHTML=html;
}

function renderItemCard(item){
  var it=getItemData(item.id);
  var status=getStatus(item);
  var iKm=getEffectiveIntervalKm(item);
  var insight=buildInsight(item);
  var km=getKmSinceService(item.id);
  var days=getDaysSinceService(item.id);

  var cardClass="item-card"+(status==="warn"?" status-warn":status==="danger"?" status-danger":"");
  var badgeClass="item-status status-none-badge"; var badgeText="Not Set";
  if(status==="good"){   badgeClass="item-status status-good-badge";   badgeText="Good"; }
  if(status==="warn"){   badgeClass="item-status status-warn-badge";   badgeText="Due Soon"; }
  if(status==="danger"){ badgeClass="item-status status-danger-badge"; badgeText="Overdue!"; }

  var metaParts=[];
  if(it.lastDate) metaParts.push("Last: "+fmtDateShort(it.lastDate));
  if(km!=null) metaParts.push(km.toLocaleString()+" km ridden");
  else if(days!=null && !iKm) metaParts.push(days+" days ago");
  var meta=metaParts.length ? metaParts.join(" ¬∑ ") : "Tap 'Log Service' to start tracking";

  var barHtml="";
  var pct=null;
  if(it.lastDate && iKm!=null && km!=null) pct=Math.min(100,Math.round((km/iKm)*100));
  else if(it.lastDate && item.intervalDays!=null && days!=null) pct=Math.min(100,Math.round((days/item.intervalDays)*100));
  if(pct!==null){
    var barClass=pct>=100?"bar-danger":pct>=80?"bar-warn":"bar-good";
    var leftLabel=iKm!=null?(km+" km"):(days+" days");
    var rightLabel=iKm!=null?(iKm+" km interval"):(item.intervalDays+" days interval");
    barHtml='<div class="item-bar-wrap"><div class="item-bar-bg"><div class="item-bar-fill '+barClass+'" style="width:'+pct+'%"></div></div><div class="item-bar-labels"><span>'+leftLabel+'</span><span>'+rightLabel+'</span></div></div>';
  }

  var insightHtml="";
  if(insight){
    var iClass=status==="danger"?"insight-danger":status==="warn"?"insight-warn":"insight-good";
    insightHtml='<div class="item-insight"><span class="'+iClass+'">'+esc(insight)+'</span></div>';
  }

  var histCount=(it.history||[]).length;
  var histLabel="History"+(histCount>0?" ("+histCount+")":"");

  return '<div class="'+cardClass+'">'+
    '<div class="item-top">'+
      '<div class="item-emoji">'+item.emoji+'</div>'+
      '<div class="item-info"><div class="item-name">'+esc(item.name)+'</div><div class="item-meta">'+esc(meta)+'</div></div>'+
      '<div class="'+badgeClass+'">'+badgeText+'</div>'+
    '</div>'+
    barHtml+insightHtml+
    '<div class="item-actions">'+
      '<button class="btn-log" onclick="openLogModal(\''+item.id+'\')">‚úì Log Service</button>'+
      '<button class="btn-history" onclick="openHistoryModal(\''+item.id+'\')">'+esc(histLabel)+'</button>'+
    '</div>'+
  '</div>';
}

// ‚îÄ‚îÄ Fetch km ridden on active bike since a given date from Strava activities ‚îÄ‚îÄ
async function fetchKmSinceDate(dateStr){
  if(!strava) return null;
  try{
    var token=await getToken();
    if(!token) return null;
    var afterTs=Math.floor(new Date(dateStr+"T00:00:00").getTime()/1000);
    var totalMeters=0;
    var page=1;
    while(true){
      var r=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({action:"activities",access_token:token,after:afterTs,page:page})});
      var acts=await r.json();
      if(!Array.isArray(acts)||acts.length===0) break;
      acts.forEach(function(a){
        if(a.gear_id===activeBikeId && a.distance) totalMeters+=a.distance;
      });
      if(acts.length<30) break;
      page++;
    }
    return Math.round(totalMeters/1000);
  }catch(e){
    console.error("fetchKmSinceDate failed:",e);
    return null;
  }
}

// ‚îÄ‚îÄ Log Service Modal ‚îÄ‚îÄ
function openLogModal(itemId){
  _logItemId=itemId;
  var item=ITEMS.find(function(x){ return x.id===itemId; });
  var it=getItemData(itemId);
  var km=getKmSinceService(itemId);

  document.getElementById("logModalTitle").textContent="Log Service: "+item.name;
  document.getElementById("logDate").value=todayStr();
  document.getElementById("logNote").value="";
  document.getElementById("btnConfirmLog").disabled=false;
  document.getElementById("btnConfirmLog").textContent="‚úì Record Service";

  var rows="";
  if(it.lastDate) rows+='<div class="row"><span class="label">Last service</span><span class="val">'+fmtDate(it.lastDate)+'</span></div>';
  if(km!=null) rows+='<div class="row"><span class="label">Km ridden since</span><span class="val accent">'+km.toLocaleString()+' km</span></div>';
  else rows+='<div class="row"><span class="label">First record</span><span class="val" style="color:var(--text-muted)">Km will be fetched from Strava</span></div>';
  rows+='<div class="row"><span class="label">Bike total km</span><span class="val">'+getActiveBikeTotalKm().toLocaleString()+' km</span></div>';
  document.getElementById("logSummary").innerHTML=rows;

  document.getElementById("logModal").classList.remove("hidden");
}

async function confirmLogService(){
  var itemId=_logItemId;
  var item=ITEMS.find(function(x){ return x.id===itemId; });
  var it=getItemData(itemId);
  var serviceDate=document.getElementById("logDate").value;
  var note=document.getElementById("logNote").value.trim();

  if(!serviceDate){ toast("Please select a date","err"); return; }

  var btn=document.getElementById("btnConfirmLog");
  btn.disabled=true;

  var totalKm=getActiveBikeTotalKm();
  var kmRidden=null;

  if(it.lastDate && it.lastKmTotal!=null){
    // ‚îÄ‚îÄ Not first time: km since service = difference in bike totals ‚îÄ‚îÄ
    kmRidden=Math.max(0, totalKm - it.lastKmTotal);
    btn.textContent="Recording...";
  } else {
    // ‚îÄ‚îÄ First time logging this item: fetch actual rides from Strava since service date ‚îÄ‚îÄ
    btn.textContent="Fetching km from Strava...";
    var fetchedKm=await fetchKmSinceDate(serviceDate);
    if(fetchedKm!=null && fetchedKm>0){
      kmRidden=fetchedKm;
      // Back-calculate lastKmTotal so future syncs compute correctly
      it.lastKmTotal=totalKm - fetchedKm;
      toast("Fetched "+fetchedKm+" km from Strava since "+fmtDateShort(serviceDate),"ok");
    } else {
      // Strava returned 0 or failed ‚Äî set baseline to current total (0 km since service)
      kmRidden=0;
      it.lastKmTotal=totalKm;
      if(fetchedKm===0) toast("No rides found on this bike since "+fmtDateShort(serviceDate),"info");
      else toast("Strava fetch failed ‚Äî km set to 0","info");
    }
  }

  // Save history entry
  if(!it.history) it.history=[];
  it.history.unshift({
    date:       serviceDate,
    kmAtService:totalKm,
    kmRidden:   kmRidden,
    note:       note
  });

  // Update state
  it.lastDate=serviceDate;
  if(it.lastKmTotal==null) it.lastKmTotal=totalKm;

  btn.disabled=false;
  btn.textContent="‚úì Record Service";
  closeModalId("logModal");
  saveAll();
  toast(item.name+" service recorded! ("+kmRidden+" km since service date)","ok");
  render();
}

// ‚îÄ‚îÄ History Modal ‚îÄ‚îÄ
function openHistoryModal(itemId){
  var item=ITEMS.find(function(x){ return x.id===itemId; });
  var it=getItemData(itemId);
  var history=it.history||[];
  document.getElementById("historyModalTitle").textContent=item.name+" History";

  var aiBox=document.getElementById("historyAI");
  if(history.length>=2){
    var kmVals=history.map(function(h){ return h.kmRidden; }).filter(function(v){ return v!=null&&v>0; });
    if(kmVals.length>=2){
      var avg=Math.round(kmVals.reduce(function(s,v){ return s+v; },0)/kmVals.length);
      var min=Math.min.apply(null,kmVals); var max=Math.max.apply(null,kmVals);
      var insight="Based on "+kmVals.length+" services, you typically service this every <strong style='color:var(--accent)'>"+avg+" km</strong> (range: "+min+"‚Äì"+max+" km).";
      if(item.intervalKm){ insight+=avg<item.intervalKm ? " Your pattern suggests you could extend to "+item.intervalKm+" km." : " You're using the full recommended interval well."; }
      insight+=" Dashboard intervals are now personalized to your pattern.";
      aiBox.innerHTML="<strong>ü§ñ AI Trend Analysis</strong>"+insight;
      aiBox.classList.remove("hidden");
    } else { aiBox.classList.add("hidden"); }
  } else { aiBox.classList.add("hidden"); }

  var listEl=document.getElementById("historyList");
  if(history.length===0){
    listEl.innerHTML='<div class="history-empty">No service history yet.<br>Log a service to start building history.</div>';
  } else {
    listEl.innerHTML=history.map(function(h,idx){
      var kmStr=h.kmRidden!=null ? h.kmRidden.toLocaleString()+" km since previous service" : "First service record";
      var tag=idx===0?'<span class="history-tag">Latest</span>':'';
      return '<div class="history-item"><div><div class="history-date">'+fmtDate(h.date)+' '+tag+'</div><div class="history-km">'+kmStr+'</div>'+(h.note?'<div class="history-note">'+esc(h.note)+'</div>':'')+'</div></div>';
    }).join("");
  }
  document.getElementById("historyModal").classList.remove("hidden");
}

function closeModal(e,id){ if(e.target===document.getElementById(id)) closeModalId(id); }
function closeModalId(id){ document.getElementById(id).classList.add("hidden"); }
function switchBike(id){ activeBikeId=id; render(); }

function connectStrava(){
  localStorage.setItem("chainwax_client_id",    STRAVA_CLIENT_ID);
  localStorage.setItem("chainwax_client_secret", STRAVA_CLIENT_SECRET);
  localStorage.setItem("strava_return_to",       "/bike-maintenance.html");
  window.location.href="https://www.strava.com/oauth/authorize?client_id="+STRAVA_CLIENT_ID+
    "&response_type=code&redirect_uri="+encodeURIComponent(CALLBACK)+
    "&approval_prompt=auto&scope=activity:read_all";
}

function logout(){
  if(!confirm("Logout? Local session cleared.")) return;
  localStorage.removeItem("bikemaint_session");
  athlete=null; strava=null; binId=null;
  bikes=[]; activeBikeId=null; bikeData={}; lastSyncTs=null;
  document.getElementById("loginScreen").classList.remove("hidden");
  document.getElementById("mainApp").classList.add("hidden");
}

async function getToken(){
  if(!strava) return null;
  var now=Math.floor(Date.now()/1000);
  if(now < strava.expiresAt-60) return strava.accessToken;
  try{
    var resp=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"token",client_id:STRAVA_CLIENT_ID,client_secret:STRAVA_CLIENT_SECRET,
        refresh_token:strava.refreshToken,grant_type:"refresh_token"})});
    var d=await resp.json();
    if(d.access_token){
      strava.accessToken=d.access_token; strava.refreshToken=d.refresh_token; strava.expiresAt=d.expires_at;
      saveLocal(); return d.access_token;
    }
  }catch(e){ console.error("Token refresh failed:",e); }
  return null;
}

async function syncStrava(){
  if(!strava){ toast("Not connected","err"); return; }
  var btn=document.getElementById("btnSync");
  btn.disabled=true; btn.innerHTML='<span class="spin-inline">‚Üª</span> Syncing...';
  try{
    var token=await getToken();
    if(!token) throw new Error("Session expired ‚Äî please reconnect Strava.");

    var gearIds=[];
    var pg=1;
    while(pg<=3){
      var r=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({action:"activities",access_token:token,after:0,page:pg})});
      var acts=await r.json();
      if(!Array.isArray(acts)||acts.length===0) break;
      acts.forEach(function(a){ if(a.gear_id&&gearIds.indexOf(a.gear_id)===-1) gearIds.push(a.gear_id); });
      pg++;
    }

    if(!gearIds.length){
      toast("No bikes found in your recent Strava activities","info");
      btn.disabled=false; btn.innerHTML="‚Üª Sync Strava"; return;
    }

    var fetched=[];
    for(var i=0;i<gearIds.length;i++){
      try{
        var gr=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({action:"gear",gear_id:gearIds[i],access_token:token})});
        var gd=await gr.json();
        if(gd&&gd.id) fetched.push(gd);
      }catch(ge){ console.error("gear fetch:",ge); }
    }

    bikes=fetched.map(function(b){
      return{ id:b.id, name:b.nickname||b.name||"Bike", totalKm:Math.round((b.distance||0)/1000) };
    });

    if(!activeBikeId||!bikes.find(function(b){ return b.id===activeBikeId; })){
      activeBikeId=bikes.length ? bikes[0].id : null;
    }

    lastSyncTs=new Date().toISOString();
    await saveAll();
    toast("Synced "+bikes.length+" bike"+(bikes.length!==1?"s":"")+"!","ok");
  }catch(e){ toast("Sync failed: "+e.message,"err"); }
  btn.disabled=false; btn.innerHTML="‚Üª Sync Strava";
  render();
}

async function saveToCloud(){
  if(!athlete) return;
  var payload={ athlete:athlete, strava:strava, bikes:bikes, activeBikeId:activeBikeId, bikeData:bikeData, lastSyncTs:lastSyncTs };
  try{
    var r=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"save",bin_id:binId,athlete_id:athlete.id,data:payload})});
    var d=await r.json();
    if(d.bin_id&&!binId){ binId=d.bin_id; localStorage.setItem("bikemaint_bin_"+athlete.id,binId); }
  }catch(e){ console.error("Cloud save failed:",e); }
}

async function loadFromCloud(aid,bid){
  try{
    var r=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"load",bin_id:bid,athlete_id:aid})});
    var d=await r.json();
    if(d.data){
      var s=d.data;
      if(s.athlete)      athlete=s.athlete;
      if(s.strava)       strava=s.strava;
      if(s.bikes)        bikes=s.bikes;
      if(s.activeBikeId) activeBikeId=s.activeBikeId;
      if(s.bikeData)     bikeData=s.bikeData;
      if(s.lastSyncTs)   lastSyncTs=s.lastSyncTs;
      return true;
    }
  }catch(e){ console.error("Cloud load failed:",e); }
  return false;
}

function saveLocal(){
  try{
    localStorage.setItem("bikemaint_session",JSON.stringify({
      athlete:athlete, strava:strava, binId:binId, bikes:bikes,
      activeBikeId:activeBikeId, bikeData:bikeData, lastSyncTs:lastSyncTs
    }));
  }catch(e){}
}

function loadLocal(){
  try{
    var s=localStorage.getItem("bikemaint_session");
    if(s){
      var d=JSON.parse(s);
      athlete=d.athlete||null; strava=d.strava||null; binId=d.binId||null;
      bikes=d.bikes||[]; activeBikeId=d.activeBikeId||null;
      bikeData=d.bikeData||{}; lastSyncTs=d.lastSyncTs||null;
      return !!athlete;
    }
  }catch(e){}
  return false;
}

async function saveAll(){ saveLocal(); await saveToCloud(); }

(async function(){
  var loadEl=document.getElementById("loadingScreen");
  var loginEl=document.getElementById("loginScreen");
  var appEl=document.getElementById("mainApp");

  function showApp(){
    loginEl.classList.add("hidden"); appEl.classList.remove("hidden");
    document.getElementById("athleteName").textContent=athlete ? (athlete.firstname||"")+" "+(athlete.lastname||"") : "";
    render();
  }

  // ‚îÄ‚îÄ Check for Strava callback token ‚îÄ‚îÄ
  var stravaRaw=localStorage.getItem("chainwax_strava");
  if(stravaRaw){
    try{
      var sd=JSON.parse(stravaRaw);
      var accessToken  = sd.accessToken  || sd.access_token;
      var refreshToken = sd.refreshToken || sd.refresh_token;
      var expiresAt    = sd.expiresAt    || sd.expires_at;
      var sdAthlete    = sd.athlete;
      if(accessToken){
        if(sdAthlete) athlete=sdAthlete;
        strava={accessToken:accessToken,refreshToken:refreshToken,expiresAt:expiresAt};
        localStorage.removeItem("chainwax_strava");
        if(!athlete){
          try{
            var ar=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
              body:JSON.stringify({action:"athlete",access_token:accessToken})});
            var ad=await ar.json();
            if(ad&&ad.id) athlete=ad;
          }catch(ae){ console.error("Athlete fetch failed:",ae); }
        }
        if(!athlete) athlete={id:"unknown",firstname:"Strava",lastname:"User"};
        var existingBin=localStorage.getItem("bikemaint_bin_"+(athlete.id||""))||
                        localStorage.getItem("chainwax_bin_"+(athlete.id||""));
        if(existingBin){ binId=existingBin; await loadFromCloud(athlete.id,binId); }
        // Show app immediately, then sync in background
        saveLocal();
        loadEl.style.display="none";
        showApp();
        syncStrava().catch(function(e){ console.error("Background sync failed:",e); });
        return;
      }
    }catch(e){ console.error("OAuth callback parse error:",e); }
  }

  // ‚îÄ‚îÄ Restore from localStorage ‚îÄ‚îÄ
  if(loadLocal()&&athlete){
    if(binId) await loadFromCloud(athlete.id,binId);
    if(!activeBikeId&&bikes.length) activeBikeId=bikes[0].id;
    loadEl.style.display="none";
    showApp(); return;
  }

  // ‚îÄ‚îÄ Not authenticated ‚îÄ‚îÄ
  loadEl.style.display="none";
  loginEl.classList.remove("hidden");
})();
</script>
</body>
</html>
