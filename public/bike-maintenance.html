<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Bike Maintenance</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0a0b; --bg2:#111113; --card:#16161a; --border:#252530; --border-l:#32323e;
  --accent:#f0a030; --accent-dim:#c88020; --accent-glow:rgba(240,160,48,0.12);
  --danger:#f04848; --danger-glow:rgba(240,72,72,0.12);
  --warn:#f5a623; --warn-glow:rgba(245,166,35,0.12);
  --success:#30d870; --success-glow:rgba(48,216,112,0.12);
  --text:#eaeaef; --text-dim:#7a7a8a; --text-muted:#4a4a58;
  --strava:#fc4c02;
  --good:#30d870; --warn-c:#f5a623; --danger-c:#f04848;
  --ff-display:'Sora',sans-serif; --ff-mono:'DM Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:16px}
body{min-height:100vh;background:var(--bg);color:var(--text);font-family:var(--ff-display);-webkit-font-smoothing:antialiased;overscroll-behavior:none}
.app{max-width:640px;margin:0 auto;padding:0 0 80px}

/* â”€â”€ Header â”€â”€ */
.header{padding:20px 20px 16px;background:var(--bg2);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;backdrop-filter:blur(10px)}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.header-left{display:flex;align-items:center;gap:12px}
.logo{width:38px;height:38px;background:linear-gradient(135deg,var(--accent),var(--accent-dim));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.app-title{font-size:17px;font-weight:700;letter-spacing:-0.3px}
.app-sub{font-family:var(--ff-mono);font-size:10px;color:var(--text-dim);margin-top:1px}
.header-actions{display:flex;align-items:center;gap:8px}
.badge-strava{font-family:var(--ff-mono);font-size:10px;padding:3px 8px;border-radius:20px;background:rgba(252,76,2,0.15);color:var(--strava);border:1px solid rgba(252,76,2,0.25)}
.btn-logout{background:none;border:1px solid var(--border-l);color:var(--text-dim);font-family:var(--ff-mono);font-size:10px;padding:4px 8px;border-radius:6px;cursor:pointer}
.btn-logout:hover{color:var(--danger);border-color:rgba(240,72,72,0.4)}

/* â”€â”€ Bike tabs â”€â”€ */
.bike-tabs{display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px}
.bike-tabs::-webkit-scrollbar{display:none}
.bike-tab{flex-shrink:0;padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-family:var(--ff-mono);font-size:11px;cursor:pointer;transition:all 0.2s;white-space:nowrap}
.bike-tab.active{background:var(--accent-glow);border-color:rgba(240,160,48,0.35);color:var(--accent);font-weight:500}
.bike-tab .bkm{font-size:10px;opacity:0.7;margin-left:4px}
.bike-total-bar{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
.bike-total-val{font-family:var(--ff-mono);font-size:13px;color:var(--accent);font-weight:500}
.last-sync{font-family:var(--ff-mono);font-size:10px;color:var(--text-muted)}

/* â”€â”€ Sync bar â”€â”€ */
.sync-bar{padding:12px 20px;display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--border)}
.btn-sync{flex:1;padding:11px 16px;background:var(--strava);color:#fff;border:none;border-radius:10px;font-family:var(--ff-mono);font-size:12px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:background 0.2s}
.btn-sync:hover:not(:disabled){background:#e04400}
.btn-sync:disabled{opacity:0.5;cursor:not-allowed}
.btn-add-manual{padding:11px 16px;background:var(--card);border:1px solid var(--border);color:var(--text-dim);border-radius:10px;font-family:var(--ff-mono);font-size:12px;cursor:pointer;transition:all 0.2s}
.btn-add-manual:hover{border-color:var(--border-l);color:var(--text)}

/* â”€â”€ Categories â”€â”€ */
.category{padding:20px 20px 0}
.cat-label{font-family:var(--ff-mono);font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.cat-label::after{content:'';flex:1;height:1px;background:var(--border)}

/* â”€â”€ Item card â”€â”€ */
.item-card{background:var(--card);border:1px solid var(--border);border-radius:14px;margin-bottom:10px;overflow:hidden;transition:border-color 0.2s}
.item-card:hover{border-color:var(--border-l)}
.item-card.status-warn{border-left:3px solid var(--warn-c)}
.item-card.status-danger{border-left:3px solid var(--danger-c);animation:pulseCard 3s infinite}
@keyframes pulseCard{0%,100%{box-shadow:none}50%{box-shadow:0 0 0 1px rgba(240,72,72,0.15)}}
.item-top{display:flex;align-items:flex-start;padding:14px 16px 10px;gap:12px}
.item-emoji{font-size:22px;line-height:1;flex-shrink:0;margin-top:1px}
.item-info{flex:1;min-width:0}
.item-name{font-size:14px;font-weight:600;letter-spacing:-0.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item-meta{font-family:var(--ff-mono);font-size:10px;color:var(--text-dim);margin-top:3px}
.item-status{flex-shrink:0;font-family:var(--ff-mono);font-size:9px;font-weight:600;padding:3px 8px;border-radius:10px;text-transform:uppercase;letter-spacing:0.5px;align-self:flex-start}
.status-good-badge{background:var(--success-glow);color:var(--good);border:1px solid rgba(48,216,112,0.2)}
.status-warn-badge{background:var(--warn-glow);color:var(--warn-c);border:1px solid rgba(245,166,35,0.2)}
.status-danger-badge{background:var(--danger-glow);color:var(--danger-c);border:1px solid rgba(240,72,72,0.2)}
.status-none-badge{background:rgba(255,255,255,0.04);color:var(--text-muted);border:1px solid var(--border)}

/* â”€â”€ Progress bar â”€â”€ */
.item-bar-wrap{padding:0 16px 10px}
.item-bar-bg{height:5px;background:var(--border);border-radius:99px;overflow:hidden}
.item-bar-fill{height:100%;border-radius:99px;transition:width 0.8s cubic-bezier(0.4,0,0.2,1)}
.bar-good{background:var(--good)}
.bar-warn{background:var(--warn-c)}
.bar-danger{background:var(--danger-c)}
.item-bar-labels{display:flex;justify-content:space-between;margin-top:5px;font-family:var(--ff-mono);font-size:9px;color:var(--text-muted)}

/* â”€â”€ Insight â”€â”€ */
.item-insight{padding:0 16px 10px;font-family:var(--ff-mono);font-size:10px;color:var(--text-dim);line-height:1.5}
.insight-good{color:var(--good)}
.insight-warn{color:var(--warn-c)}
.insight-danger{color:var(--danger-c)}

/* â”€â”€ Actions â”€â”€ */
.item-actions{display:flex;padding:0 16px 14px;gap:8px;border-top:1px solid var(--border);padding-top:12px}
.btn-log{flex:1;padding:9px;background:var(--accent);color:var(--bg);border:none;border-radius:8px;font-family:var(--ff-mono);font-size:11px;font-weight:600;cursor:pointer;transition:background 0.2s}
.btn-log:hover{background:var(--accent-dim)}
.btn-history{padding:9px 16px;background:var(--bg);border:1px solid var(--border);color:var(--text-dim);border-radius:8px;font-family:var(--ff-mono);font-size:11px;cursor:pointer;transition:all 0.2s}
.btn-history:hover{border-color:var(--border-l);color:var(--text)}
.btn-edit-date{padding:9px 12px;background:var(--bg);border:1px solid var(--border);color:var(--text-muted);border-radius:8px;font-family:var(--ff-mono);font-size:11px;cursor:pointer;transition:all 0.2s}
.btn-edit-date:hover{border-color:var(--border-l);color:var(--text-dim)}

/* â”€â”€ Not configured placeholder â”€â”€ */
.item-setup{padding:10px 16px 14px;font-family:var(--ff-mono);font-size:11px;color:var(--text-muted);font-style:italic}

/* â”€â”€ Login â”€â”€ */
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.login-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:40px 32px;max-width:380px;width:100%;text-align:center}
.login-icon{font-size:52px;margin-bottom:20px}
.login-title{font-size:22px;font-weight:700;margin-bottom:10px}
.login-desc{color:var(--text-dim);font-size:14px;line-height:1.6;margin-bottom:28px}
.btn-strava-big{width:100%;padding:14px;background:var(--strava);color:#fff;border:none;border-radius:12px;font-family:var(--ff-mono);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:background 0.2s}
.btn-strava-big:hover{background:#e04400}

/* â”€â”€ Modals â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;display:flex;align-items:flex-end;justify-content:center;animation:fadeOverlay 0.2s ease}
@keyframes fadeOverlay{from{opacity:0}to{opacity:1}}
.modal-sheet{background:var(--bg2);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:640px;padding:0 0 env(safe-area-inset-bottom,20px);animation:slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--border-l);border-radius:99px;margin:12px auto 0}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px}
.modal-title{font-size:16px;font-weight:700}
.modal-close{background:none;border:none;color:var(--text-muted);font-size:22px;cursor:pointer;line-height:1;padding:0 4px}
.modal-close:hover{color:var(--text)}
.modal-body{padding:0 20px 20px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-family:var(--ff-mono);font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:8px}
.form-input{width:100%;padding:11px 14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:var(--ff-mono);font-size:13px;outline:none;transition:border-color 0.2s}
.form-input:focus{border-color:var(--accent)}
.form-hint{margin-top:16px;padding:12px 16px;border-radius:10px;background:var(--accent-glow);border:1px solid rgba(240,160,48,0.15);font-family:var(--ff-mono);font-size:11px;color:var(--text-dim);line-height:1.6}
.form-hint strong{color:var(--accent)}
.modal-summary{background:var(--card);border-radius:10px;padding:14px 16px;margin-bottom:16px}
.modal-summary .row{display:flex;justify-content:space-between;font-family:var(--ff-mono);font-size:12px;padding:3px 0}
.modal-summary .row .label{color:var(--text-dim)}
.modal-summary .row .val{color:var(--text);font-weight:500}
.modal-summary .row .val.accent{color:var(--accent)}
.btn-confirm{width:100%;padding:13px;background:var(--accent);color:var(--bg);border:none;border-radius:10px;font-family:var(--ff-mono);font-size:13px;font-weight:600;cursor:pointer;transition:background 0.2s;margin-top:4px}
.btn-confirm:hover{background:var(--accent-dim)}
.btn-confirm-danger{background:var(--danger);color:#fff}
.btn-confirm-danger:hover{background:#d43030}

/* â”€â”€ History sheet â”€â”€ */
.history-list{max-height:60vh;overflow-y:auto;padding-right:2px}
.history-item{padding:14px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start}
.history-item:last-child{border-bottom:none}
.history-date{font-family:var(--ff-mono);font-size:12px;font-weight:500;color:var(--text)}
.history-km{font-family:var(--ff-mono);font-size:11px;color:var(--accent);margin-top:3px}
.history-note{font-family:var(--ff-mono);font-size:10px;color:var(--text-dim);margin-top:2px;font-style:italic}
.history-tag{font-family:var(--ff-mono);font-size:9px;padding:2px 7px;border-radius:10px;background:var(--success-glow);color:var(--good);border:1px solid rgba(48,216,112,0.2)}
.history-ai-box{background:var(--accent-glow);border:1px solid rgba(240,160,48,0.15);border-radius:10px;padding:14px 16px;margin-bottom:16px;font-family:var(--ff-mono);font-size:11px;color:var(--text-dim);line-height:1.7}
.history-ai-box strong{color:var(--accent);display:block;margin-bottom:6px}
.history-empty{padding:28px 0;text-align:center;font-family:var(--ff-mono);font-size:11px;color:var(--text-muted)}

/* â”€â”€ Toast â”€â”€ */
.toast{position:fixed;top:20px;right:20px;z-index:200;padding:11px 18px;border-radius:10px;font-family:var(--ff-mono);font-size:12px;box-shadow:0 8px 32px rgba(0,0,0,0.6);animation:slideIn 0.3s ease}
.toast-ok{background:var(--success);color:#fff}
.toast-err{background:var(--danger);color:#fff}
.toast-info{background:var(--accent);color:var(--bg)}
@keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}

/* â”€â”€ Loading â”€â”€ */
.loading-overlay{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:999;font-family:var(--ff-mono);color:var(--accent);font-size:13px}
.spinner{width:22px;height:22px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.hidden{display:none!important}

/* â”€â”€ No service configured â”€â”€ */
.no-service{padding:8px 16px 14px;display:flex;align-items:center;gap:8px;font-family:var(--ff-mono);font-size:11px;color:var(--text-muted);font-style:italic}

/* â”€â”€ Misc â”€â”€ */
.spin-inline{display:inline-block;animation:spin 0.8s linear infinite;margin-right:6px}
</style>
</head>
<body>

<!-- Loading -->
<div class="loading-overlay" id="loadingScreen"><div class="spinner"></div>Loading...</div>

<!-- Login -->
<div id="loginScreen" class="hidden">
  <div class="login-wrap">
    <div class="login-card">
      <div class="login-icon">ğŸš´</div>
      <div class="login-title">Bike Maintenance</div>
      <div class="login-desc">
        Connect your Strava account to track maintenance for all your bikes.
        Service history, AI-powered intervals, and Strava-synced km tracking.
      </div>
      <button class="btn-strava-big" onclick="connectStrava()">
        <span style="font-size:18px">âš¡</span> Connect with Strava
      </button>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden">
  <div class="app">

    <!-- Header -->
    <div class="header">
      <div class="header-top">
        <div class="header-left">
          <div class="logo">ğŸ”§</div>
          <div>
            <div class="app-title">Bike Maintenance</div>
            <div class="app-sub" id="athleteName">Loading...</div>
          </div>
        </div>
        <div class="header-actions">
          <div class="badge-strava">â— Strava</div>
          <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
      </div>
      <div id="bikeTabsWrap">
        <div class="bike-tabs" id="bikeTabs"></div>
        <div class="bike-total-bar">
          <div class="bike-total-val" id="bikeTotalKm">â€” km total</div>
          <div class="last-sync" id="lastSyncLabel">Never synced</div>
        </div>
      </div>
    </div>

    <!-- Sync bar -->
    <div class="sync-bar">
      <button class="btn-sync" id="btnSync" onclick="syncStrava()">
        â†» Sync Strava
      </button>
    </div>

    <!-- Dashboard: items rendered here -->
    <div id="dashboard"></div>

  </div>
</div>

<!-- â•â• LOG SERVICE MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay hidden" id="logModal" onclick="closeModal(event,'logModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="logModalTitle">Log Service</div>
      <button class="modal-close" onclick="closeModalId('logModal')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="modal-summary" id="logSummary"></div>
      <div class="form-group">
        <label class="form-label">Service Date</label>
        <input class="form-input" type="date" id="logDate">
      </div>
      <div class="form-group" id="logKmFieldWrap">
        <label class="form-label">Km already ridden since this service (enter 0 for today)</label>
        <input class="form-input" type="number" id="logKmPre" value="0" min="0" step="1" placeholder="0">
      </div>
      <div class="form-group">
        <label class="form-label">Notes (optional)</label>
        <input class="form-input" type="text" id="logNote" placeholder="e.g. Molten Speed Wax, CR2032 battery...">
      </div>
      <button class="btn-confirm" onclick="confirmLogService()">âœ“ Record Service</button>
    </div>
  </div>
</div>

<!-- â•â• HISTORY MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay hidden" id="historyModal" onclick="closeModal(event,'historyModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="historyModalTitle">Service History</div>
      <button class="modal-close" onclick="closeModalId('historyModal')">Ã—</button>
    </div>
    <div class="modal-body">
      <div id="historyAI" class="history-ai-box hidden"></div>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>
</div>

<script>
// â”€â”€ Strava credentials (reuse from chain-wax.html) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var STRAVA_CLIENT_ID     = "202550";
var STRAVA_CLIENT_SECRET = "28a52c20e5aa595af90ed7477e8cd1443f00de5a";
var CALLBACK             = window.location.origin + "/strava-callback.html";

// â”€â”€ Maintenance item definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// intervalKm: km-based service interval (null = not applicable)
// intervalDays: day-based service interval (null = not applicable)
// When both are set, the first threshold reached triggers the warning.
var ITEMS = [
  { id:"chain_wax",      name:"Chain Wax",                    emoji:"â›“ï¸", category:"Drivetrain",  intervalKm:400,   intervalDays:null, note:"Immersed chain wax lasts 300â€“500 km. Re-apply sooner in wet/muddy conditions." },
  { id:"di2_charge",     name:"Di2 Battery Charge",           emoji:"âš¡", category:"Drivetrain",  intervalKm:1200,  intervalDays:null, note:"Shimano Di2 lasts ~1,000â€“2,000 km. Check battery indicator display." },
  { id:"bearings_hubs",  name:"Wheel Hub Bearings",           emoji:"ğŸ”©", category:"Bearings",    intervalKm:15000, intervalDays:730,  note:"Ceramic hub bearings: 10,000â€“20,000 km or 2â€“3 years. Service when rough." },
  { id:"bearings_bb",    name:"Bottom Bracket Bearings",      emoji:"ğŸ”©", category:"Bearings",    intervalKm:8000,  intervalDays:365,  note:"Ceramic BB: 5,000â€“10,000 km or 1â€“2 years. Replace at any creak or play." },
  { id:"bearings_headset",name:"Headset Bearings",            emoji:"ğŸ”©", category:"Bearings",    intervalKm:15000, intervalDays:730,  note:"Ceramic headset: 10,000â€“20,000 km or 2â€“3 years. Check for indexing." },
  { id:"wahoo_cadence",  name:"Wahoo Cadence Battery",        emoji:"ğŸ”‹", category:"Electronics", intervalKm:null,  intervalDays:365,  note:"CR2032 battery: 12â€“18 months of regular riding." },
  { id:"power_left",     name:"Left Crank Power Meter",       emoji:"ğŸ”‹", category:"Electronics", intervalKm:null,  intervalDays:240,  note:"CR2032: 6â€“12 months. Replace when accuracy drops or unit shows low battery." },
  { id:"power_right",    name:"Right Crank Power Meter",      emoji:"ğŸ”‹", category:"Electronics", intervalKm:null,  intervalDays:240,  note:"CR2032: 6â€“12 months. Replace when accuracy drops or unit shows low battery." },
  { id:"hrm",            name:"Heart Rate Monitor Battery",   emoji:"â¤ï¸", category:"Electronics", intervalKm:null,  intervalDays:365,  note:"CR2032 battery: 12â€“18 months with regular use." },
  { id:"brake_pads",     name:"Brake Pads",                   emoji:"ğŸ›‘", category:"Wear Items",  intervalKm:3000,  intervalDays:null, note:"Road pads: 2,000â€“5,000 km. Inspect pad thickness; replace below 1 mm." },
  { id:"tires",          name:"Tires",                        emoji:"ğŸš²", category:"Wear Items",  intervalKm:4000,  intervalDays:null, note:"Training tires: 3,000â€“5,000 km. Check for cuts, cracking, and tread wear." },
  { id:"overhaul",       name:"Full Overhaul",                emoji:"ğŸ”§", category:"General",     intervalKm:12000, intervalDays:365,  note:"Full service: cables, housing, bearings, drivetrain. Annually or every 10,000â€“15,000 km." },
];

var CATEGORIES = ["Drivetrain","Bearings","Electronics","Wear Items","General"];

// â”€â”€ App state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var athlete    = null;   // Strava athlete object
var strava     = null;   // {accessToken, refreshToken, expiresAt}
var binId      = null;   // JSONBin cloud storage ID
var bikes      = [];     // [{id, name, totalKm}]
var activeBikeId = null;
// bikeData[id] = { items: { [itemId]: { lastDate, lastKmTotal, history[] } } }
var bikeData   = {};
var lastSyncTs = null;   // ISO timestamp of last Strava sync
var _logItemId = null;   // which item the log modal is currently for

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n){ return Math.round(n*10)/10; }
function fmtDate(d){
  if(!d) return "â€”";
  return new Date(d+"T00:00:00").toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});
}
function fmtDateShort(d){
  if(!d) return "â€”";
  return new Date(d+"T00:00:00").toLocaleDateString("en-GB",{day:"numeric",month:"short"});
}
function todayStr(){ return new Date().toISOString().split("T")[0]; }
function daysSince(dateStr){
  if(!dateStr) return null;
  return Math.max(0, Math.round((Date.now() - new Date(dateStr+"T00:00:00").getTime())/86400000));
}
function esc(s){ var d=document.createElement("div"); d.textContent=s; return d.innerHTML; }

function toast(msg,type){
  var el=document.createElement("div"); el.className="toast toast-"+(type||"info");
  el.textContent=msg; document.body.appendChild(el);
  setTimeout(function(){el.style.opacity="0";el.style.transition="opacity 0.3s";setTimeout(function(){el.remove();},300);},3000);
}

// â”€â”€ Per-bike data accessors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getActiveBikeData(){
  if(!activeBikeId) return {};
  if(!bikeData[activeBikeId]) bikeData[activeBikeId]={items:{}};
  return bikeData[activeBikeId];
}
function getItemData(itemId){
  var d=getActiveBikeData();
  if(!d.items) d.items={};
  if(!d.items[itemId]) d.items[itemId]={lastDate:null,lastKmTotal:null,history:[]};
  return d.items[itemId];
}
function getActiveBikeTotalKm(){
  var b=bikes.find(function(x){return x.id===activeBikeId;});
  return b ? (b.totalKm||0) : 0;
}

// â”€â”€ Status / distance calculations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getKmSinceService(itemId){
  var it=getItemData(itemId);
  if(!it.lastDate || it.lastKmTotal==null) return null;
  var totalKm=getActiveBikeTotalKm();
  return Math.max(0, totalKm - it.lastKmTotal);
}
function getDaysSinceService(itemId){
  var it=getItemData(itemId);
  if(!it.lastDate) return null;
  return daysSince(it.lastDate);
}

// Get the effective interval for an item (personalized if history exists)
function getEffectiveIntervalKm(item){
  var it=getItemData(item.id);
  var history=it.history||[];
  if(history.length>=2){
    var kmVals=history.map(function(h){return h.kmRidden||0;}).filter(function(v){return v>50;});
    if(kmVals.length>=2){
      var avg=kmVals.reduce(function(s,v){return s+v;},0)/kmVals.length;
      return Math.round(avg);
    }
  }
  return item.intervalKm;
}
function getEffectiveIntervalDays(item){
  return item.intervalDays; // could be personalized similarly in future
}

// Compute status: 'none'|'good'|'warn'|'danger'
function getStatus(item){
  var it=getItemData(item.id);
  if(!it.lastDate) return "none";

  var iKm=getEffectiveIntervalKm(item);
  var iDays=getEffectiveIntervalDays(item);
  var kmPct=null, dayPct=null;

  if(iKm!=null){
    var km=getKmSinceService(item.id);
    if(km!=null) kmPct=km/iKm;
  }
  if(iDays!=null){
    var days=getDaysSinceService(item.id);
    if(days!=null) dayPct=days/iDays;
  }

  // Take the worst of the two
  var pct=null;
  if(kmPct!=null && dayPct!=null) pct=Math.max(kmPct,dayPct);
  else if(kmPct!=null) pct=kmPct;
  else if(dayPct!=null) pct=dayPct;

  if(pct===null) return "good";
  if(pct>=1.0)   return "danger";
  if(pct>=0.8)   return "warn";
  return "good";
}

// Build insight string for an item
function buildInsight(item){
  var it=getItemData(item.id);
  if(!it.lastDate) return null;

  var iKm=getEffectiveIntervalKm(item);
  var iDays=getEffectiveIntervalDays(item);
  var lines=[];

  // Km insight
  if(iKm!=null){
    var km=getKmSinceService(item.id);
    if(km!=null){
      var rem=iKm-km;
      if(rem>0){
        // Estimate days remaining based on avg weekly km
        var totalKm=getActiveBikeTotalKm();
        var days=getDaysSinceService(item.id)||1;
        var avgDailyKm=days>0 ? km/days : 0;
        var daysEst=avgDailyKm>0 ? Math.ceil(rem/avgDailyKm) : null;
        var estStr=daysEst ? " (~"+daysEst+" day"+(daysEst!==1?"s":"")+")" : "";
        lines.push(km+" / "+iKm+" km used"+estStr);
      } else {
        lines.push("Overdue by "+(Math.abs(rem))+" km â€” service needed");
      }
      // Personalized interval note
      var history=(it.history||[]);
      if(history.length>=2 && iKm!==item.intervalKm){
        lines.push("Personalized interval: "+iKm+" km (based on your history)");
      }
    }
  }

  // Days insight
  if(iDays!=null){
    var days=getDaysSinceService(item.id);
    if(days!=null){
      var remDays=iDays-days;
      if(remDays>0){
        lines.push(days+" / "+iDays+" days used (~"+remDays+" days left)");
      } else {
        lines.push("Overdue by "+Math.abs(remDays)+" days â€” replace battery/service");
      }
    }
  }

  return lines.length ? lines.join(" Â· ") : null;
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  // Bike tabs
  renderBikeTabs();
  // Bike total km
  var totalKm=getActiveBikeTotalKm();
  document.getElementById("bikeTotalKm").textContent=totalKm>0?(totalKm.toLocaleString()+" km total"):"â€”";
  // Last sync
  document.getElementById("lastSyncLabel").textContent=
    lastSyncTs ? "Synced "+timeSince(lastSyncTs) : "Never synced";
  // Dashboard
  renderDashboard();
}

function timeSince(isoStr){
  var mins=Math.round((Date.now()-new Date(isoStr).getTime())/60000);
  if(mins<2) return "just now";
  if(mins<60) return mins+"m ago";
  var hrs=Math.floor(mins/60);
  if(hrs<24) return hrs+"h ago";
  return Math.floor(hrs/24)+"d ago";
}

function renderBikeTabs(){
  var el=document.getElementById("bikeTabs");
  var wrap=document.getElementById("bikeTabsWrap");
  if(!bikes||bikes.length<=1){ el.innerHTML=""; return; }
  el.innerHTML=bikes.map(function(b){
    var act=b.id===activeBikeId?" active":"";
    var km=b.totalKm>0?'<span class="bkm">'+b.totalKm.toLocaleString()+' km</span>':'';
    return '<button class="bike-tab'+act+'" onclick="switchBike(\''+esc(b.id)+'\')">'+esc(b.name)+km+'</button>';
  }).join("");
}

function renderDashboard(){
  var el=document.getElementById("dashboard");
  var html="";
  CATEGORIES.forEach(function(cat){
    var items=ITEMS.filter(function(it){return it.category===cat;});
    html+='<div class="category">';
    html+='<div class="cat-label">'+esc(cat)+'</div>';
    items.forEach(function(item){ html+=renderItemCard(item); });
    html+='</div>';
  });
  el.innerHTML=html;
}

function renderItemCard(item){
  var it=getItemData(item.id);
  var status=getStatus(item);
  var iKm=getEffectiveIntervalKm(item);
  var insight=buildInsight(item);
  var km=getKmSinceService(item.id);
  var days=getDaysSinceService(item.id);

  // Card class
  var cardClass="item-card";
  if(status==="warn") cardClass+=" status-warn";
  if(status==="danger") cardClass+=" status-danger";

  // Badge
  var badgeClass="item-status status-none-badge";
  var badgeText="Not Set";
  if(status==="good"){   badgeClass="item-status status-good-badge"; badgeText="Good"; }
  if(status==="warn"){   badgeClass="item-status status-warn-badge";  badgeText="Due Soon"; }
  if(status==="danger"){ badgeClass="item-status status-danger-badge";badgeText="Overdue!"; }

  // Meta line
  var metaParts=[];
  if(it.lastDate) metaParts.push("Last: "+fmtDateShort(it.lastDate));
  if(km!=null) metaParts.push(km.toLocaleString()+" km ridden");
  else if(days!=null && !iKm) metaParts.push(days+" days ago");
  var meta=metaParts.length ? metaParts.join(" Â· ") : "Tap 'Log Service' to start tracking";

  // Progress bar
  var barHtml="";
  var pct=null;
  if(it.lastDate && iKm!=null && km!=null){ pct=Math.min(100,Math.round((km/iKm)*100)); }
  else if(it.lastDate && item.intervalDays!=null && days!=null){ pct=Math.min(100,Math.round((days/item.intervalDays)*100)); }

  if(pct!==null){
    var barClass=pct>=100?"bar-danger":pct>=80?"bar-warn":"bar-good";
    var leftLabel=iKm!=null?(km+" km"):(days+" days");
    var rightLabel=iKm!=null?(iKm+" km interval"):( item.intervalDays+" days interval");
    barHtml=`
      <div class="item-bar-wrap">
        <div class="item-bar-bg"><div class="item-bar-fill ${barClass}" style="width:${pct}%"></div></div>
        <div class="item-bar-labels"><span>${leftLabel}</span><span>${rightLabel}</span></div>
      </div>`;
  }

  // Insight line
  var insightHtml="";
  if(insight){
    var iClass=status==="danger"?"insight-danger":status==="warn"?"insight-warn":"insight-good";
    if(!it.lastDate) iClass="";
    insightHtml='<div class="item-insight"><span class="'+iClass+'">'+esc(insight)+'</span></div>';
  }

  // History count
  var histCount=(it.history||[]).length;
  var histLabel="History"+(histCount>0?" ("+histCount+")":"");

  return `
    <div class="${cardClass}">
      <div class="item-top">
        <div class="item-emoji">${item.emoji}</div>
        <div class="item-info">
          <div class="item-name">${esc(item.name)}</div>
          <div class="item-meta">${esc(meta)}</div>
        </div>
        <div class="${badgeClass}">${badgeText}</div>
      </div>
      ${barHtml}
      ${insightHtml}
      <div class="item-actions">
        <button class="btn-log" onclick="openLogModal('${item.id}')">âœ“ Log Service</button>
        <button class="btn-history" onclick="openHistoryModal('${item.id}')">${esc(histLabel)}</button>
      </div>
    </div>`;
}

// â”€â”€ Log Service Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLogModal(itemId){
  _logItemId = itemId;
  var item = ITEMS.find(function(x){ return x.id === itemId; });
  var it   = getItemData(itemId);
  var km   = getKmSinceService(itemId);

  document.getElementById("logModalTitle").textContent = "Log Service: " + item.name;
  document.getElementById("logDate").value = todayStr();
  document.getElementById("logNote").value = "";

  // Summary
  var rows = "";
  if (it.lastDate) rows += '<div class="row"><span class="label">Last service</span><span class="val">' + fmtDate(it.lastDate) + '</span></div>';
  if (km != null)  rows += '<div class="row"><span class="label">Km ridden since</span><span class="val accent">' + km.toLocaleString() + ' km</span></div>';
  else rows += '<div class="row"><span class="label">Status</span><span class="val" style="color:var(--text-muted)">First service record â€” km will be fetched from Strava</span></div>';
  rows += '<div class="row"><span class="label">Bike total km</span><span class="val">' + getActiveBikeTotalKm().toLocaleString() + ' km</span></div>';
  document.getElementById("logSummary").innerHTML = rows;

  // Always hide the manual km input â€” we fetch from Strava now
  document.getElementById("logKmFieldWrap").style.display = "none";

  document.getElementById("logModal").classList.remove("hidden");
}

function confirmLogService(){
  var itemId=_logItemId;
  var item=ITEMS.find(function(x){return x.id===itemId;});
  var it=getItemData(itemId);
  var serviceDate=document.getElementById("logDate").value;
  var kmPre=parseInt(document.getElementById("logKmPre").value)||0;
  var note=document.getElementById("logNote").value.trim();

  if(!serviceDate){ toast("Please select a date","err"); return; }

  var totalKm=getActiveBikeTotalKm();
  var kmAtService=totalKm; // current bike total at time of recording
  var kmRidden=null;

  if(it.lastDate && it.lastKmTotal!=null){
    kmRidden=Math.max(0, totalKm - it.lastKmTotal);
  }

  // Record to history
  if(it.lastDate){
    if(!it.history) it.history=[];
    it.history.unshift({
      date:serviceDate,
      kmAtService:kmAtService,
      kmRidden:kmRidden,
      note:note,
    });
  }

  // Update item state â€” lastKmTotal adjusted by kmPre for first-time setup
  it.lastDate=serviceDate;
  it.lastKmTotal=kmAtService - kmPre;
  if(!it.history) it.history=[];

  // If this is the very first service record, add one history entry too
  if(it.history.length===0){
    it.history.unshift({ date:serviceDate, kmAtService:kmAtService, kmRidden:0, note:note });
  }

  closeModalId("logModal");
  saveAll();
  toast(item.name+" service recorded!","ok");
  render();
}

// â”€â”€ History Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openHistoryModal(itemId){
  var item=ITEMS.find(function(x){return x.id===itemId;});
  var it=getItemData(itemId);
  var history=it.history||[];

  document.getElementById("historyModalTitle").textContent=item.name+" History";

  // AI analysis
  var aiBox=document.getElementById("historyAI");
  if(history.length>=2){
    var kmVals=history.map(function(h){return h.kmRidden;}).filter(function(v){return v!=null&&v>0;});
    if(kmVals.length>=2){
      var avg=Math.round(kmVals.reduce(function(s,v){return s+v;},0)/kmVals.length);
      var min=Math.min.apply(null,kmVals);
      var max=Math.max.apply(null,kmVals);
      var defaultInterval=item.intervalKm||item.intervalDays;
      var insight="Based on "+kmVals.length+" services, you typically service this every <strong style='color:var(--accent)'>"+avg+" km</strong> (range: "+min+"â€“"+max+" km).";
      if(item.intervalKm){
        if(avg<item.intervalKm) insight+=" Your pattern suggests you could extend to "+item.intervalKm+" km.";
        else insight+=" You're using the full recommended interval well.";
      }
      insight+=" Dashboard intervals are now personalized to your pattern.";
      aiBox.innerHTML="<strong>ğŸ¤– AI Trend Analysis</strong>"+insight;
      aiBox.classList.remove("hidden");
    } else { aiBox.classList.add("hidden"); }
  } else { aiBox.classList.add("hidden"); }

  // History list
  var listEl=document.getElementById("historyList");
  if(history.length===0){
    listEl.innerHTML='<div class="history-empty">No service history yet.<br>Log a service to start building history.</div>';
  } else {
    listEl.innerHTML=history.map(function(h,idx){
      var kmStr=h.kmRidden!=null ? h.kmRidden.toLocaleString()+" km since previous service" : "First service record";
      var tag=idx===0?'<span class="history-tag">Latest</span>':'';
      return '<div class="history-item">'+
        '<div>'+
          '<div class="history-date">'+fmtDate(h.date)+' '+tag+'</div>'+
          '<div class="history-km">'+kmStr+'</div>'+
          (h.note?'<div class="history-note">'+esc(h.note)+'</div>':'')+
        '</div>'+
      '</div>';
    }).join("");
  }

  document.getElementById("historyModal").classList.remove("hidden");
}

// â”€â”€ Modal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeModal(e,id){ if(e.target===document.getElementById(id)) closeModalId(id); }
function closeModalId(id){ document.getElementById(id).classList.add("hidden"); }

// â”€â”€ Bike switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchBike(id){
  activeBikeId=id;
  render();
}

// â”€â”€ Strava auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectStrava(){
  localStorage.setItem("chainwax_client_id",     STRAVA_CLIENT_ID);
  localStorage.setItem("chainwax_client_secret",  STRAVA_CLIENT_SECRET);
  localStorage.setItem("strava_return_to",        "/bike-maintenance.html");  // â† tells callback where to return
  window.location.href="https://www.strava.com/oauth/authorize?client_id="+STRAVA_CLIENT_ID+
    "&response_type=code&redirect_uri="+encodeURIComponent(CALLBACK)+
    "&approval_prompt=auto&scope=activity:read_all";
}

function logout(){
  if(!confirm("Logout? Local session cleared.")) return;
  localStorage.removeItem("chainwax_session_maint");
  athlete=null; strava=null; binId=null;
  bikes=[]; activeBikeId=null; bikeData={}; lastSyncTs=null;
  document.getElementById("loginScreen").classList.remove("hidden");
  document.getElementById("mainApp").classList.add("hidden");
}

// â”€â”€ Token refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getToken(){
  if(!strava) return null;
  var now=Math.floor(Date.now()/1000);
  if(now < strava.expiresAt-60) return strava.accessToken;
  try{
    var resp=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"token",client_id:STRAVA_CLIENT_ID,client_secret:STRAVA_CLIENT_SECRET,
        refresh_token:strava.refreshToken,grant_type:"refresh_token"})});
    var d=await resp.json();
    if(d.access_token){
      strava.accessToken=d.access_token; strava.refreshToken=d.refresh_token; strava.expiresAt=d.expires_at;
      saveLocal(); return d.access_token;
    }
  }catch(e){ console.error("Token refresh failed:",e); }
  return null;
}

// â”€â”€ Sync Strava â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Key difference from chain-wax.html:
// We use the gear endpoint (total lifetime km) rather than summing rides.
// km since service = currentBikeTotal - item.lastKmTotal
async function syncStrava(){
  if(!strava){ toast("Not connected","err"); return; }
  var btn=document.getElementById("btnSync");
  btn.disabled=true; btn.innerHTML='<span class="spin-inline">â†»</span> Syncing...';
  try{
    var token=await getToken();
    if(!token) throw new Error("Session expired â€” please reconnect Strava.");

    // Fetch athlete's gear list from activities to discover bikes
    var gearIds=[];
    var pg=1, allActs=[];
    // Fetch up to 3 pages of recent activities to find gear IDs
    while(pg<=3){
      var r=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({action:"activities",access_token:token,after:0,page:pg})});
      var acts=await r.json();
      if(!Array.isArray(acts)||acts.length===0) break;
      acts.forEach(function(a){ if(a.gear_id&&gearIds.indexOf(a.gear_id)===-1) gearIds.push(a.gear_id); });
      allActs=allActs.concat(acts); pg++;
    }

    if(!gearIds.length){
      toast("No bikes found in your recent Strava activities","info");
      btn.disabled=false; btn.innerHTML="â†» Sync Strava"; return;
    }

    // Fetch each gear's data (name + total lifetime km)
    var fetched=[];
    for(var i=0;i<gearIds.length;i++){
      try{
        var gr=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({action:"gear",gear_id:gearIds[i],access_token:token})});
        var gd=await gr.json();
        if(gd&&gd.id) fetched.push(gd);
      }catch(ge){ console.error("gear fetch:",ge); }
    }

    bikes=fetched.map(function(b){
      return{ id:b.id, name:b.nickname||b.name||"Bike", totalKm:Math.round((b.distance||0)/1000) };
    });

    // Ensure activeBikeId is valid
    if(!activeBikeId||!bikes.find(function(b){return b.id===activeBikeId;})){
      activeBikeId=bikes.length ? bikes[0].id : null;
    }

    lastSyncTs=new Date().toISOString();
    await saveAll();
    toast("Synced "+bikes.length+" bike"+(bikes.length!==1?"s":"")+"!","ok");
  }catch(e){ toast("Sync failed: "+e.message,"err"); }
  btn.disabled=false; btn.innerHTML="â†» Sync Strava";
  render();
}

// â”€â”€ Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveToCloud(){
  if(!athlete) return;
  var payload={ athlete,strava,bikes,activeBikeId,bikeData,lastSyncTs };
  try{
    var r=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"save",bin_id:binId,athlete_id:athlete.id,data:payload})});
    var d=await r.json();
    if(d.bin_id&&!binId){
      binId=d.bin_id;
      localStorage.setItem("bikemaint_bin_"+athlete.id,binId);
    }
  }catch(e){ console.error("Cloud save failed:",e); }
}

async function loadFromCloud(aid,bid){
  try{
    var r=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"load",bin_id:bid,athlete_id:aid})});
    var d=await r.json();
    if(d.data){
      var s=d.data;
      if(s.athlete)      athlete=s.athlete;
      if(s.strava)       strava=s.strava;
      if(s.bikes)        bikes=s.bikes;
      if(s.activeBikeId) activeBikeId=s.activeBikeId;
      if(s.bikeData)     bikeData=s.bikeData;
      if(s.lastSyncTs)   lastSyncTs=s.lastSyncTs;
      return true;
    }
  }catch(e){ console.error("Cloud load failed:",e); }
  return false;
}

function saveLocal(){
  try{
    localStorage.setItem("bikemaint_session",JSON.stringify({
      athlete,strava,binId,bikes,activeBikeId,bikeData,lastSyncTs
    }));
  }catch(e){}
}

function loadLocal(){
  try{
    var s=localStorage.getItem("bikemaint_session");
    if(s){
      var d=JSON.parse(s);
      athlete=d.athlete||null; strava=d.strava||null; binId=d.binId||null;
      bikes=d.bikes||[]; activeBikeId=d.activeBikeId||null;
      bikeData=d.bikeData||{}; lastSyncTs=d.lastSyncTs||null;
      return !!athlete;
    }
  }catch(e){}
  return false;
}

async function saveAll(){ saveLocal(); await saveToCloud(); }

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function(){
  var loadEl=document.getElementById("loadingScreen");
  var loginEl=document.getElementById("loginScreen");
  var appEl=document.getElementById("mainApp");

  function showApp(){
    loginEl.classList.add("hidden"); appEl.classList.remove("hidden");
    document.getElementById("athleteName").textContent=
      athlete ? (athlete.firstname||"")+" "+(athlete.lastname||"") : "";
    render();
  }

// â”€â”€ Check for Strava callback token â”€â”€
  var stravaRaw=localStorage.getItem("chainwax_strava");
  if(stravaRaw){
    try{
      var sd=JSON.parse(stravaRaw);
      var accessToken  = sd.accessToken  || sd.access_token;
      var refreshToken = sd.refreshToken || sd.refresh_token;
      var expiresAt    = sd.expiresAt    || sd.expires_at;
      var sdAthlete    = sd.athlete;
      console.log("[bike-maint] token found:", !!accessToken, "athlete:", !!sdAthlete);
      if(accessToken){
        if(sdAthlete) athlete=sdAthlete;
        strava={accessToken:accessToken,refreshToken:refreshToken,expiresAt:expiresAt};
        localStorage.removeItem("chainwax_strava");
        if(!athlete){
          try{
            var ar=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
              body:JSON.stringify({action:"athlete",access_token:accessToken})});
            var ad=await ar.json();
            if(ad&&ad.id) athlete=ad;
          }catch(ae){ console.error("Athlete fetch failed:",ae); }
        }
        if(!athlete){ athlete={id:"unknown",firstname:"Strava",lastname:"User"}; }
        var existingBin=localStorage.getItem("bikemaint_bin_"+athlete.id)||
                        localStorage.getItem("chainwax_bin_"+athlete.id);
        if(existingBin){ binId=existingBin; await loadFromCloud(athlete.id,binId); }
        await syncStrava();
        loadEl.style.display="none";
        appEl.classList.remove("hidden"); loginEl.classList.add("hidden");
        document.getElementById("athleteName").textContent=(athlete.firstname||"")+" "+(athlete.lastname||"");
        render(); return;
      }
    }catch(e){ console.error("OAuth callback parse error:",e); }
  }

  // â”€â”€ Restore from localStorage â”€â”€
  if(loadLocal()&&athlete){
    if(binId) await loadFromCloud(athlete.id,binId);
    if(!activeBikeId&&bikes.length) activeBikeId=bikes[0].id;
    loadEl.style.display="none";
    showApp(); return;
  }

  // â”€â”€ Not authenticated â”€â”€
  loadEl.style.display="none";
  loginEl.classList.remove("hidden");
})();
</script>
</body>
</html>
