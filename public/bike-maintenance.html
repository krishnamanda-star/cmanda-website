<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Bike Maintenance</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0f0f12; --bg2:#17171d; --card:#1e1e26; --border:#2a2a38; --border-l:#3a3a50;
  --accent:#f0a030; --accent-dim:#c88020; --accent-glow:rgba(240,160,48,0.15);
  --danger:#ff5555; --danger-glow:rgba(255,85,85,0.15);
  --warn:#f5a623; --warn-glow:rgba(245,166,35,0.15);
  --success:#3ddc84; --success-glow:rgba(61,220,132,0.15);
  --text:#f0f0f8; --text-dim:#a0a0b8; --text-muted:#606078;
  --strava:#fc4c02;
  --good:#3ddc84; --warn-c:#f5a623; --danger-c:#ff5555;
  --ff-display:'Sora',sans-serif; --ff-mono:'DM Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:16px}
body{min-height:100vh;background:var(--bg);color:var(--text);font-family:var(--ff-display);-webkit-font-smoothing:antialiased;overscroll-behavior:none}
.app{max-width:640px;margin:0 auto;padding:0 0 100px}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header{padding:16px 20px 14px;background:var(--bg2);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;backdrop-filter:blur(12px)}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.header-left{display:flex;align-items:center;gap:12px}
.logo{width:38px;height:38px;background:linear-gradient(135deg,var(--accent),var(--accent-dim));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.app-title{font-size:17px;font-weight:700;letter-spacing:-0.3px;color:var(--text)}
.app-sub{font-family:var(--ff-mono);font-size:11px;color:var(--text-dim);margin-top:1px}
.header-actions{display:flex;align-items:center;gap:8px}
.badge-strava{font-family:var(--ff-mono);font-size:10px;padding:3px 8px;border-radius:20px;background:rgba(252,76,2,0.2);color:#ff7744;border:1px solid rgba(252,76,2,0.35);font-weight:500}
.btn-logout{background:none;border:1px solid var(--border-l);color:var(--text-dim);font-family:var(--ff-mono);font-size:10px;padding:4px 10px;border-radius:6px;cursor:pointer;transition:all 0.2s}
.btn-logout:hover{color:var(--danger-c);border-color:rgba(255,85,85,0.5)}

/* ‚îÄ‚îÄ Bike tabs ‚îÄ‚îÄ */
.bike-tabs{display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px}
.bike-tabs::-webkit-scrollbar{display:none}
.bike-tab{flex-shrink:0;padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-family:var(--ff-mono);font-size:11px;cursor:pointer;transition:all 0.2s;white-space:nowrap}
.bike-tab.active{background:var(--accent-glow);border-color:rgba(240,160,48,0.5);color:var(--accent);font-weight:600}
.bike-tab .bkm{font-size:10px;opacity:0.75;margin-left:4px}
.bike-total-bar{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
.bike-total-val{font-family:var(--ff-mono);font-size:13px;color:var(--accent);font-weight:600}
.last-sync{font-family:var(--ff-mono);font-size:10px;color:var(--text-muted)}

/* ‚îÄ‚îÄ Bike info card ‚îÄ‚îÄ */
.bike-info-card{margin:14px 20px 0;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:14px}
.bike-icon{font-size:28px;flex-shrink:0}
.bike-details{flex:1}
.bike-details-name{font-size:15px;font-weight:700;color:var(--text);letter-spacing:-0.2px}
.bike-details-brand{font-family:var(--ff-mono);font-size:11px;color:var(--text-dim);margin-top:2px}
.bike-details-stats{display:flex;gap:16px;margin-top:8px}
.bike-stat{text-align:center}
.bike-stat-val{font-family:var(--ff-mono);font-size:14px;font-weight:600;color:var(--accent)}
.bike-stat-label{font-family:var(--ff-mono);font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-top:1px}

/* ‚îÄ‚îÄ Sync bar ‚îÄ‚îÄ */
.sync-bar{padding:12px 20px;display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--border)}
.btn-sync{flex:1;padding:11px 16px;background:var(--strava);color:#fff;border:none;border-radius:10px;font-family:var(--ff-mono);font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:background 0.2s}
.btn-sync:hover:not(:disabled){background:#e04400}
.btn-sync:disabled{opacity:0.5;cursor:not-allowed}
.btn-debug{padding:11px 14px;background:var(--card);border:1px solid var(--border-l);color:var(--text-dim);border-radius:10px;cursor:pointer;font-size:14px;transition:all 0.2s;flex-shrink:0}
.btn-debug:hover{border-color:var(--accent);color:var(--accent)}
.debug-panel{margin:0;border-bottom:1px solid var(--border);background:#0a0a10}
.debug-header{display:flex;justify-content:space-between;align-items:center;padding:8px 16px 4px;font-family:var(--ff-mono);font-size:10px;color:var(--text-muted);border-bottom:1px solid var(--border)}
.debug-log{padding:8px 16px 12px;font-family:var(--ff-mono);font-size:10px;color:#7aff7a;max-height:240px;overflow-y:auto;line-height:1.7;white-space:pre-wrap;word-break:break-all}
.debug-log .err{color:#ff7a7a}
.debug-log .warn{color:#ffbb44}
.debug-log .label{color:#7ad4ff;font-weight:600}

/* ‚îÄ‚îÄ Categories ‚îÄ‚îÄ */
.category{padding:20px 20px 0}
.cat-label{font-family:var(--ff-mono);font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.8px;color:var(--text-dim);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.cat-label::after{content:'';flex:1;height:1px;background:var(--border)}

/* ‚îÄ‚îÄ Item card ‚îÄ‚îÄ */
.item-card{background:var(--card);border:1px solid var(--border);border-radius:14px;margin-bottom:10px;overflow:hidden;transition:border-color 0.2s}
.item-card:hover{border-color:var(--border-l)}
.item-card.status-warn{border-left:3px solid var(--warn-c)}
.item-card.status-danger{border-left:3px solid var(--danger-c);animation:pulseCard 3s infinite}
@keyframes pulseCard{0%,100%{box-shadow:none}50%{box-shadow:0 0 0 2px rgba(255,85,85,0.12)}}
.item-top{display:flex;align-items:flex-start;padding:14px 16px 10px;gap:12px}
.item-emoji{font-size:22px;line-height:1;flex-shrink:0;margin-top:1px}
.item-info{flex:1;min-width:0}
.item-name{font-size:14px;font-weight:600;letter-spacing:-0.2px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item-meta{font-family:var(--ff-mono);font-size:10px;color:var(--text-dim);margin-top:3px;line-height:1.5}
.item-status{flex-shrink:0;font-family:var(--ff-mono);font-size:9px;font-weight:700;padding:3px 9px;border-radius:10px;text-transform:uppercase;letter-spacing:0.6px;align-self:flex-start}
.status-good-badge{background:var(--success-glow);color:var(--good);border:1px solid rgba(61,220,132,0.3)}
.status-warn-badge{background:var(--warn-glow);color:var(--warn-c);border:1px solid rgba(245,166,35,0.3)}
.status-danger-badge{background:var(--danger-glow);color:var(--danger-c);border:1px solid rgba(255,85,85,0.3)}
.status-none-badge{background:rgba(255,255,255,0.06);color:var(--text-dim);border:1px solid var(--border)}

/* ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ */
.item-bar-wrap{padding:0 16px 10px}
.item-bar-bg{height:5px;background:var(--border);border-radius:99px;overflow:hidden}
.item-bar-fill{height:100%;border-radius:99px;transition:width 0.8s cubic-bezier(0.4,0,0.2,1)}
.bar-good{background:var(--good)}
.bar-warn{background:var(--warn-c)}
.bar-danger{background:var(--danger-c)}
.item-bar-labels{display:flex;justify-content:space-between;margin-top:5px;font-family:var(--ff-mono);font-size:9px;color:var(--text-dim)}

/* ‚îÄ‚îÄ Insight ‚îÄ‚îÄ */
.item-insight{padding:0 16px 10px;font-family:var(--ff-mono);font-size:10px;color:var(--text-dim);line-height:1.5}
.insight-good{color:var(--good)}
.insight-warn{color:var(--warn-c)}
.insight-danger{color:var(--danger-c)}

/* ‚îÄ‚îÄ Actions ‚îÄ‚îÄ */
.item-actions{display:flex;padding:10px 16px 14px;gap:8px;border-top:1px solid var(--border)}
.btn-new-service{flex:1;padding:9px;background:var(--accent);color:#0f0f12;border:none;border-radius:8px;font-family:var(--ff-mono);font-size:11px;font-weight:700;cursor:pointer;transition:background 0.2s}
.btn-new-service:hover{background:var(--accent-dim)}
.btn-edit-service{padding:9px 13px;background:var(--bg);border:1px solid var(--border-l);color:var(--text-dim);border-radius:8px;font-family:var(--ff-mono);font-size:11px;cursor:pointer;transition:all 0.2s}
.btn-edit-service:hover{border-color:var(--accent);color:var(--accent)}
.btn-history{padding:9px 13px;background:var(--bg);border:1px solid var(--border);color:var(--text-dim);border-radius:8px;font-family:var(--ff-mono);font-size:11px;cursor:pointer;transition:all 0.2s}
.btn-history:hover{border-color:var(--border-l);color:var(--text)}

/* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.login-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:40px 32px;max-width:380px;width:100%;text-align:center}
.login-icon{font-size:52px;margin-bottom:20px}
.login-title{font-size:22px;font-weight:700;margin-bottom:10px;color:var(--text)}
.login-desc{color:var(--text-dim);font-size:14px;line-height:1.6;margin-bottom:28px}
.btn-strava-big{width:100%;padding:14px;background:var(--strava);color:#fff;border:none;border-radius:12px;font-family:var(--ff-mono);font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:background 0.2s}
.btn-strava-big:hover{background:#e04400}

/* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:100;display:flex;align-items:flex-end;justify-content:center;animation:fadeOverlay 0.2s ease}
@keyframes fadeOverlay{from{opacity:0}to{opacity:1}}
.modal-sheet{background:var(--bg2);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:640px;padding:0 0 env(safe-area-inset-bottom,20px);animation:slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1);max-height:90vh;display:flex;flex-direction:column}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--border-l);border-radius:99px;margin:12px auto 0;flex-shrink:0}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px 12px;flex-shrink:0;border-bottom:1px solid var(--border)}
.modal-title{font-size:16px;font-weight:700;color:var(--text)}
.modal-close{background:none;border:none;color:var(--text-dim);font-size:24px;cursor:pointer;line-height:1;padding:0 4px;transition:color 0.2s}
.modal-close:hover{color:var(--text)}
.modal-body{padding:16px 20px 20px;overflow-y:auto}
.form-group{margin-bottom:16px}
.form-label{display:block;font-family:var(--ff-mono);font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:8px;font-weight:500}
.form-input{width:100%;padding:11px 14px;background:var(--bg);border:1px solid var(--border-l);border-radius:10px;color:var(--text);font-family:var(--ff-mono);font-size:13px;outline:none;transition:border-color 0.2s}
.form-input:focus{border-color:var(--accent)}
.modal-summary{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:16px}
.modal-summary .row{display:flex;justify-content:space-between;font-family:var(--ff-mono);font-size:12px;padding:4px 0;border-bottom:1px solid var(--border)}
.modal-summary .row:last-child{border-bottom:none}
.modal-summary .row .lbl{color:var(--text-dim)}
.modal-summary .row .val{color:var(--text);font-weight:500}
.modal-summary .row .val.accent{color:var(--accent)}
.btn-confirm{width:100%;padding:13px;background:var(--accent);color:#0f0f12;border:none;border-radius:10px;font-family:var(--ff-mono);font-size:13px;font-weight:700;cursor:pointer;transition:background 0.2s;margin-top:4px}
.btn-confirm:hover:not(:disabled){background:var(--accent-dim)}
.btn-confirm:disabled{opacity:0.5;cursor:not-allowed}
.mode-tabs{display:flex;gap:6px;margin-bottom:16px}
.mode-tab{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-family:var(--ff-mono);font-size:11px;cursor:pointer;transition:all 0.2s;font-weight:500}
.mode-tab.active{background:var(--accent-glow);border-color:rgba(240,160,48,0.4);color:var(--accent)}

/* ‚îÄ‚îÄ History list ‚îÄ‚îÄ */
.history-list{max-height:50vh;overflow-y:auto}
.history-item{padding:12px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.history-item:last-child{border-bottom:none}
.history-item-left{flex:1}
.history-date{font-family:var(--ff-mono);font-size:12px;font-weight:600;color:var(--text)}
.history-km{font-family:var(--ff-mono);font-size:11px;color:var(--accent);margin-top:3px}
.history-note{font-family:var(--ff-mono);font-size:10px;color:var(--text-dim);margin-top:2px;font-style:italic}
.history-tag{font-family:var(--ff-mono);font-size:9px;padding:2px 7px;border-radius:10px;background:var(--success-glow);color:var(--good);border:1px solid rgba(61,220,132,0.25);margin-left:6px;font-weight:600}
.history-del{background:none;border:1px solid var(--border);color:var(--text-muted);font-size:14px;width:28px;height:28px;border-radius:6px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.history-del:hover{border-color:rgba(255,85,85,0.5);color:var(--danger-c);background:var(--danger-glow)}
.history-ai-box{background:var(--accent-glow);border:1px solid rgba(240,160,48,0.2);border-radius:10px;padding:12px 14px;margin-bottom:14px;font-family:var(--ff-mono);font-size:11px;color:var(--text-dim);line-height:1.7}
.history-ai-box strong{color:var(--accent);display:block;margin-bottom:6px;font-size:12px}
.history-empty{padding:28px 0;text-align:center;font-family:var(--ff-mono);font-size:11px;color:var(--text-muted)}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:200;padding:11px 20px;border-radius:10px;font-family:var(--ff-mono);font-size:12px;box-shadow:0 8px 32px rgba(0,0,0,0.6);animation:toastIn 0.3s ease;white-space:nowrap;font-weight:500}
.toast-ok{background:#1a3d2a;color:var(--good);border:1px solid rgba(61,220,132,0.3)}
.toast-err{background:#3d1a1a;color:var(--danger-c);border:1px solid rgba(255,85,85,0.3)}
.toast-info{background:#2d2510;color:var(--accent);border:1px solid rgba(240,160,48,0.3)}
@keyframes toastIn{from{transform:translateX(-50%) translateY(-10px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}

/* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
.loading-overlay{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:999;font-family:var(--ff-mono);color:var(--accent);font-size:13px;font-weight:500}
.spinner{width:22px;height:22px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.hidden{display:none!important}
.spin-inline{display:inline-block;animation:spin 0.8s linear infinite;margin-right:6px}
.section-note{font-family:var(--ff-mono);font-size:10px;color:var(--text-muted);padding:4px 20px 0;line-height:1.5}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingScreen"><div class="spinner"></div>Loading...</div>

<div id="loginScreen" class="hidden">
  <div class="login-wrap">
    <div class="login-card">
      <div class="login-icon">üö¥</div>
      <div class="login-title">Bike Maintenance</div>
      <div class="login-desc">Connect your Strava account to automatically track maintenance across all your bikes with km-based service intervals.</div>
      <button class="btn-strava-big" onclick="connectStrava()"><span style="font-size:18px">‚ö°</span> Connect with Strava</button>
    </div>
  </div>
</div>

<div id="mainApp" class="hidden">
  <div class="app">
    <div class="header">
      <div class="header-top">
        <div class="header-left">
          <div class="logo">üîß</div>
          <div>
            <div class="app-title">Bike Maintenance</div>
            <div class="app-sub" id="athleteName">Loading...</div>
          </div>
        </div>
        <div class="header-actions">
          <div class="badge-strava">‚óè Strava</div>
          <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
      </div>
      <div id="bikeTabsWrap">
        <div class="bike-tabs" id="bikeTabs"></div>
        <div class="bike-total-bar">
          <div class="bike-total-val" id="bikeTotalKm">‚Äî km total</div>
          <div class="last-sync" id="lastSyncLabel">Never synced</div>
        </div>
      </div>
    </div>
    <div id="bikeInfoCard"></div>
    <div class="sync-bar">
      <button class="btn-sync" id="btnSync" onclick="syncStrava()">‚Üª Sync Strava</button>
      <button class="btn-debug" id="btnDebug" onclick="toggleDebug()" title="Debug API responses">üîç</button>
    </div>
    <div id="debugPanel" class="debug-panel hidden">
      <div class="debug-header">
        <span>API Debug Output</span>
        <button onclick="clearDebug()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-family:var(--ff-mono);font-size:10px;">Clear</button>
      </div>
      <div id="debugLog" class="debug-log"></div>
    </div>
    <div id="dashboard"></div>
  </div>
</div>

<!-- ‚ïê‚ïê LOG / EDIT SERVICE MODAL ‚ïê‚ïê -->
<div class="modal-overlay hidden" id="logModal" onclick="closeModal(event,'logModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="logModalTitle">Log Service</div>
      <button class="modal-close" onclick="closeModalId('logModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="mode-tabs" id="logModeTabs">
        <button class="mode-tab active" id="modeTabNew" onclick="switchLogMode('new')">Ôºã New Service</button>
        <button class="mode-tab" id="modeTabEdit" onclick="switchLogMode('edit')">‚úé Edit Last Service</button>
      </div>
      <div class="modal-summary" id="logSummary"></div>
      <div class="form-group">
        <label class="form-label" id="logDateLabel">Service Date</label>
        <input class="form-input" type="date" id="logDate">
      </div>
      <div class="form-group">
        <label class="form-label">Notes (optional)</label>
        <input class="form-input" type="text" id="logNote" placeholder="e.g. Molten Speed Wax, CR2032 battery...">
      </div>
      <button class="btn-confirm" id="btnConfirmLog" onclick="confirmLogService()">‚úì Record Service</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê HISTORY MODAL ‚ïê‚ïê -->
<div class="modal-overlay hidden" id="historyModal" onclick="closeModal(event,'historyModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="historyModalTitle">Service History</div>
      <button class="modal-close" onclick="closeModalId('historyModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div id="historyAI" class="history-ai-box hidden"></div>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>
</div>

<script>
var STRAVA_CLIENT_ID     = "202550";
var STRAVA_CLIENT_SECRET = "28a52c20e5aa595af90ed7477e8cd1443f00de5a";
var CALLBACK             = window.location.origin + "/strava-callback.html";

// intervalKm: km interval | intervalDays: day interval | both = whichever hits first
// batteryKm: estimated km per battery (for electronics tracked by km instead of days)
var ITEMS = [
  { id:"chain_wax",        name:"Chain Wax",                   emoji:"‚õìÔ∏è",  category:"Drivetrain",  intervalKm:400,   intervalDays:null, batteryKm:null  },
  { id:"di2_charge",       name:"Di2 Battery Charge",          emoji:"‚ö°",  category:"Drivetrain",  intervalKm:1200,  intervalDays:null, batteryKm:null  },
  { id:"bearings_hubs",    name:"Wheel Hub Bearings",          emoji:"üî©",  category:"Bearings",    intervalKm:15000, intervalDays:730,  batteryKm:null  },
  { id:"bearings_bb",      name:"Bottom Bracket Bearings",     emoji:"üî©",  category:"Bearings",    intervalKm:8000,  intervalDays:365,  batteryKm:null  },
  { id:"bearings_headset", name:"Headset Bearings",            emoji:"üî©",  category:"Bearings",    intervalKm:15000, intervalDays:730,  batteryKm:null  },
  { id:"wahoo_cadence",    name:"Wahoo Cadence Battery",       emoji:"üîã",  category:"Electronics", intervalKm:8000,  intervalDays:null, batteryKm:8000  },
  { id:"power_left",       name:"Left Crank Power Meter",      emoji:"üîã",  category:"Electronics", intervalKm:6000,  intervalDays:null, batteryKm:6000  },
  { id:"power_right",      name:"Right Crank Power Meter",     emoji:"üîã",  category:"Electronics", intervalKm:6000,  intervalDays:null, batteryKm:6000  },
  { id:"hrm",              name:"Heart Rate Monitor Battery",  emoji:"‚ù§Ô∏è",  category:"Electronics", intervalKm:null,  intervalDays:365,  batteryKm:null  },
  { id:"brake_pads",       name:"Brake Pads",                  emoji:"üõë",  category:"Wear Items",  intervalKm:3000,  intervalDays:null, batteryKm:null  },
  { id:"tires",            name:"Tires",                       emoji:"üö≤",  category:"Wear Items",  intervalKm:4000,  intervalDays:null, batteryKm:null  },
  { id:"overhaul",         name:"Full Overhaul",               emoji:"üîß",  category:"General",     intervalKm:12000, intervalDays:365,  batteryKm:null  },
];

var CATEGORIES = ["Drivetrain","Bearings","Electronics","Wear Items","General"];

var athlete      = null;
var strava       = null;
var binId        = null;
var bikes        = [];      // [{id, name, brand, model, totalKm, frameType}]
var activeBikeId = null;
var bikeData     = {};      // bikeData[bikeId].items[itemId] = {lastDate, lastKmTotal, history[]}
var lastSyncTs   = null;
var _logItemId   = null;
var _logMode     = "new";   // "new" | "edit"

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtDate(d){ if(!d) return "‚Äî"; return new Date(d+"T00:00:00").toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}); }
function fmtDateShort(d){ if(!d) return "‚Äî"; return new Date(d+"T00:00:00").toLocaleDateString("en-GB",{day:"numeric",month:"short"}); }
function todayStr(){ return new Date().toISOString().split("T")[0]; }
function daysSince(dateStr){ if(!dateStr) return null; return Math.max(0,Math.round((Date.now()-new Date(dateStr+"T00:00:00").getTime())/86400000)); }
function esc(s){ var d=document.createElement("div"); d.textContent=s; return d.innerHTML; }

function toast(msg,type){
  var el=document.createElement("div");
  el.className="toast toast-"+(type||"info");
  el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(function(){ el.style.opacity="0"; el.style.transition="opacity 0.4s"; setTimeout(function(){ el.remove(); },400); },3200);
}

function getActiveBikeData(){
  if(!activeBikeId) return {items:{}};
  if(!bikeData[activeBikeId]) bikeData[activeBikeId]={items:{}};
  return bikeData[activeBikeId];
}
function getItemData(itemId){
  var d=getActiveBikeData();
  if(!d.items) d.items={};
  if(!d.items[itemId]) d.items[itemId]={lastDate:null,lastKmTotal:null,history:[]};
  return d.items[itemId];
}
function getActiveBike(){ return bikes.find(function(x){ return x.id===activeBikeId; })||null; }
function getActiveBikeTotalKm(){ var b=getActiveBike(); return b?(b.totalKm||0):0; }

function getKmSinceService(itemId){
  var it=getItemData(itemId);
  if(!it.lastDate||it.lastKmTotal==null) return null;
  return Math.max(0,getActiveBikeTotalKm()-it.lastKmTotal);
}
function getDaysSinceService(itemId){
  var it=getItemData(itemId);
  if(!it.lastDate) return null;
  return daysSince(it.lastDate);
}
function getEffectiveIntervalKm(item){
  var it=getItemData(item.id);
  var history=it.history||[];
  if(history.length>=3){
    var kmVals=history.map(function(h){ return h.kmRidden||0; }).filter(function(v){ return v>50; });
    if(kmVals.length>=2){
      var avg=kmVals.reduce(function(s,v){ return s+v; },0)/kmVals.length;
      return Math.round(avg);
    }
  }
  return item.intervalKm;
}

function getStatus(item){
  var it=getItemData(item.id);
  if(!it.lastDate) return "none";
  var iKm=getEffectiveIntervalKm(item);
  var iDays=item.intervalDays;
  var kmPct=null, dayPct=null;
  if(iKm!=null){ var km=getKmSinceService(item.id); if(km!=null) kmPct=km/iKm; }
  if(iDays!=null){ var days=getDaysSinceService(item.id); if(days!=null) dayPct=days/iDays; }
  var pct=null;
  if(kmPct!=null&&dayPct!=null) pct=Math.max(kmPct,dayPct);
  else if(kmPct!=null) pct=kmPct;
  else if(dayPct!=null) pct=dayPct;
  if(pct===null) return "good";
  if(pct>=1.0)   return "danger";
  if(pct>=0.8)   return "warn";
  return "good";
}

function buildInsight(item){
  var it=getItemData(item.id);
  if(!it.lastDate) return null;
  var iKm=getEffectiveIntervalKm(item);
  var lines=[];
  if(iKm!=null){
    var km=getKmSinceService(item.id);
    if(km!=null){
      var rem=iKm-km;
      if(rem>0){
        var days=getDaysSinceService(item.id)||1;
        var avgDailyKm=days>0?km/days:0;
        var daysEst=avgDailyKm>0?Math.ceil(rem/avgDailyKm):null;
        var estStr=daysEst?" (~"+daysEst+" day"+(daysEst!==1?"s":"")+")":" ";
        if(item.batteryKm){
          lines.push(km+" / "+iKm+" km battery used"+estStr);
        } else {
          lines.push(km+" / "+iKm+" km used"+estStr);
        }
      } else {
        lines.push("Overdue by "+Math.abs(rem)+" km ‚Äî service needed");
      }
      if((it.history||[]).length>=3&&iKm!==item.intervalKm){
        lines.push("Personalized interval: "+iKm+" km");
      }
    }
  }
  if(item.intervalDays!=null){
    var days=getDaysSinceService(item.id);
    if(days!=null){
      var remDays=item.intervalDays-days;
      if(remDays>0) lines.push(days+" / "+item.intervalDays+" days (~"+remDays+" left)");
      else lines.push("Overdue by "+Math.abs(remDays)+" days");
    }
  }
  return lines.length?lines.join(" ¬∑ "):null;
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(){
  renderBikeTabs();
  renderBikeInfoCard();
  var totalKm=getActiveBikeTotalKm();
  document.getElementById("bikeTotalKm").textContent=totalKm>0?(totalKm.toLocaleString()+" km total"):"‚Äî";
  document.getElementById("lastSyncLabel").textContent=lastSyncTs?"Synced "+timeSince(lastSyncTs):"Never synced";
  renderDashboard();
}

function timeSince(isoStr){
  var mins=Math.round((Date.now()-new Date(isoStr).getTime())/60000);
  if(mins<2) return "just now";
  if(mins<60) return mins+"m ago";
  var hrs=Math.floor(mins/60);
  if(hrs<24) return hrs+"h ago";
  return Math.floor(hrs/24)+"d ago";
}

function renderBikeTabs(){
  var el=document.getElementById("bikeTabs");
  if(!bikes||bikes.length===0){ el.innerHTML=""; return; }
  // Always show tabs if 2+ bikes; show single label if only 1
  if(bikes.length===1){
    el.innerHTML='<div style="font-family:var(--ff-mono);font-size:11px;color:var(--text-dim);">'+esc(bikes[0].name)+'</div>';
    return;
  }
  el.innerHTML=bikes.map(function(b){
    var act=b.id===activeBikeId?" active":"";
    var km=b.totalKm>0?'<span class="bkm">'+b.totalKm.toLocaleString()+'km</span>':'';
    return '<button class="bike-tab'+act+'" onclick="switchBike(\''+b.id.replace(/'/g,"\\'")+'\')">'+(b.name||"Bike")+km+'</button>';
  }).join("");
}

function renderBikeInfoCard(){
  var el=document.getElementById("bikeInfoCard");
  var b=getActiveBike();
  if(!b){ el.innerHTML=""; return; }
  var frameIcon = b.frameType===1?"üö¥":b.frameType===2?"üèÉ":b.frameType===5?"üèîÔ∏è":"üöµ";
  var brandStr = [b.brand, b.model].filter(Boolean).join(" ");
  el.innerHTML='<div class="bike-info-card">'+
    '<div class="bike-icon">'+frameIcon+'</div>'+
    '<div class="bike-details">'+
      '<div class="bike-details-name">'+esc(b.name||"My Bike")+'</div>'+
      (brandStr?'<div class="bike-details-brand">'+esc(brandStr)+'</div>':'')+
      '<div class="bike-details-stats">'+
        '<div class="bike-stat"><div class="bike-stat-val">'+b.totalKm.toLocaleString()+'</div><div class="bike-stat-label">Total km</div></div>'+
        
        (b.totalElevation?'<div class="bike-stat"><div class="bike-stat-val">'+Math.round(b.totalElevation/1000)+'k</div><div class="bike-stat-label">Elev. m</div></div>':'')+
      '</div>'+
    '</div>'+
  '</div>';
}

function renderDashboard(){
  var el=document.getElementById("dashboard");
  var html="";
  CATEGORIES.forEach(function(cat){
    var items=ITEMS.filter(function(it){ return it.category===cat; });
    html+='<div class="category"><div class="cat-label">'+esc(cat)+'</div>';
    items.forEach(function(item){ html+=renderItemCard(item); });
    html+='</div>';
  });
  el.innerHTML=html;
}

function renderItemCard(item){
  var it=getItemData(item.id);
  var status=getStatus(item);
  var iKm=getEffectiveIntervalKm(item);
  var insight=buildInsight(item);
  var km=getKmSinceService(item.id);
  var days=getDaysSinceService(item.id);
  var hasService=!!it.lastDate;

  var cardClass="item-card"+(status==="warn"?" status-warn":status==="danger"?" status-danger":"");
  var badgeClass="item-status status-none-badge"; var badgeText="Not Set";
  if(status==="good"){   badgeClass="item-status status-good-badge";   badgeText="Good"; }
  if(status==="warn"){   badgeClass="item-status status-warn-badge";   badgeText="Due Soon"; }
  if(status==="danger"){ badgeClass="item-status status-danger-badge"; badgeText="Overdue!"; }

  var metaParts=[];
  if(it.lastDate) metaParts.push("Last: "+fmtDateShort(it.lastDate));
  if(km!=null){
    metaParts.push(km.toLocaleString()+" km"+(item.batteryKm?" on battery":"" ));
  } else if(days!=null&&!iKm){
    metaParts.push(days+" days ago");
  }
  if(item.batteryKm&&iKm) metaParts.push("~"+iKm.toLocaleString()+" km per CR2032");
  var meta=metaParts.length?metaParts.join(" ¬∑ "):"Tap 'New Service' to start tracking";

  var barHtml="";
  var pct=null;
  if(it.lastDate&&iKm!=null&&km!=null) pct=Math.min(100,Math.round((km/iKm)*100));
  else if(it.lastDate&&item.intervalDays!=null&&days!=null) pct=Math.min(100,Math.round((days/item.intervalDays)*100));
  if(pct!==null){
    var barClass=pct>=100?"bar-danger":pct>=80?"bar-warn":"bar-good";
    var leftLabel=iKm!=null?(km+" km"):(days+" days");
    var rightLabel=iKm!=null?(iKm+" km"):( item.intervalDays+" days");
    barHtml='<div class="item-bar-wrap"><div class="item-bar-bg"><div class="item-bar-fill '+barClass+'" style="width:'+pct+'%"></div></div><div class="item-bar-labels"><span>'+leftLabel+'</span><span>'+rightLabel+'</span></div></div>';
  }

  var insightHtml="";
  if(insight){
    var iClass=status==="danger"?"insight-danger":status==="warn"?"insight-warn":"insight-good";
    insightHtml='<div class="item-insight"><span class="'+iClass+'">'+esc(insight)+'</span></div>';
  }

  var histCount=(it.history||[]).length;
  var histLabel="History"+(histCount>0?" ("+histCount+")":"");

  // Edit service button only if there's an existing service
  var editBtn=hasService?'<button class="btn-edit-service" onclick="openLogModal(\''+item.id+'\',\'edit\')">‚úé Edit</button>':'';

  return '<div class="'+cardClass+'">'+
    '<div class="item-top">'+
      '<div class="item-emoji">'+item.emoji+'</div>'+
      '<div class="item-info"><div class="item-name">'+esc(item.name)+'</div><div class="item-meta">'+esc(meta)+'</div></div>'+
      '<div class="'+badgeClass+'">'+badgeText+'</div>'+
    '</div>'+
    barHtml+insightHtml+
    '<div class="item-actions">'+
      '<button class="btn-new-service" onclick="openLogModal(\''+item.id+'\',\'new\')">Ôºã New Service</button>'+
      editBtn+
      '<button class="btn-history" onclick="openHistoryModal(\''+item.id+'\')">'+esc(histLabel)+'</button>'+
    '</div>'+
  '</div>';
}

// ‚îÄ‚îÄ Log / Edit Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openLogModal(itemId, mode){
  _logItemId=itemId;
  _logMode=mode||"new";
  var item=ITEMS.find(function(x){ return x.id===itemId; });
  var it=getItemData(itemId);
  var km=getKmSinceService(itemId);

  document.getElementById("logModalTitle").textContent=item.name;
  document.getElementById("logNote").value="";
  document.getElementById("btnConfirmLog").disabled=false;
  document.getElementById("modeTabNew").classList.toggle("active",_logMode==="new");
  document.getElementById("modeTabEdit").classList.toggle("active",_logMode==="edit");
  // Hide edit tab if no existing service
  document.getElementById("modeTabEdit").style.display=it.lastDate?"":"none";

  if(_logMode==="edit"&&it.lastDate){
    document.getElementById("logDate").value=it.lastDate;
    document.getElementById("logNote").value=(it.history&&it.history[0]?it.history[0].note||"":"");
    document.getElementById("btnConfirmLog").textContent="‚úì Save Edit";
  } else {
    document.getElementById("logDate").value=todayStr();
    document.getElementById("btnConfirmLog").textContent="‚úì Record Service";
  }

  buildLogSummary(itemId);
  document.getElementById("logModal").classList.remove("hidden");
}

function switchLogMode(mode){
  _logMode=mode;
  var item=ITEMS.find(function(x){ return x.id===_logItemId; });
  var it=getItemData(_logItemId);
  document.getElementById("modeTabNew").classList.toggle("active",mode==="new");
  document.getElementById("modeTabEdit").classList.toggle("active",mode==="edit");
  if(mode==="edit"&&it.lastDate){
    document.getElementById("logDate").value=it.lastDate;
    document.getElementById("logNote").value=(it.history&&it.history[0]?it.history[0].note||"":"");
    document.getElementById("btnConfirmLog").textContent="‚úì Save Edit";
  } else {
    document.getElementById("logDate").value=todayStr();
    document.getElementById("btnConfirmLog").textContent="‚úì Record Service";
  }
  buildLogSummary(_logItemId);
}

function buildLogSummary(itemId){
  var it=getItemData(itemId);
  var km=getKmSinceService(itemId);
  var rows="";
  if(it.lastDate) rows+='<div class="row"><span class="lbl">Last service</span><span class="val">'+fmtDate(it.lastDate)+'</span></div>';
  if(km!=null) rows+='<div class="row"><span class="lbl">Km since last</span><span class="val accent">'+km.toLocaleString()+" km"+'</span></div>';
  else rows+='<div class="row"><span class="lbl">Status</span><span class="val" style="color:var(--text-muted)">First record ‚Äî km fetched from Strava</span></div>';
  rows+='<div class="row"><span class="lbl">Bike total km</span><span class="val">'+getActiveBikeTotalKm().toLocaleString()+" km"+'</span></div>';
  document.getElementById("logSummary").innerHTML=rows;
}

async function confirmLogService(){
  var itemId=_logItemId;
  var item=ITEMS.find(function(x){ return x.id===itemId; });
  var it=getItemData(itemId);
  var serviceDate=document.getElementById("logDate").value;
  var note=document.getElementById("logNote").value.trim();
  if(!serviceDate){ toast("Please select a date","err"); return; }

  var btn=document.getElementById("btnConfirmLog");
  btn.disabled=true;
  var totalKm=getActiveBikeTotalKm();

  if(_logMode==="edit"){
    // ‚îÄ‚îÄ Edit existing service: update date & note, re-fetch km if date changed ‚îÄ‚îÄ
    btn.textContent="Saving...";
    var oldDate=it.lastDate;
    var dateChanged=(oldDate!==serviceDate);
    var kmRidden=0;
    if(dateChanged){
      btn.textContent="Fetching km from Strava...";
      var fetched=await fetchKmSinceDate(serviceDate);
      if(fetched!=null&&fetched>0){
        kmRidden=fetched;
        it.lastKmTotal=totalKm-fetched;
      } else {
        it.lastKmTotal=totalKm;
      }
    } else {
      kmRidden=getKmSinceService(itemId)||0;
    }
    it.lastDate=serviceDate;
    // Update the most recent history entry
    if(!it.history) it.history=[];
    if(it.history.length>0){
      it.history[0].date=serviceDate;
      it.history[0].kmRidden=kmRidden;
      it.history[0].note=note;
      it.history[0].kmAtService=totalKm;
    } else {
      it.history=[{date:serviceDate,kmAtService:totalKm,kmRidden:kmRidden,note:note}];
    }
    btn.disabled=false; btn.textContent="‚úì Save Edit";
    closeModalId("logModal");
    saveAll();
    toast(item.name+" service updated!","ok");
    render();

  } else {
    // ‚îÄ‚îÄ New service ‚îÄ‚îÄ
    var kmRidden=null;
    if(it.lastDate&&it.lastKmTotal!=null){
      kmRidden=Math.max(0,totalKm-it.lastKmTotal);
      btn.textContent="Recording...";
    } else {
      btn.textContent="Fetching km from Strava...";
      var fetchedKm=await fetchKmSinceDate(serviceDate);
      if(fetchedKm!=null&&fetchedKm>0){
        kmRidden=fetchedKm;
        it.lastKmTotal=totalKm-fetchedKm;
      } else {
        kmRidden=0;
        it.lastKmTotal=totalKm;
        toast(fetchedKm===0?"No rides found since "+fmtDateShort(serviceDate):"Strava fetch failed ‚Äî km set to 0","info");
      }
    }
    // Push old service to history, then update current
    if(!it.history) it.history=[];
    it.history.unshift({
      date:serviceDate,
      kmAtService:totalKm,
      kmRidden:kmRidden,
      note:note
    });
    it.lastDate=serviceDate;
    if(it.lastKmTotal==null) it.lastKmTotal=totalKm;

    btn.disabled=false; btn.textContent="‚úì Record Service";
    closeModalId("logModal");
    saveAll();
    toast(item.name+" recorded! ("+kmRidden+" km)","ok");
    render();
  }
}

// ‚îÄ‚îÄ History Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openHistoryModal(itemId){
  var item=ITEMS.find(function(x){ return x.id===itemId; });
  var it=getItemData(itemId);
  var history=it.history||[];
  document.getElementById("historyModalTitle").textContent=item.name+" History";

  var aiBox=document.getElementById("historyAI");
  if(history.length>=2){
    var kmVals=history.map(function(h){ return h.kmRidden; }).filter(function(v){ return v!=null&&v>0; });
    if(kmVals.length>=2){
      var avg=Math.round(kmVals.reduce(function(s,v){ return s+v; },0)/kmVals.length);
      var min=Math.min.apply(null,kmVals); var max=Math.max.apply(null,kmVals);
      var txt="Based on "+kmVals.length+" services, you typically service this every <strong style='color:var(--accent)'>"+avg+" km</strong> (range: "+min+"‚Äì"+max+" km).";
      if(item.intervalKm){ txt+=avg<item.intervalKm?" Pattern suggests you could stretch to "+item.intervalKm+" km.":" You're using the full interval well."; }
      txt+=" Intervals personalise after 3+ services.";
      aiBox.innerHTML="<strong>ü§ñ Pattern Analysis</strong>"+txt;
      aiBox.classList.remove("hidden");
    } else { aiBox.classList.add("hidden"); }
  } else { aiBox.classList.add("hidden"); }

  renderHistoryList(itemId);
  document.getElementById("historyModal").classList.remove("hidden");
}

function renderHistoryList(itemId){
  var it=getItemData(itemId);
  var history=it.history||[];
  var listEl=document.getElementById("historyList");
  if(history.length===0){
    listEl.innerHTML='<div class="history-empty">No service history yet.<br>Log a service to start building history.</div>';
    return;
  }
  listEl.innerHTML=history.map(function(h,idx){
    var kmStr=h.kmRidden!=null?h.kmRidden.toLocaleString()+" km since prev service":"First record";
    var tag=idx===0?'<span class="history-tag">Latest</span>':'';
    return '<div class="history-item">'+
      '<div class="history-item-left">'+
        '<div class="history-date">'+fmtDate(h.date)+tag+'</div>'+
        '<div class="history-km">'+kmStr+'</div>'+
        (h.note?'<div class="history-note">'+esc(h.note)+'</div>':'')+
      '</div>'+
      '<button class="history-del" onclick="deleteHistoryEntry(\''+itemId+'\','+idx+')" title="Delete entry">√ó</button>'+
    '</div>';
  }).join("");
}

function deleteHistoryEntry(itemId,idx){
  var it=getItemData(itemId);
  if(!it.history||!it.history[idx]) return;
  var h=it.history[idx];
  if(!confirm("Delete service entry from "+fmtDate(h.date)+"?")) return;

  it.history.splice(idx,1);

  // If we deleted the latest (idx 0), update lastDate/lastKmTotal from new [0]
  if(idx===0){
    if(it.history.length>0){
      it.lastDate=it.history[0].date;
      it.lastKmTotal=it.history[0].kmAtService - (it.history[0].kmRidden||0);
    } else {
      it.lastDate=null;
      it.lastKmTotal=null;
    }
  }

  saveAll();
  toast("Entry deleted","info");
  renderHistoryList(itemId);
  // refresh AI box
  var aiBox=document.getElementById("historyAI");
  var history=it.history||[];
  if(history.length<2) aiBox.classList.add("hidden");
  render();
}

// ‚îÄ‚îÄ Strava km fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchKmSinceDate(dateStr){
  if(!strava) return null;
  try{
    var token=await getToken();
    if(!token) return null;
    var afterTs=Math.floor(new Date(dateStr+"T00:00:00").getTime()/1000);
    var totalMeters=0;
    var page=1;
    while(true){
      var r=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({action:"activities",access_token:token,after:afterTs,page:page})});
      var acts=await r.json();
      if(!Array.isArray(acts)||acts.length===0) break;
      acts.forEach(function(a){ if(a.gear_id===activeBikeId&&a.distance) totalMeters+=a.distance; });
      if(acts.length<30) break;
      page++;
    }
    return Math.round(totalMeters/1000);
  }catch(e){ console.error("fetchKmSinceDate failed:",e); return null; }
}

// ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closeModal(e,id){ if(e.target===document.getElementById(id)) closeModalId(id); }
function closeModalId(id){ document.getElementById(id).classList.add("hidden"); }
function switchBike(id){ activeBikeId=id; render(); window.scrollTo({top:0,behavior:"smooth"}); saveLocal(); }

// ‚îÄ‚îÄ Strava auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connectStrava(){
  localStorage.setItem("chainwax_client_id",    STRAVA_CLIENT_ID);
  localStorage.setItem("chainwax_client_secret", STRAVA_CLIENT_SECRET);
  localStorage.setItem("strava_return_to",       "/bike-maintenance.html");
  window.location.href="https://www.strava.com/oauth/authorize?client_id="+STRAVA_CLIENT_ID+
    "&response_type=code&redirect_uri="+encodeURIComponent(CALLBACK)+
    "&approval_prompt=auto&scope=activity:read_all";
}

function logout(){
  if(!confirm("Logout? Local session will be cleared.")) return;
  localStorage.removeItem("bikemaint_session");
  athlete=null; strava=null; binId=null;
  bikes=[]; activeBikeId=null; bikeData={}; lastSyncTs=null;
  document.getElementById("loginScreen").classList.remove("hidden");
  document.getElementById("mainApp").classList.add("hidden");
}

async function getToken(){
  if(!strava) return null;
  var now=Math.floor(Date.now()/1000);
  if(now<strava.expiresAt-60) return strava.accessToken;
  try{
    var resp=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"token",client_id:STRAVA_CLIENT_ID,client_secret:STRAVA_CLIENT_SECRET,
        refresh_token:strava.refreshToken,grant_type:"refresh_token"})});
    var d=await resp.json();
    if(d.access_token){
      strava.accessToken=d.access_token; strava.refreshToken=d.refresh_token; strava.expiresAt=d.expires_at;
      saveLocal(); return d.access_token;
    }
  }catch(e){ console.error("Token refresh failed:",e); }
  return null;
}

// ‚îÄ‚îÄ Debug helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _debugOpen=false;
function toggleDebug(){ _debugOpen=!_debugOpen; document.getElementById("debugPanel").classList.toggle("hidden",!_debugOpen); }
function clearDebug(){ document.getElementById("debugLog").innerHTML=""; }
function dbg(msg,cls){
  var el=document.getElementById("debugLog");
  if(!el) return;
  var line=document.createElement("div");
  if(cls) line.className=cls;
  line.textContent="["+new Date().toLocaleTimeString()+"] "+msg;
  el.appendChild(line);
  el.scrollTop=el.scrollHeight;
  console.log(msg);
}

// ‚îÄ‚îÄ Sync Strava ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncStrava(){
  if(!strava){ toast("Not connected to Strava","err"); return; }
  var btn=document.getElementById("btnSync");
  btn.disabled=true; btn.innerHTML='<span class="spin-inline">‚Üª</span> Syncing...';
  try{
    var token=await getToken();
    if(!token) throw new Error("Session expired ‚Äî please reconnect Strava.");
    dbg("Token OK","label");

    var gearIds=[];

    // ‚îÄ‚îÄ Strategy 1: Athlete endpoint ‚Äî returns bikes[] array ‚îÄ‚îÄ
    try{
      dbg("Fetching athlete profile...");
      var athleteResp=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({action:"athlete",access_token:token})});
      var athleteData=await athleteResp.json();
      dbg("Athlete response keys: "+Object.keys(athleteData||{}).join(", "));
      if(athleteData&&Array.isArray(athleteData.bikes)){
        dbg("athlete.bikes count: "+athleteData.bikes.length,"label");
        athleteData.bikes.forEach(function(b){
          dbg("  bike from profile: id="+b.id+" name="+b.name+" dist="+b.distance);
          if(b.id&&gearIds.indexOf(b.id)===-1) gearIds.push(b.id);
        });
        if(athleteData.id) athlete=athleteData;
      } else {
        dbg("No bikes[] array in athlete response ‚Äî server may be filtering it","warn");
        // Try raw Strava API directly with the token
        try{
          dbg("Trying direct Strava API /athlete...");
          var rawResp=await fetch("https://www.strava.com/api/v3/athlete",{
            headers:{"Authorization":"Bearer "+token}});
          var rawData=await rawResp.json();
          dbg("Direct Strava keys: "+Object.keys(rawData||{}).join(", "));
          if(rawData&&Array.isArray(rawData.bikes)){
            dbg("Direct Strava athlete.bikes count: "+rawData.bikes.length,"label");
            rawData.bikes.forEach(function(b){
              dbg("  bike: id="+b.id+" name="+b.name);
              if(b.id&&gearIds.indexOf(b.id)===-1) gearIds.push(b.id);
            });
            if(rawData.id) athlete=rawData;
          }
        }catch(directErr){ dbg("Direct Strava call failed: "+directErr.message,"err"); }
      }
    }catch(ae){ dbg("Athlete fetch error: "+ae.message,"err"); }

    // ‚îÄ‚îÄ Strategy 2: Scan activities for gear_id values ‚îÄ‚îÄ
    dbg("Scanning activities for gear IDs...");
    var pg=1;
    while(pg<=5){
      try{
        var r=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({action:"activities",access_token:token,after:0,page:pg})});
        var acts=await r.json();
        if(!Array.isArray(acts)||acts.length===0){ dbg("Activities page "+pg+": empty, stopping"); break; }
        var pageGearIds=[];
        acts.forEach(function(a){
          if(a.gear_id&&gearIds.indexOf(a.gear_id)===-1){
            gearIds.push(a.gear_id);
            pageGearIds.push(a.gear_id);
          }
        });
        dbg("Activities page "+pg+": "+acts.length+" acts, new gear IDs: ["+pageGearIds.join(",")+"]");
        if(acts.length<30) break;
        pg++;
      }catch(pe){ dbg("Activities page "+pg+" error: "+pe.message,"err"); break; }
    }

    dbg("Total unique gear IDs found: "+gearIds.length+" ‚Üí ["+gearIds.join(",")+"]","label");

    if(!gearIds.length){
      toast("No bikes found. Tap üîç to see debug output","err");
      dbg("FAILED: No gear IDs discovered from any source","err");
      btn.disabled=false; btn.innerHTML="‚Üª Sync Strava"; render(); return;
    }

    // ‚îÄ‚îÄ Strategy 3: Fetch full gear detail for each ID ‚îÄ‚îÄ
    var fetched=[];
    for(var i=0;i<gearIds.length;i++){
      var gid=gearIds[i];
      dbg("Fetching gear detail: "+gid);
      // Try via server proxy first
      var gd=null;
      try{
        var gr=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({action:"gear",gear_id:gid,access_token:token})});
        gd=await gr.json();
        dbg("  gear via proxy: id="+gd.id+" name="+(gd.nickname||gd.name)+" dist="+gd.distance);
      }catch(ge){ dbg("  proxy gear fetch failed: "+ge.message,"warn"); }

      // If proxy failed or returned nothing useful, try direct
      if(!gd||!gd.id){
        try{
          dbg("  trying direct Strava /gear/"+gid);
          var dgr=await fetch("https://www.strava.com/api/v3/gear/"+gid,{
            headers:{"Authorization":"Bearer "+token}});
          gd=await dgr.json();
          dbg("  direct gear: id="+gd.id+" name="+(gd.nickname||gd.name));
        }catch(dge){ dbg("  direct gear failed: "+dge.message,"err"); }
      }

      if(gd&&gd.id) fetched.push(gd);
      else dbg("  SKIPPED gear "+gid+" ‚Äî no valid response","err");
    }

    dbg("Gear details fetched: "+fetched.length+"/"+gearIds.length,"label");

    if(!fetched.length){
      toast("Could not load bike details. Tap üîç for debug","err");
      btn.disabled=false; btn.innerHTML="‚Üª Sync Strava"; render(); return;
    }

    bikes=fetched.map(function(b){
      var name=b.nickname||b.name||"Bike";
      dbg("  Mapped bike: "+name+" ("+b.id+") ‚Üí "+Math.round((b.distance||0)/1000)+"km");
      return{
        id:            b.id,
        name:          name,
        brand:         b.brand_name||"",
        model:         b.model_name||"",
        frameType:     b.frame_type||0,
        totalKm:       Math.round((b.distance||0)/1000),
        
        totalElevation:b.elevation_sum||null
      };
    });

    bikes.sort(function(a,b){ return b.totalKm-a.totalKm; });

    if(!activeBikeId||!bikes.find(function(b){ return b.id===activeBikeId; })){
      activeBikeId=bikes[0].id;
    }

    lastSyncTs=new Date().toISOString();
    await saveAll();
    dbg("Sync complete! "+bikes.length+" bike(s) loaded","label");
    toast("Synced "+bikes.length+" bike"+(bikes.length!==1?"s":"")+"!","ok");
  }catch(e){
    dbg("SYNC ERROR: "+e.message,"err");
    toast("Sync failed: "+e.message,"err");
  }
  btn.disabled=false; btn.innerHTML="‚Üª Sync Strava";
  render();
}

// ‚îÄ‚îÄ Persistence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveToCloud(){
  if(!athlete) return;
  var payload={athlete:athlete,strava:strava,bikes:bikes,activeBikeId:activeBikeId,bikeData:bikeData,lastSyncTs:lastSyncTs};
  try{
    var r=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"save",bin_id:binId,athlete_id:athlete.id,data:payload})});
    var d=await r.json();
    if(d.bin_id&&!binId){ binId=d.bin_id; localStorage.setItem("bikemaint_bin_"+athlete.id,binId); }
  }catch(e){ console.error("Cloud save failed:",e); }
}

async function loadFromCloud(aid,bid){
  try{
    var r=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"load",bin_id:bid,athlete_id:aid})});
    var d=await r.json();
    if(d.data){
      var s=d.data;
      if(s.athlete)      athlete=s.athlete;
      if(s.strava)       strava=s.strava;
      if(s.bikes)        bikes=s.bikes;
      if(s.activeBikeId) activeBikeId=s.activeBikeId;
      if(s.bikeData)     bikeData=s.bikeData;
      if(s.lastSyncTs)   lastSyncTs=s.lastSyncTs;
      return true;
    }
  }catch(e){ console.error("Cloud load failed:",e); }
  return false;
}

function saveLocal(){
  try{
    localStorage.setItem("bikemaint_session",JSON.stringify({
      athlete:athlete,strava:strava,binId:binId,bikes:bikes,
      activeBikeId:activeBikeId,bikeData:bikeData,lastSyncTs:lastSyncTs
    }));
  }catch(e){}
}

function loadLocal(){
  try{
    var s=localStorage.getItem("bikemaint_session");
    if(s){
      var d=JSON.parse(s);
      athlete=d.athlete||null; strava=d.strava||null; binId=d.binId||null;
      bikes=d.bikes||[]; activeBikeId=d.activeBikeId||null;
      bikeData=d.bikeData||{}; lastSyncTs=d.lastSyncTs||null;
      return !!athlete;
    }
  }catch(e){}
  return false;
}

async function saveAll(){ saveLocal(); await saveToCloud(); }

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function(){
  var loadEl=document.getElementById("loadingScreen");
  var loginEl=document.getElementById("loginScreen");
  var appEl=document.getElementById("mainApp");

  function showApp(){
    loginEl.classList.add("hidden"); appEl.classList.remove("hidden");
    document.getElementById("athleteName").textContent=athlete?(athlete.firstname||"")+" "+(athlete.lastname||""):"";
    render();
  }

  // Check for post-OAuth token
  var stravaRaw=localStorage.getItem("chainwax_strava");
  if(stravaRaw){
    try{
      var sd=JSON.parse(stravaRaw);
      var accessToken  = sd.accessToken||sd.access_token;
      var refreshToken = sd.refreshToken||sd.refresh_token;
      var expiresAt    = sd.expiresAt||sd.expires_at;
      var sdAthlete    = sd.athlete;
      if(accessToken){
        if(sdAthlete) athlete=sdAthlete;
        strava={accessToken:accessToken,refreshToken:refreshToken,expiresAt:expiresAt};
        localStorage.removeItem("chainwax_strava");
        if(!athlete){
          try{
            var ar=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
              body:JSON.stringify({action:"athlete",access_token:accessToken})});
            var ad=await ar.json();
            if(ad&&ad.id) athlete=ad;
          }catch(ae){ console.error("Athlete fetch failed:",ae); }
        }
        if(!athlete) athlete={id:"unknown",firstname:"Strava",lastname:"User"};
        var existingBin=localStorage.getItem("bikemaint_bin_"+(athlete.id||""))||
                        localStorage.getItem("chainwax_bin_"+(athlete.id||""));
        if(existingBin){ binId=existingBin; await loadFromCloud(athlete.id,binId); }
        saveLocal();
        loadEl.style.display="none";
        showApp();
        syncStrava().catch(function(e){ console.error("Background sync failed:",e); });
        return;
      }
    }catch(e){ console.error("OAuth parse error:",e); }
  }

  // Restore from localStorage
  if(loadLocal()&&athlete){
    if(binId) await loadFromCloud(athlete.id,binId);
    if(!activeBikeId&&bikes.length) activeBikeId=bikes[0].id;
    loadEl.style.display="none";
    showApp(); return;
  }

  // Not authenticated
  loadEl.style.display="none";
  loginEl.classList.remove("hidden");
})();
</script>
</body>
</html>
