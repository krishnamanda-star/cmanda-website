<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chain Wax Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0a0b;--bg2:#111113;--card:#16161a;--border:#252530;--border-light:#32323e;--accent:#f0a030;--accent-dim:#c88020;--accent-glow:rgba(240,160,48,0.12);--danger:#f04848;--danger-glow:rgba(240,72,72,0.12);--success:#30d870;--success-glow:rgba(48,216,112,0.12);--text:#eaeaef;--text-dim:#7a7a8a;--text-muted:#4a4a58;--strava:#fc4c02;--font-display:'Sora',sans-serif;--font-mono:'DM Mono',monospace}
    *{margin:0;padding:0;box-sizing:border-box}
    body{min-height:100vh;background:var(--bg);color:var(--text);font-family:var(--font-display);-webkit-font-smoothing:antialiased}
    body::before{content:'';position:fixed;inset:0;opacity:0.025;pointer-events:none;z-index:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
    .app{position:relative;z-index:1;max-width:640px;margin:0 auto;padding:0 20px 60px}
    .header{padding:28px 0 24px;display:flex;align-items:flex-end;justify-content:space-between;border-bottom:1px solid var(--border);margin-bottom:32px}
    .header-left{display:flex;align-items:center;gap:14px}
    .logo{width:44px;height:44px;background:linear-gradient(135deg,var(--accent),var(--accent-dim));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 4px 20px var(--accent-glow)}
    .header h1{font-size:20px;font-weight:700;letter-spacing:-0.5px;background:linear-gradient(135deg,var(--text),var(--text-dim));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .header .subtitle{font-family:var(--font-mono);font-size:11px;color:var(--text-muted);margin-top:2px}
    .badge{font-family:var(--font-mono);font-size:11px;padding:4px 10px;border-radius:20px;white-space:nowrap}
    .badge-on{background:var(--success-glow);color:var(--success);border:1px solid rgba(48,216,112,0.2)}
    .badge-off{background:rgba(122,122,138,0.1);color:var(--text-muted);border:1px solid var(--border)}
    .nav{display:flex;gap:4px;margin-bottom:28px;background:var(--bg2);border-radius:10px;padding:4px;border:1px solid var(--border)}
    .nav button{flex:1;padding:9px 10px;border:none;border-radius:8px;font-family:var(--font-mono);font-size:11px;font-weight:500;cursor:pointer;transition:all 0.25s;background:transparent;color:var(--text-muted)}
    .nav button.active{background:var(--card);color:var(--accent);box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    .nav button:hover:not(.active){color:var(--text-dim)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;margin-bottom:20px}
    .card-title{font-family:var(--font-mono);font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:20px}
    .gauge-wrap{display:flex;flex-direction:column;align-items:center;padding:12px 0 20px;position:relative}
    .gauge-svg{transform:rotate(-90deg)}
    .gauge-bg{fill:none;stroke:var(--border)}
    .gauge-fg{fill:none;stroke-linecap:round;transition:stroke-dashoffset 1.2s cubic-bezier(0.4,0,0.2,1),stroke 0.5s ease}
    .gauge-center{position:absolute;text-align:center;top:50%;left:50%;transform:translate(-50%,-50%);font-family:var(--font-mono)}
    .gauge-val{font-size:36px;font-weight:500;line-height:1}
    .gauge-lbl{font-size:11px;color:var(--text-muted);margin-top:6px;letter-spacing:1px;text-transform:uppercase}
    .stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--border);border-radius:10px;overflow:hidden;margin-top:24px}
    .stat{background:var(--card);padding:16px;text-align:center}
    .stat-l{font-family:var(--font-mono);font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
    .stat-v{font-family:var(--font-mono);font-size:15px;font-weight:500}
    .alert{margin-top:20px;padding:14px 20px;border-radius:10px;font-family:var(--font-mono);font-size:13px;font-weight:500;text-align:center}
    .alert-danger{background:var(--danger-glow);border:1px solid rgba(240,72,72,0.25);color:var(--danger);animation:pulse 2s infinite}
    .alert-success{background:var(--success-glow);border:1px solid rgba(48,216,112,0.2);color:var(--success)}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.8}}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px}
    .btn{padding:10px 20px;border-radius:8px;border:none;font-family:var(--font-mono);font-size:12px;font-weight:500;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
    .btn:disabled{opacity:0.4;cursor:not-allowed}
    .btn-strava{background:var(--strava);color:#fff}
    .btn-strava:hover:not(:disabled){background:#e04400}
    .btn-accent{background:var(--accent);color:var(--bg)}
    .btn-secondary{background:var(--bg2);color:var(--text-dim);border:1px solid var(--border)}
    .btn-danger{background:transparent;color:var(--danger);border:1px solid rgba(240,72,72,0.3)}
    .btn-danger:hover:not(:disabled){background:var(--danger-glow)}
    .rlog{border-radius:12px;overflow:hidden;border:1px solid var(--border);background:var(--card)}
    .rlog-hdr{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .rlog-hdr span{font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:1px}
    .rlog-hdr .cnt{color:var(--text-muted)}
    .rrow{display:grid;grid-template-columns:1fr 80px 70px 32px;align-items:center;padding:11px 16px;gap:8px;font-family:var(--font-mono);font-size:12px;border-bottom:1px solid rgba(37,37,48,0.5)}
    .rrow:hover{background:var(--bg2)}
    .rrow:last-child{border-bottom:none}
    .rname{color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .rdate{color:var(--text-muted);font-size:10px;margin-top:2px}
    .rdist{color:var(--accent);text-align:right;font-weight:500}
    .rsrc{color:var(--text-muted);text-align:right;font-size:10px}
    .rdel{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;padding:2px 4px;border-radius:4px;text-align:center}
    .rdel:hover{color:var(--danger);background:var(--danger-glow)}
    .rempty{padding:40px 20px;text-align:center;color:var(--text-muted);font-family:var(--font-mono);font-size:12px}
    .rlist{max-height:400px;overflow-y:auto}
    .fg{margin-bottom:18px}
    .fl{display:block;font-family:var(--font-mono);font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:8px}
    .fi{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none}
    .fi:focus{border-color:var(--accent)}
    .frow{display:flex;gap:12px}
    .frow>.fg{flex:1}
    .fsuf{display:flex;align-items:center;gap:8px}
    .fsuf .fi{flex:1}
    .fsuf span{color:var(--text-muted);font-family:var(--font-mono);font-size:12px}
    .fhint{margin-top:20px;padding:14px 18px;border-radius:10px;background:var(--accent-glow);border:1px solid rgba(240,160,48,0.15);font-size:12px;color:var(--text-dim);line-height:1.6}
    .fhint strong{color:var(--accent)}
    .hero{text-align:center;padding:40px 20px}
    .hero .icon{font-size:48px;margin-bottom:16px}
    .hero h2{font-size:18px;font-weight:600;margin-bottom:8px}
    .hero p{color:var(--text-dim);font-size:13px;margin-bottom:24px;line-height:1.6}
    .estimate{margin-top:16px;font-family:var(--font-mono);font-size:12px;color:var(--text-muted);text-align:center}
    .toast{position:fixed;top:20px;right:20px;z-index:1000;padding:12px 20px;border-radius:8px;font-family:var(--font-mono);font-size:12px;box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:slideIn 0.3s ease}
    .toast-ok{background:var(--success);color:#fff}
    .toast-err{background:var(--danger);color:#fff}
    .toast-info{background:var(--accent);color:var(--bg)}
    @keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
    .hidden{display:none !important}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .view{animation:fadeIn 0.35s ease}
    .loading-overlay{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:999;font-family:var(--font-mono);color:var(--accent);font-size:14px}
    .spinner{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-right:12px}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:480px){.header{flex-direction:column;align-items:flex-start;gap:12px}.stats{grid-template-columns:1fr}.btn-row{flex-direction:column}.btn{width:100%;justify-content:center}.frow{flex-direction:column;gap:0}}
    ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  </style>
</head>
<body>

<div class="loading-overlay" id="loadingScreen"><div class="spinner"></div> Loading...</div>

<div class="app" style="display:none" id="appWrap">

  <!-- LOGIN SCREEN -->
  <div id="loginScreen">
    <div class="header">
      <div class="header-left">
        <div class="logo">â›“</div>
        <div><h1>Chain Wax Tracker</h1><div class="subtitle">Track your chain wax life</div></div>
      </div>
    </div>
    <div class="card">
      <div class="hero">
        <div class="icon">ğŸš´</div>
        <h2>Welcome</h2>
        <p>Connect your Strava account to track your chain wax life. Your data is saved to the cloud â€” come back anytime.</p>
        <button class="btn btn-strava" onclick="connectStrava()">Connect with Strava</button>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="mainApp" class="hidden">
    <div class="header">
      <div class="header-left">
        <div class="logo">â›“</div>
        <div>
          <h1>Chain Wax Tracker</h1>
          <div class="subtitle" id="welcomeMsg">Loading...</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="badge badge-on">â— Strava</div>
        <button class="btn-danger btn" style="padding:4px 10px;font-size:10px" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="nav">
      <button class="active" onclick="go('dashboard')">Dashboard</button>
      <button onclick="go('rides')">Rides</button>
      <button onclick="go('settings')">Settings</button>
    </div>

    <!-- DASHBOARD -->
    <div id="v-dashboard" class="view">
      <div id="emptyState" class="card hidden">
        <div class="hero">
          <div class="icon">ğŸ”§</div>
          <h2>Set Up Your Chain Wax Cycle</h2>
          <p>Go to Settings to set your wax date and target distance.</p>
          <button class="btn btn-accent" onclick="go('settings')">Go to Settings</button>
        </div>
      </div>
      <div id="mainDash" class="hidden">
        <div class="card">
          <div class="gauge-wrap">
            <svg class="gauge-svg" width="200" height="200">
              <circle class="gauge-bg" cx="100" cy="100" r="88" stroke-width="9"/>
              <circle class="gauge-fg" id="gFg" cx="100" cy="100" r="88" stroke-width="9" stroke-dasharray="553" stroke-dashoffset="553"/>
            </svg>
            <div class="gauge-center"><div class="gauge-val" id="gVal">â€”</div><div class="gauge-lbl">km remaining</div></div>
          </div>
          <div id="alertWax" class="alert alert-danger hidden">âš  TIME TO RE-WAX YOUR CHAIN</div>
          <div class="stats">
            <div class="stat"><div class="stat-l">Waxed</div><div class="stat-v" id="sWax">â€”</div></div>
            <div class="stat"><div class="stat-l">Ridden</div><div class="stat-v" id="sRid">â€”</div></div>
            <div class="stat"><div class="stat-l">Target</div><div class="stat-v" id="sTgt">â€”</div></div>
          </div>
          <div class="estimate hidden" id="estPill"></div>
        </div>
        <div class="btn-row">
          <button class="btn btn-strava" id="bSync" onclick="syncStrava()">â†» Sync Strava</button>
          <button class="btn btn-secondary" onclick="go('rides')">+ Add Ride</button>
          <button class="btn btn-danger" onclick="reWax()">ğŸ”— Re-Wax Chain</button>
        </div>
      </div>
    </div>

    <!-- RIDES -->
    <div id="v-rides" class="view hidden">
      <div class="card">
        <div class="card-title">Add Manual Ride</div>
        <div class="fg"><label class="fl">Ride Name</label><input class="fi" type="text" id="rName" placeholder="Morning ride"></div>
        <div class="frow">
          <div class="fg"><label class="fl">Distance</label><div class="fsuf"><input class="fi" type="number" id="rDist" placeholder="0" min="0" step="0.1"><span>km</span></div></div>
          <div class="fg"><label class="fl">Date</label><input class="fi" type="date" id="rDateIn"></div>
        </div>
        <button class="btn btn-accent" onclick="addRide()">Save Ride</button>
      </div>
      <div class="rlog">
        <div class="rlog-hdr"><span>Ride Log</span><span class="cnt" id="rCnt">0 rides</span></div>
        <div class="rlist" id="rList"><div class="rempty">No rides yet</div></div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="v-settings" class="view hidden">
      <div class="card">
        <div class="card-title">Wax Settings</div>
        <div class="fg"><label class="fl">Last Wax Date</label><input class="fi" type="date" id="cfgDate" onchange="saveCfg()"></div>
        <div class="fg"><label class="fl">Target Distance Per Wax</label><div class="fsuf"><input class="fi" type="number" id="cfgKm" min="50" step="50" onchange="saveCfg()"><span>km</span></div></div>
        <div class="fhint"><strong>Tip:</strong> Most chain wax treatments last 200â€“500 km. Dry = longer. Wet/muddy = re-wax sooner.</div>
      </div>
      <div class="card">
        <div class="card-title">Wax History</div>
        <div id="waxHistory" style="font-family:var(--font-mono);font-size:12px;color:var(--text-dim)">No previous wax cycles.</div>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  *** ENTER YOUR STRAVA CREDENTIALS HERE ***
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var STRAVA_CLIENT_ID     = "PASTE_YOUR_CLIENT_ID_HERE";
var STRAVA_CLIENT_SECRET = "PASTE_YOUR_CLIENT_SECRET_HERE";
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var BASE = window.location.origin;
var CALLBACK = BASE + "/strava-callback.html";

// App state
var athlete = null;
var cfg = { waxDate: "", targetKm: 300 };
var rides = [];
var strava = null;
var waxHistory = [];
var binId = null;  // JSONBin bin ID for this user

// Helpers
var fmt = function(n){ return Math.round(n*10)/10; };
var dateStr = function(d){ return new Date(d).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}); };
var shortDate = function(d){ return new Date(d).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit"}); };
var esc = function(s){ var d=document.createElement("div"); d.textContent=s; return d.innerHTML; };

function toast(msg,type){
  var el=document.createElement("div"); el.className="toast toast-"+(type||"info"); el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(function(){el.style.opacity="0";el.style.transition="opacity 0.3s";setTimeout(function(){el.remove();},300);},3000);
}

// â•â•â• SAVE / LOAD (JSONBin via API proxy) â•â•â•

async function saveToCloud(){
  var payload = { athlete:athlete, config:cfg, rides:rides, strava:strava, waxHistory:waxHistory };
  try {
    var r = await fetch("/api/strava",{
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ action:"save", bin_id:binId, athlete_id:athlete.id, data:payload })
    });
    var d = await r.json();
    if(d.bin_id && !binId){
      binId = d.bin_id;
      localStorage.setItem("chainwax_bin_"+athlete.id, binId);
    }
  } catch(e){ console.error("Save failed:",e); }
}

async function loadFromCloud(aid, bid){
  try {
    var r = await fetch("/api/strava",{
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ action:"load", bin_id:bid })
    });
    var d = await r.json();
    if(d.data){
      if(d.data.athlete) athlete = d.data.athlete;
      if(d.data.config) cfg = d.data.config;
      if(d.data.rides) rides = d.data.rides;
      if(d.data.strava) strava = d.data.strava;
      if(d.data.waxHistory) waxHistory = d.data.waxHistory;
      return true;
    }
  } catch(e){ console.error("Load failed:",e); }
  return false;
}

// Also keep localStorage as quick cache
function saveLocal(){
  try{ localStorage.setItem("chainwax_session", JSON.stringify({athlete:athlete,strava:strava,cfg:cfg,rides:rides,waxHistory:waxHistory,binId:binId})); }catch(e){}
}
function loadLocal(){
  try{
    var s=localStorage.getItem("chainwax_session");
    if(s){ var d=JSON.parse(s); athlete=d.athlete; strava=d.strava; cfg=d.cfg||cfg; rides=d.rides||[]; waxHistory=d.waxHistory||[]; binId=d.binId||null; return !!athlete; }
  }catch(e){}
  return false;
}

async function saveAll(){
  saveLocal();
  await saveToCloud();
}

// â•â•â• AUTH â•â•â•

function connectStrava(){
  localStorage.setItem("chainwax_client_id", STRAVA_CLIENT_ID);
  localStorage.setItem("chainwax_client_secret", STRAVA_CLIENT_SECRET);
  window.location.href = "https://www.strava.com/oauth/authorize?client_id="+STRAVA_CLIENT_ID+
    "&response_type=code&redirect_uri="+encodeURIComponent(CALLBACK)+
    "&approval_prompt=auto&scope=activity:read_all";
}

function logout(){
  localStorage.removeItem("chainwax_session");
  athlete=null; strava=null; cfg={waxDate:"",targetKm:300}; rides=[]; waxHistory=[]; binId=null;
  showLogin();
}

function showLogin(){
  document.getElementById("loginScreen").classList.remove("hidden");
  document.getElementById("mainApp").classList.add("hidden");
}
function showApp(){
  document.getElementById("loginScreen").classList.add("hidden");
  document.getElementById("mainApp").classList.remove("hidden");
  document.getElementById("welcomeMsg").textContent = athlete ? athlete.firstname+" "+(athlete.lastname||"") : "Welcome";
  render();
}

// â•â•â• NAV â•â•â•

function go(name){
  ["dashboard","rides","settings"].forEach(function(v){ document.getElementById("v-"+v).classList.toggle("hidden",v!==name); });
  document.querySelectorAll(".nav button").forEach(function(btn,i){ btn.classList.toggle("active",["dashboard","rides","settings"][i]===name); });
  if(name==="rides") document.getElementById("rDateIn").value=new Date().toISOString().split("T")[0];
}

// â•â•â• STRAVA â•â•â•

async function getToken(){
  if(!strava) return null;
  var now=Math.floor(Date.now()/1000);
  if(now<strava.expiresAt-60) return strava.accessToken;
  try{
    var resp=await fetch("/api/strava",{ method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"token",client_id:STRAVA_CLIENT_ID,client_secret:STRAVA_CLIENT_SECRET,refresh_token:strava.refreshToken,grant_type:"refresh_token"})});
    var d=await resp.json();
    if(d.access_token){ strava.accessToken=d.access_token; strava.refreshToken=d.refresh_token; strava.expiresAt=d.expires_at; await saveAll(); return d.access_token; }
  }catch(e){console.error(e);}
  return null;
}

async function syncStrava(){
  if(!strava){toast("Not connected","err");return;}
  if(!cfg.waxDate){toast("Set a wax date first","err");return;}
  var btn=document.getElementById("bSync"); btn.disabled=true; btn.textContent="â³ Syncing...";
  try{
    var token=await getToken(); if(!token) throw new Error("Token expired. Reconnect.");
    var after=Math.floor(new Date(cfg.waxDate).getTime()/1000);
    var pg=1, all=[];
    while(true){
      var r=await fetch("/api/strava",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({action:"activities",access_token:token,after:after,page:pg})});
      var acts=await r.json();
      if(!Array.isArray(acts)||acts.length===0) break;
      all=all.concat(acts); pg++;
    }
    var bikeRides=all.filter(function(a){return a.type==="Ride"||a.type==="VirtualRide"||a.type==="EBikeRide";})
      .map(function(a){return{id:"strava_"+a.id,name:a.name,distance:a.distance/1000,date:a.start_date_local||a.start_date,source:"strava"};});
    var manual=rides.filter(function(r){return r.source!=="strava";});
    rides=manual.concat(bikeRides).sort(function(a,b){return new Date(a.date)-new Date(b.date);});
    await saveAll();
    toast("Synced "+bikeRides.length+" ride"+(bikeRides.length!==1?"s":""),"ok");
  }catch(e){toast("Sync failed: "+e.message,"err");}
  btn.disabled=false; btn.textContent="â†» Sync Strava"; render();
}

// â•â•â• RIDES â•â•â•

async function addRide(){
  var name=document.getElementById("rName").value.trim();
  var dist=parseFloat(document.getElementById("rDist").value);
  var date=document.getElementById("rDateIn").value;
  if(!name||!dist||!date){toast("Fill all fields","err");return;}
  rides.push({id:"m_"+Date.now(),name:name,distance:dist,date:date,source:"manual"});
  rides.sort(function(a,b){return new Date(a.date)-new Date(b.date);});
  await saveAll();
  document.getElementById("rName").value=""; document.getElementById("rDist").value="";
  toast("Ride added","ok"); render();
}

async function delRide(id){
  rides=rides.filter(function(r){return r.id!==id;});
  await saveAll(); render();
}

async function reWax(){
  if(!confirm("Start a fresh wax cycle? Current rides will be archived.")) return;
  var totalKm=rides.reduce(function(s,r){return s+r.distance;},0);
  if(cfg.waxDate){
    waxHistory.push({waxDate:cfg.waxDate,targetKm:cfg.targetKm,totalKm:fmt(totalKm),rideCount:rides.length,endDate:new Date().toISOString().split("T")[0]});
  }
  cfg.waxDate=new Date().toISOString().split("T")[0]; rides=[];
  await saveAll(); toast("Chain waxed! Fresh cycle started.","ok"); render();
}

async function saveCfg(){
  cfg.waxDate=document.getElementById("cfgDate").value;
  cfg.targetKm=parseInt(document.getElementById("cfgKm").value)||300;
  await saveAll(); render();
}

// â•â•â• RENDER â•â•â•

function render(){
  var hasWax=!!cfg.waxDate;
  document.getElementById("emptyState").classList.toggle("hidden",hasWax);
  document.getElementById("mainDash").classList.toggle("hidden",!hasWax);
  document.getElementById("cfgDate").value=cfg.waxDate;
  document.getElementById("cfgKm").value=cfg.targetKm;

  var totalKm=rides.reduce(function(s,r){return s+r.distance;},0);
  var remaining=Math.max(0,cfg.targetKm-totalKm);
  var pct=cfg.targetKm>0?Math.min((totalKm/cfg.targetKm)*100,100):0;
  var overdue=totalKm>=cfg.targetKm;
  var circ=2*Math.PI*88, off=circ-(pct/100)*circ;
  var gFg=document.getElementById("gFg");
  var col=pct>85?"var(--danger)":pct>60?"var(--accent)":"var(--success)";
  gFg.style.strokeDashoffset=off; gFg.style.stroke=col; gFg.style.filter="drop-shadow(0 0 8px "+col+")";
  var gVal=document.getElementById("gVal"); gVal.textContent=fmt(remaining);
  gVal.style.color=overdue?"var(--danger)":"var(--text)";
  document.getElementById("sWax").textContent=hasWax?dateStr(cfg.waxDate):"â€”";
  document.getElementById("sRid").textContent=fmt(totalKm)+" km";
  document.getElementById("sTgt").textContent=cfg.targetKm+" km";
  document.getElementById("alertWax").classList.toggle("hidden",!overdue);

  var est=document.getElementById("estPill");
  if(hasWax&&rides.length>0&&remaining>0){
    var days=Math.max(1,(Date.now()-new Date(cfg.waxDate).getTime())/86400000);
    var avg=totalKm/days;
    if(avg>0){var left=Math.ceil(remaining/avg);est.textContent="â‰ˆ "+left+" day"+(left!==1?"s":"")+" until re-wax";est.classList.remove("hidden");}
    else est.classList.add("hidden");
  }else est.classList.add("hidden");

  document.getElementById("rCnt").textContent=rides.length+" ride"+(rides.length!==1?"s":"");
  var rl=document.getElementById("rList");
  if(rides.length===0){rl.innerHTML='<div class="rempty">No rides yet. Sync Strava or add manually.</div>';}
  else{
    rl.innerHTML=rides.slice().reverse().map(function(r){
      return '<div class="rrow"><div><div class="rname">'+esc(r.name)+'</div><div class="rdate">'+shortDate(r.date)+'</div></div>'+
        '<div class="rdist">'+fmt(r.distance)+' km</div><div class="rsrc">'+(r.source==="strava"?"Strava":"Manual")+'</div>'+
        '<button class="rdel" onclick="delRide(\''+r.id+'\')" title="Delete">Ã—</button></div>';
    }).join("");
  }

  var wh=document.getElementById("waxHistory");
  if(waxHistory.length===0){wh.textContent="No previous wax cycles.";}
  else{
    wh.innerHTML=waxHistory.slice().reverse().map(function(h){
      return '<div style="padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--accent)">'+dateStr(h.waxDate)+'</span> â†’ '+dateStr(h.endDate)+
        ' â€” '+h.totalKm+' km over '+h.rideCount+' ride'+(h.rideCount!==1?'s':'')+'</div>';
    }).join("");
  }
}

// â•â•â• INIT â•â•â•

(async function(){
  var loadEl=document.getElementById("loadingScreen");
  var appEl=document.getElementById("appWrap");

  // Check if returning from Strava OAuth
  var stravaRaw = localStorage.getItem("chainwax_strava");
  if(stravaRaw){
    try{
      var sd=JSON.parse(stravaRaw);
      if(sd.accessToken && sd.athlete){
        athlete=sd.athlete;
        strava={accessToken:sd.accessToken,refreshToken:sd.refreshToken,expiresAt:sd.expiresAt};
        localStorage.removeItem("chainwax_strava");

        // Check if this user already has a bin
        var existingBin = localStorage.getItem("chainwax_bin_"+athlete.id);
        if(existingBin){
          binId=existingBin;
          await loadFromCloud(athlete.id, binId);
          // Keep fresh tokens
          strava={accessToken:sd.accessToken,refreshToken:sd.refreshToken,expiresAt:sd.expiresAt};
        }
        await saveAll();
        loadEl.style.display="none"; appEl.style.display="block";
        showApp();
        return;
      }
    }catch(e){}
  }

  // Try loading from localStorage cache
  if(loadLocal() && athlete){
    // Try refreshing from cloud
    if(binId){
      await loadFromCloud(athlete.id, binId);
    }
    loadEl.style.display="none"; appEl.style.display="block";
    showApp();
    return;
  }

  // Not logged in
  loadEl.style.display="none"; appEl.style.display="block";
  showLogin();
})();
</script>
</body>
</html>
